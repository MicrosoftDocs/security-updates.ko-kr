---
TOCTitle: IPsec 문제 해결
Title: IPsec 문제 해결
ms:assetid: '95ce5111-fd06-42eb-bb39-a5bcd88b349b'
ms:contentKeyID: 20214046
ms:mtpsurl: 'https://technet.microsoft.com/ko-kr/library/Dd547891(v=TechNet.10)'
---

IPsec 및 그룹 정책을 통한 서버 및 도메인 격리
=============================================

### 7장: IPsec 문제 해결

업데이트 날짜: 2005년 2월 16일

이 장에서는 서버 및 도메인 격리 시나리오에서와 같이 IPSec(인터넷 프로토콜 보안) 문제 해결에 대한 정보를 제공하며, 이 정보는 Microsoft IT(정보 기술) 팀의 경험과 프로세스에 기반합니다. 가능한 경우 기존 Microsoft 문제 해결 절차와 관련 정보를 언급합니다.

Microsoft IT 지원은 다계층 지원 모델에 기반하며 지원 센터는 계층 1 지원이라고 합니다. 문제 제기 절차를 통해 지원 센터 직원은 전문가의 지원이 필요한 문제를 제기할 수 있습니다.

이 장의 절차는 세 가지 지원 수준(계층 1, 계층 2 및 계층 3)을 의미합니다. 이 가이드가 가능한 실용적이고 간결하도록 대부분의 내용은 계층 2 수준에 맞췄습니다. 초기 계층 1 가이드는 조직이 어떠한 문제가 IPsec과 관련되어 있는지 파악한 후 IPsec 문제인 경우 계층 2 지원 엔지니어가 문제를 해결하도록 필요한 정보를 작성할 수 있게 도와 줍니다.

계층 3의 문제 해결 노력을 지원하는 데 필요한 상당히 상세하고 복잡한 정보는 이 장의 범위를 넘어선 것입니다. 이 장에 제공된 정보가 IPsec 문제를 해결하지 못하는 경우 Microsoft® 기술 지원 서비스에 문의하여 추가 지원을 받는 것이 좋습니다.

Microsoft가 사용하는 대부분의 지원 절차, 도구 및 스크립트는 이 장에서 참조용으로 제공됩니다. 이러한 권장 사항과 도구는 귀사의 특정 요구에 부합하도록 채택되어야 합니다.

IPsec을 TCP(Transmission Control Protocol)와 UDP(User Datagram Protocol) 네트워크 트래픽의 보안을 유지하는 데 사용하면 일반적인 TCP/IP 문제 해결 절차와 도구는 실효성이 없을 수 있습니다. 이러한 이유로 통신에 IPsec을 사용하거나 사용하려고 하는 컴퓨터 간에 문제가 발생한 경우 적용될 수 있는 IPsec 특정 문제 해결 방법을 계획하고 개발하는 것이 중요합니다.

##### 이 페이지에서

[](#efaa)[지원 계층 및 문제 제기](#efaa)
[](#eeaa)[계층 1 문제 해결](#eeaa)
[](#edaa)[계층 2 문제 해결 준비](#edaa)
[](#ecaa)[IPsec 문제 해결 프로세스](#ecaa)
[](#ebaa)[계층 3 문제 해결](#ebaa)
[](#eaaa)[요약](#eaaa)

### 지원 계층 및 문제 제기

Microsoft 내에서 서버와 도메인 격리 지원은 표준 제공 서비스이며 표준 SLA(Service Level Agreement)에 정의되어 있습니다. 격리 지원은 다음 계층을 통해 제공됩니다.

-   **계층 1: 지원센터**. 지원 센터는 도메인 가입하거나 도메인에 가입하지 않은 클라이언트 문제에 대한 시작점입니다. 지원 센터에서는 중앙 IT 조직이 관리하는 서버를 지원하기도 합니다. 다른 서버는 업무용 응용 프로그램 팀 또는 제품 그룹에 의해 관리될 수 있습니다. 지원 센터 직원은 서버 및 도메인 격리와 관련된 문제를 분류하도록 분류법과 몇 가지 순서도의 사용 방법을 교육 받습니다.

    Microsoft 격리 솔루션의 시험 단계 동안에는 클라이언트 문제가 기업 IT 보안 부서로 제기됩니다. 단, 솔루션이 프로덕션 환경에 배포된 후 클라이언트 문제는 계층 2 지원 팀에서 처리합니다.

-   **계층 2: 데이터센터운영, 글로벌네트워크운영센터, LOB(기간현업) 응용프로그램지원및메시징/협업지원**. 이러한 그룹은 IT 서비스와 관련 자산을 모니터링하고 관리하는 일상적인 운영 팀입니다. 서버 및 도메인 격리 시험 동안 이러한 팀은 서버에 대한 지원 센터 및 기업 IT 보안(관련 문제 및 문제 해결)에 대한 초기 문제 제기 경로 지점입니다. 각 그룹은 상세한 문제 해결에 대한 절차뿐 아니라 서버 및 도메인 격리에 대한 분야별 전문가를 보유하고 있습니다.

-   **계층 3: Windows 네트워크및인프라서비스** 서버 및 도메인 격리 시험 동안 이 그룹은 IPsec, TCP/IP 패킷 처리, 컴퓨터 계정 및 네트워크 로그온 권한과 같은 솔루션 관련 아키텍처 구성 요소와 기술적 문제를 해결하는 전문가로 구성된 팀이라는 것이 확인되었습니다. Microsoft 내에서 추가 문제 제기가 필요한 경우 계층 3은 문제가 해결될 때까지 Windows 개발 팀과 직접 작업합니다. Microsoft 외에서 필요한 경우 이 수준은 Microsoft 기술 지원 서비스와도 관여됩니다.

다음 섹션은 계층 1 지원 조직에서 지원 센터 직원이 사용할 수 있는 문제 해결 방법을 요약합니다.

[](#mainsection)[페이지 위쪽](#mainsection)

### 계층 1 문제 해결

이 섹션에서는 계층 1 지원을 제공하기 위해 지원 센터 직원이 사용하는 IPsec 관련 문제 해결의 전반적인 프로세스를 소개합니다. 일반적으로, 계층 1 지원 담당자는 전화 기반 지원 센터 직원으로 원격으로 문제 진단을 시도합니다.

#### IPsec 문제입니까?

지원 센터에서 "IPsec을 켜기 전에는 서버 x에 연결할 수 있었어요." 또는 "어제는 아무 문제가 없었는데 오늘은 전혀 연결되지 않아요."라고 호소하는 전화를 받을 수 있습니다. Microsoft IT의 경험으로 볼 때, IPsec이 롤아웃됨에 따라 모든 유형의 네트워크 연결 문제와 "액세스 거부" 문제에 대한 통화가 급증하였고 이는 사용자들이 응용 프로그램과 네트워크 동작에 보다 많은 관심을 보였기 때문입니다. 누군가가 IPsec과 관련되었을 것이라고 판단한 경우 지원 센터에 전화를 했습니다. 서버 및 도메인 격리 구현 계획에는 지원 센터 직원이 IPsec 관련 문제의 양과 특성 대한 분명한 보고서를 제공할 수 있도록 통화 분류 시스템이 포함되어야 합니다.

적합한 관리 정보를 발신자에게 얻은 후에 지원 센터 직원은 정의된 문제 해결 과정을 따라야 합니다. IPsec 정책 설계가 통신에 미치는 영향이 다르고 롤아웃 프로세스에는 수일 또는 수주가 걸릴 수 있기 때문에 격리 변경 사항이 매번 구현될 때마다 순서도를 정의하고 업데이트해야 합니다. 지원 센터 관리 직원은 이러한 계획 프로세스에 참여해야 합니다.

지원 센터의 목표는 알려진 솔루션을 시도해 볼 수 있도록 문제를 분류하는 것입니다. 이러한 시도를 통해서도 문제를 해결하지 못하는 경우 지원 센터 직원은 적절한 정보를 수집하여 해당 문제를 계층 2 지원으로 승격할 수 있습니다. 예를 들어, 지원 센터는 다음과 같은 방법으로 다양한 유형의 문제를 식별할 수 있습니다.

-   **네트워크연결**. **ping**과 t**racert** ICMP(Internet Control Message Protocol) 메시지를 사용하여 네트워크 경로를 테스트합니다.

-   **이름확인**. **ping** *<대상이름>*과 **nslookup**을 사용합니다.

-   **응용프로그램**. 같은 대상과 통신 시 일부 응용 프로그램은 작동(예: **net view**)하지만 나머지 응용 프로그램은 작동하지 않습니다.

-   **서비스**. 예를 들어, 서로 충돌하는 L2TP용 자동 IPsec 정책을 만드는 라우팅 및 원격 액세스(RRAS) 서비스가 서버에서 실행 중인지 확인합니다.

-   **호출자의컴퓨터**. 지원 센터 테스팅 및 진단에 사용된 호스트 또는 트러스트된 특정 호스트 대상 컴퓨터에 액세스할 수 있는지 여부를 파악합니다.

-   **대상컴퓨터**. 호출자의 컴퓨터가 테스트에 사용된 모든 지원 센터 컴퓨터에는 액세스할 수 있지만 특정 대상 컴퓨터에는 액세스할 수 없는지 확인합니다.

조직에 따라 지원 센터에서 원격 지원 또는 원격 데스크톱을 사용하여 호출자의 컴퓨터에 연결할 수 있습니다. 원격 액세스가 지원 센터 직원이 IPsec MMC(Microsoft 관리 콘솔) 스냅인 또는 이벤트 로그 뷰어를 통해 호출자를 안내하기 위한 대안으로서 사용할 유용한 도구가 될 수 있지만 이 장에 제시된 지침에 필수적이지는 않습니다.

서버 격리가 도메인 격리 없이 사용된 시나리오에서 지원 센터 직원은 어떤 서버가 격리 그룹의 구성원인지 알아야 합니다.

##### 범위 및 심각도 지정

계층 1 지원이 해결해야 하는 첫 번째 질문 중 하나는 "누가 이 문제로 인해 영향을 받는가"라는 것입니다. 지원 직원은 문제가 다른 사용자에 의해 공유되었는지, 만약 그렇다면 얼마나 많은 사용자가 영향을 받는지, 또 그들이 현재 어디 위치하고 있는지 이해해야 합니다. 그런 다음, 지원 직원은 문제의 심각도를 파악해야 합니다. 예를 들어, 단일 서버에 대한 연결에 영향을 끼치거나 네트워크의 대부분에 걸쳐 로그온 또는 인증 오류와 같은 더욱 광범위한 문제가 있는지 확인해야 합니다.

연결 문제는 네트워크 통신에 사용된 많은 다양한 계층과 기술과 관련될 수 있습니다. 지원 엔지니어는 솔루션과 관련된 특정 문제뿐만 아니라 Windows TCP/IP 네트워크 통신이 일반적으로 작동하는 방법을 알아야 합니다. 이 섹션에서는 계층 1 지원이 처리해야 하는 다양한 유형의 문제와 공통된 문제를 검토합니다.

-   **컴퓨터특정문제**. IPsec 보호 통신은 상호 IKE(인터넷 키 교환) 컴퓨터 인증이 필요합니다. 통신을 시작하는 컴퓨터와 통신에 응답하는 컴퓨터는 해당 도메인의 도메인 컨트롤에 대한 유효한 액세스 권한과 도메인 계정을 가지고 있어야 합니다. 또한, IPsec 정책 할당 및 네트워크 액세스 컨트롤은 올바른 도메인 그룹에 있는 컴퓨터 계정에 따라 다릅니다. IPsec 동작에 영향을 미칠 수 있는 기타 컴퓨터 특정 문제에는 다음이 포함될 수 있습니다.

    -   운영 체제의 서비스 팩, 패치 또는 레지스트리 키 구성이 올바르지 않을 수 있습니다.

    -   컴퓨터에는 특정 소프트웨어가 설치되어 있거나 특정 서비스가 실행되고 있습니다.

    -   네트워크 연결에서 특정 IP 주소를 사용하거나 별도의 네트워크 경로를 사용하여 통신합니다.

    이와 같은 문제로 인해 일부 컴퓨터에 연결성과 관련된 문제가 있을 수 있습니다.

    **참고:** 이 장에서 논의된 모든 IPsec 문제 해결 도구에는 로컬 관리자 그룹 권한이 필요합니다.

-   **네트워크위치및경로관련문제**. 서버와 도메인 격리 솔루션 또는 기타 광범위한 IPsec 배포에서 모든 TCT와 UDP 트래픽이 캡슐화될 가능성이 있습니다. 따라서, 경로상에 있는 네트워크 장치에서 IKE, IPsec 및 ICMP 프로토콜만을 확인하게 됩니다. 원본과 대상간 이러한 세 가지 프로토콜의 전송에 네트워크 문제가 있는 경우 두 컴퓨터 간에 통신이 차단될 수 있습니다.

-   **사용자관련문제**. 서버 및 도메인 격리 시나리오와 같이 IPsec의 배포는 도메인 사용자의 네트워크 로그온 권한에 영향을 미칠 수 있습니다. 예를 들어, 이 문제는 승인된 네트워크 액세스 그룹에 속하지 않은 사용자에만 영향을 미치거나 승인된 사용자가 적합한 그룹 구성원 자격을 포함하고 있는 Kerberos 인증 자격 증명을 얻는 데 문제가 있을 수 있습니다. 도메인과 로컬 사용자 또는 서비스 계정 간 동작에 차이가 있을 수 있습니다.

일반적으로 기업 IPsec 배포에서도 발견되는 서버 및 도메인 격리 솔루션의 두 가지 다른 특징은 내부 네트워크에 사용되는 주소 범위 정의를 위해 서브넷 필터를 사용한다는 것과 내부 네트워크상 컴퓨터 위치에 상관없이 도메인 구성원 및 그룹 구성원에 기반하여 IPsec 정책을 적용한다는 것입니다. 따라서 컴퓨터가 다른 컴퓨터와 연결하기 위해 사용하는 서브넷 필터 또는 네트워크 경로 설계에 문제가 있는 경우, 특정 IP 주소(예: LAN 주소가 아닌 무선 주소)를 사용할 때, 특정 컴퓨터에서만, 네트워크의 일부에서만 연결 문제가 나타날 수 있습니다.

#### 문제 해결 순서도

이 섹션의 통화 처리 순서도는 Microsoft IT가 계층 1 IPsec 지원 문제를 분류하기 위해 개발했습니다. 표준 도구뿐 아니라 두 가지 순서도는 이 장 후반의 "지원 스크립트 예제" 섹션에서 자세하게 설명하는 IPsec 정책 새로 고침 스크립트를 참조합니다.

그림 7.1은 문제의 초기 진단과 문제 유형 파악을 위해 사용됩니다.

-   **네트워크연결문제입니까?** 네트워크 문제인 경우, 네트워크 문제 해결을 시도합니다. 문제 해결에 공하지 못한 경우 계층 2 지원으로 문제를 제기합니다.

-   **이름확인문제입니까?** 이름 확인 문제인 경우, 기본 이름 확인 문제 해결을 시도합니다. 문제 해결에 공하지 못한 경우 계층 2 지원으로 문제를 제기합니다.

-   **응용프로그램문제입니까?** 로그온 권한 문제인 경우, 계층 2 지원으로 문제를 제기합니다.

-   **호출자의컴퓨터의 IPsec 문제입니까?** 호출자 컴퓨터의 IPsec 문제인 경우, 그림 7.2로 이동합니다.

-   **호출자가연결하려고하는대상컴퓨터의 IPsec 문제입니까?** 대상 컴퓨터의 IPsec 문제인 경우, 그림 7.3으로 이동합니다.  

    [![](images/Dd547891.SGFG0701(ko-kr,TechNet.10).gif)](https://technet.microsoft.com/ko-kr/dd547891.sgfg0701_big(ko-kr,technet.10).gif)

    **그림 7.1 대상컴퓨터와의통신실패문제해결프로세스**

**참고**: 이 순서도는 호출자의 컴퓨터에 IPsec이 실행 중이고 DNS 역방향 조회 영역이 구성되어 ping -a 명령이 허용되는 경우를 가정합니다.

그림 7.2는 호출자 자신의 컴퓨터의 문제를 확인하기 위해 제공됩니다. 진단뿐만 아니라 이 순서도는 반드시 확인하지 않고도 문제를 해결할 수도 있는 IPsec 정책 새로 고침 스크립트(이 장 후반의 "지원 스크립트 예제 참조) 사용을 참조합니다. 그림 7.2의 단계는 호출자의 컴퓨터에 다음과 같은 잠재적인 문제를 확인하는 데 도움이 됩니다.

-   **RRAS 문제입니까?** "예"인 경우 RRAS 서비스를 중단하거나(RRAS가 필요하지 않은 경우) 해당 문제를 계층 2 지원으로 제기합니다.

-   **정책문제입니까?** IPsec 정책 문제인 경우, 그룹 정책과 IPsec 정책을 새로 고칩니다.

-   **도메인계정문제입니까?** "예"인 경우 호출자의 컴퓨터에 대한 도메인 계정을 만듭니다.

-   **해당사항없음?** IPsec 정책 새로 고침 및/또는 도메인 계정 만들기가 이 문제를 해결하지 못하는 경우 문제를 계층 2 지원으로 제기합니다.

    [![](images/Dd547891.SGFG0702(ko-kr,TechNet.10).gif)](https://technet.microsoft.com/ko-kr/dd547891.sgfg0702_big(ko-kr,technet.10).gif)

    **그림 7.2 호출자컴퓨터 IPsec –  관련문제해결**

그림 7.3은 특정 대상 컴퓨터의 문제를 확인하기 위해 제공됩니다. 이 순서도에서는 문제를 확인하지 않고도 해결할 수 있는 IPsec 정책 새로 고침 스크립트의 사용을 참조합니다. 그림 7.3은 다음과 같은 대상 컴퓨터(또는 경로)에 대한 잠재적인 문제를 파악하는 데 도움이 됩니다.

-   **RRAS 문제입니까?** 로그온 권한 문제인 경우, 계층 2 지원으로 문제를 제기합니다.

-   **IPsec 정책문제입니까?** IPsec 정책 문제인 경우, 그룹 정책과 IPsec 정책을 새로 고칩니다. 그런 다음 네트워크 연결을 확인합니다.

-   **네트워크연결문제입니까?** 로그온 권한 문제인 경우, 계층 2 지원으로 문제를 제기합니다.

-   **로그온권한문제입니까?** 로그온 권한 문제인 경우, 계층 2 지원으로 문제를 제기합니다.

    [![](images/Dd547891.SGFG0703(ko-kr,TechNet.10).gif)](https://technet.microsoft.com/ko-kr/dd547891.sgfg0703_big(ko-kr,technet.10).gif)

    **그림 7.3 대상컴퓨터 IPsec – 관련문제해결**

계층 1 지원 직원이 순서도를 통해 작업한 후 문제 상태는 다음 중 하나일 수 있습니다.

-   **원인파악후해결**. 이 상태는 해당 문제가 해결되고 문제의 원인이 파악되었음을 의미합니다.

-   **불명확하게해결**이 상태는 문제가 해결되었지만 문제의 원인이 완전하게 이해되지 않는다는 것을 의미합니다. 예를 들어, IPsec 정책을 새로 고쳐 이 문제를 해결할 수 있지만 잘못된 정책이 적용되거나 어떠한 정책도 적용되지 않은 이유를 반드시 설명하는 것은 아닙니다.

-   **미해결**. 이 상태는 문제가 여전히 남아 있고 문제로 확인된 가능성 있는 문제가 계층 2 지원으로 제기됨을 의미합니다.  

#### 사회 공학 공격의 방지

격리 솔루션에서 지원 센터 직원은 IPsec으로 보호되지 않은 제외 목록의 구성원 컴퓨터와 같은 IT 환경 내 특정 영역을 알게 됩니다. 다른 보안 솔루션에서 그러한 중요한 정보는 상위 지원 팀만 사용할 수 있기 때문에 중요한 정보를 보호하는 데는 사용되지 않습니다. 이러한 이유로 지원 센터 직원은 사회 공학 공격을 감지하고 제지하는 방법을 교육 받아야 합니다.

사회 공학 공격에서 트러스트되지 않은 다른 사람을 믿는 경향을 활용하여 보안의 구성 방법과 보안이 취약한 위치가 어디인지 정보를 얻으려 합니다. 다음 정보는 지원 센터 직원에 의해 주의 깊게 다루어져야 합니다.

-   **제외목록의구성원**. 제외 목록 필터의 IP 주소 목록은 IPsec Monitor MMC 스냅인을 사용하거나 로컬 레지스트리지의 도메인 IPsec 정책 캐시를 검토함으로써 모든 트러스트된 호스트의 로컬 관리자만 사용할 수 있습니다. 또한, 조직에 사용된 보안 설정은 비관리 사용자에게 캐시에 대한 읽기 액세스 권한을 제공할 수 있습니다. 도메인 격리가 완전하게 구현된 후에 공격자는 네트워크를 검색하여 TCP와 UDP 연결 요청에 응답할 수 있는 제외된 컴퓨터를 탐지할 수 있어야 합니다. DNS 서버, DHCP 서버 및 WINS 서버는 DHCP 구성을 통해 쉽게 확인되고, 도메인 컨트롤러는 DNS 쿼리 또는 LDAP(Lightweight Directory Access Protocol) 쿼리를 사용하여 쉽게 찾을 수 있습니다.

-   **격리솔루션에참여하지않는조직의컴퓨터**. 예를 들어, 특정 도메인 또는 서버 유형은 솔루션에 포함되지 않을 수 있습니다.

-   **서버격리를사용하거나시스템기반액세스제어가필요한컴퓨터**. 가장 중요한 정보가 포함된 서버는 일반적으로 최상의 보안 조치의 보호를 받습니다.

-   **IT 조직의관리자또는특별한역할을맡고있는사용자**. 경우에 따라 전자 우편 주소가 컴퓨터 이름 또는 컴퓨터 이름의 일부로 사용되어 로그온 이름 또는 전자 우편 주소를 노출하게 됩니다.

-   **특정한목적이나특정조직에서사용되는서브넷**. 이 정보가 알려지면 공격자는 네트워크의 가장 민감하고 중요한 부분에 공격을 집중할 수 있습니다.

-   **사용중인기타네트워크기반보안유지조치**. 예를 들어, 방화벽이 있는지, 라우터 필터가 특정 트래픽을 허용하는지 또는 네트워크 침입 탐지가 사용되고 있는지를 확인하는 일은 공격자에게 매우 유용합니다.

지원 센터 직원은 호출자가 무엇이 잘못되었는지를 확인하기 위해 자신이 컴퓨터 IP 주소로 연결할 것을 요청하는 경우 매우 신중하도록 교육 받아야 합니다. 즉, 공격자가 지원 센터의 직원에게 파일 공유, 원격 데스크톱, 텔넷 또는 기타 네트워크 프로토콜을 사용하여 컴퓨터에 연결할 것을 요청할 수 있습니다. 지원 센터 직원이 IPsec 없이 연결하는 경우 공격자의 컴퓨터는 암호에 대한 정보를 얻거나 텔넷 등을 사용하는 경우에는 암호를 훔칠 수도 있습니다. 이러한 상황은 일부 클라이언트 네트워크 프로토콜이 먼저 대상 컴퓨터를 인증하여 강력한 트러스트를 구축하지 않거나 사용자 ID 또는 암호 관련 정보를 노출하기 전에 강력한 암호 보호를 요청하지 않기 때문에 발생할 수 있습니다.

#### 지원 스크립트 예제

대부분의 문제 해결 시나리오의 경우 적합한 정보가 확인된 후에 신속하게 솔루션을 결정할 수 있습니다. 이러한 정보는 순서도에 참조된 도구와 같이 다양한 Windows 도구를 사용하여 찾아낼 수 있습니다. Woodgrove 은행 솔루션에서는 다양한 스크립트가 계층 1 지원 직원이 도구 운영 및 구문에 대한 상세한 정보를 가지고 있지 않아도 중요한 정보를 제공할 수 있도록 개발되었습니다. 이러한 스크립트는 이 가이드를 다운로드한 후 도구 및 템플릿 폴더에 찾을 수 있습니다.

##### 계층 1 지원에 사용할 수 있는 스크립트

사용자가 자신의 컴퓨터의 로컬 관리자인 경우 지원 센터 직원은 이 솔루션에 제공된 세 가지 스크립트 중 하나를 실행하도록 할 수 있습니다. 이러한 스크립트는 이 가이드에 상세하게 설명된 Woodgrove 은행 환경에 사용된 사용자 지정된 스크립트의 예제입니다. 이 장에 스크립트가 문제 해결 프로세스를 지원하기 위해 사용될 수 있는 방법을 예시하기 위해 설명되어 있습니다.

**참고**: 이러한 스크립트는 테스트된 예제이지만 Microsoft에서 지원하지는 않습니다. 조직에서 보유하고 있는 사용자 정의된 솔루션의 기초로 사용되어야 합니다.

###### IPsec\_Debug.vbs
이 스크립트는 디버그 정보를 제공할 뿐만 아니라 일부 문제를 실제로 해결할 수도 있습니다. 이 스크립트는 IPsec 서비스를 중지한 후 다시 시작(현재 모든 IKE 및 IPsec 보안 연결을 삭제)하고 그룹 정책 새로 고침을 강제 적용하여 Active Directory® 디렉터리 서비스에서 현재 도메인 할당 IPsec 정책을 다시 로드하고 정책 캐시를 업데이트합니다. 원격 데스크톱 세션의 연결이 손실되지 않도록 하기 위해 스크립트를 호출자의 컴퓨터로 다운로드한 후 관리 권한을 가진 계정을 사용하여 로컬에서 실행하도록 해야 합니다. 다음 구문을 사용하여 명령 프롬프트에 스크립트를 실행합니다.

```
    cscript IPsec_Debug.vbs
```    

스크립트는 다음 기능을 수행합니다.

-   운영 체제 버전 검색

-   **Detect\_IPsec\_Policy.vbs** 호출

-   그룹 정책 로깅 증가

-   Kerberos 버전 5 인증 프로토콜 로깅 증가

-   현재 Kerberos 프로토콜 티켓 제거

-   그룹 정책 새로 고침

-   IPsec 로깅 활성화

-   PING 및 SMB(Net View) 테스트 수행

-   IPsec 파일 버전 검색

-   정책 및 네트워크 진단 테스트 실행

-   IPsec 547 이벤트를 텍스트 파일로 복사

-   IPsec 로깅 비활성화

-   Kerberos 프로토콜 로깅 복원

-   그룹 정책 로깅 복원

이 스크립트는 또한 계층 2 지원으로 문제를 해결하기 위해 모든 IPsec 관련 로그를 활성화합니다.

###### Detect\_IPsec\_Policy.vbs

이 스크립트는 도메인 IPsec 정책에 대한 정책 버전 정보에 대해 현재 로컬 레지스트리 캐시를 확인함으로써 컴퓨터에 올바른 IPsec 정책이 실행되고 있는지를 파악합니다. 다음 구문을 사용하여 명령 프롬프트에 스크립트를 실행합니다.


```
    cscript Detect_IPsec_Policy.vbs
``` 

**참고:** 이 스크립트는 **IPsec\_Debug.vbs**에서도 호출되므로 해당 스크립트와 함께 실행될 필요가 없습니다.

###### Refresh\_IPsec\_Policy.vbs

이 스크립트는 문제 해결 순서도에 참조된 IPsec 정책 새로 고침 스크립트입니다. 컴퓨터의 Kerberos 인증 프로토콜 티켓과 그룹 정책을 새로 고치고 잘못된 IPsec 정책 할당 또는 그룹 정책 다운로드 오류로 인한 경우 해당 문제를 해결할 수 있습니다. 다음 구문을 사용하여 명령 프롬프트에 스크립트를 실행합니다.

```
    cscript Refresh_IPsec_Policy.vbs
```

#### 문제 제기

지원 센터 직원이 IPsec으로 추측되는 문제를 제기해야 하는 경우 다음 정보를 계층 1에서 수집하여 다음 서비스 요청과 함께 전달해야 합니다.

-   **IPsec\_Debug.vbs** 스크립트로 생성된 로그 파일.

-   다음 지원 계층이 스크립트로 생성된 로그 파일을 확인할 수 있는 호출자의 시스템 번호.

-   액세스가 거부되어 적절한 지원 그룹으로 문제가 제기될 수 있는 대상 컴퓨터.

서버 격리 시나리오에는 네트워크 액세스 그룹의 구성원을 조사할 수 있는 자체 지원 팀이 있는 경우가 있습니다.  

[](#mainsection)[페이지 위쪽](#mainsection)

### 계층 2 문제 해결 준비

계층 2 지원은 두 개의 주요 역할을 담당합니다. 첫째, 모든 계층 1 문제 제기의 수신자로서 계층 2는 문제의 유효성을 검증하고 문제 해결 단계를 하나라도 놓치지 않도록 계층 1에서 취한 단계를 확인합니다. 이와 관련하여 계층 2는 어떠한 제기된 문제가 실제로 오진단이 아니며 IPsec으로 인한 것이라는 사실을 확인해야 합니다. 둘째, 숙련된 네트워크 지원 엔지니어로서 계층 2 지원 직원은 자신의 기술과 경험(다음 섹션에 제시)으로 컴퓨터의 관리자 권한을 얻지 않고도 로그 분석을 통해 문제를 해결할 수 있어야 합니다. 그러나, 로그에는 정보만이 수집될 뿐 수정 작업을 수행하려면 관리자 액세스가 필요합니다. 계층 2 지원 직원이 도메인 관리자이거나 도메인 기반 IPsec 정책 또는 컴퓨터 그룹 구성원에 변경 사항을 적용할 수 있을 것으로 기대되지는 않습니다.

#### 계층 2 지원 기술

계층 2 IPsec 지원을 제공하는 지원 직원은 다음과 같은 분야에 기술과 전문 지식을 가지고 있어야 합니다.

-   **그룹정책**. 어떤 정책이 어떻게 할당되는지 파악하고 다음 작업을 수행할 수 있어야 합니다.

    -   GPO(그룹 정책 개체)의 ACL(액세스 제어 목록)을 확인합니다.

    -   GPO 설정을 확인합니다.

    -   컴퓨터와 사용자에 대한 그룹 구성원을 확인합니다.

-   **조직에서사용하는타사소프트웨어사용경험이있어야합니다.**

-   **인증오류확인**.

    -   **netdiag**와 **nltest** 유틸리티를 사용하여 도메인 컴퓨터 계정이 정상인지 확인할 수 있습니다.

-   **IPsec 구성**. 다음 작업을 수행할 수 있어야 합니다.

    -   IPsec 필터 구성을 확인합니다.

    -   IPsec 도메인 정책을 다시 로드합니다.

    -   IPsec을 완전히 비활성화하거나 테스트를 위해 로컬 정책을 사용하도록 도메인 정책만을 활성화합니다.

    -   IPsec IKE 협상 과정 및 보안 프로토콜의 문제를 해결합니다.

-   **네트워킹**. 다음 작업을 수행할 수 있어야 합니다.

    -   호스트 시스템의 네트워크 프로토콜 스택의 문제를 해결합니다.

    -   네트워크 추적에서 수집된 정보를 파악하고 문제를 해결합니다.

    -   TCP 경로 MTU 검색 및 가상 사설망(VPN) 원격 액세스 솔루션을 포함하여 네트워크 경로 문제를 해결합니다.

#### IPsec 사용으로 인해 기본적으로 발생하는 문제

이전 섹션에서 제시한 것처럼 서버 및 도메인 격리 솔루션의 계층 2 지원 직원은 IPsec 보호 통신에 대해 자세히 알고 있어야 하지만 기타 기술 구성 요소와 관련된 문제를 분리할 수도 있어야 합니다.

두 컴퓨터 간 성공적인 IPsec 통신의 위해 두 대의 컴퓨터는 일반적으로 호환 가능한 IPsec 정책이 필요합니다. 예를 들어, IPsec 정책은 원격 컴퓨터가 적합한 IPsec 정책을 가지고 있지 않은 경우 통신을 차단할 수도 있습니다. 이러한 기능이 정책 변경 롤아웃 동안 의도되거나 수용 가능한 동작일 수 있지만, 한 대 이상 컴퓨터의 네트워크 연결을 차단하여 어떠한 응용 프로그램 경고 또는 오류를 발생시킬 수 있을지는 바로 나타나지 않을 수 있습니다. 최악의 시나리오에서는 관리자가 실수로 IPsec 정책을 모든 도메인 구성원에 할당하여 *모든* 트래픽을 차단할 수도 있습니다. 원래 할당 후에 신속하게 복제된 올바른 할당과 함께 이 실수를 금방 깨닫지 못하는 경우 손상된 정책의 복제는 쉽게 중지되지 않습니다. 이러한 유형의 실수는 클라이언트와 도메인 컨트롤러 간 통신에 IPsec이 필요한 경우의 상황에 발생할 수 있습니다. 이 솔루션에 사용된 인증이 Kerberos 프로토콜에 의존하기 때문에 이러한 정책을 상속하는 클라이언트는 통신의 보안을 유지하는 데 필요한 Kerberos 티켓을 얻을 수 없기 때문에 로그온 프로세스를 완료할 수 없게 됩니다. 관리자는 주의 깊게 정책의 변경 사항을 계획하고 이러한 유형의 상황을 완화하기 위한 절차적 보완책이 있는지 확인합니다.

TCP/IP 문제 해결에 대한 배경 정보가 이 장 끝 부분의 "추가 정보" 섹션에 있는 문제 해결 가이드에 제공되어 있습니다. 단, 이러한 가이드에 언급된 대부분의 절차는 IPsec이 성공적인 연결을 제공하는 경우에만 적용할 수 있습니다. IKE 또는 IPsec이 실패하는 경우 이러한 절차와 도구의 대부분은 효과가 없게 됩니다. 서버 및 도메인 격리 시나리오에서 배경 가이드에 문서화된 일부 절차는 IPsec이 성공적인 연결을 제공하는 경우에도 전혀 적용할 수 없습니다. 지원 조직은 서버와 도메인 격리 환경 내에 효과를 유지하기 위해 문제 해결 도구 및 절차를 업데이트하고 사용자 지정해야 합니다. IPsec 정책이 배포되어 트래픽을 제어하고 안전하게 유지하는 데 도움이 되는 많은 다양한 방법이 있기 때문에 조직이 기존 절차와 일반 도구 키트에만 의지해야 할 경우는 거의 없습니다.

직원 담당자가 서버 및 도메인 격리 또는 일부 다른 IPsec 배포가 제대로 작동되는 랩 환경에서 획득한 네트워크 문제 해결 도구의 예상 결과물의 예를 문서화하는 것이 중요합니다. 대부분의 경우에 네트워크 진단 도구는 변경 시 3초 지연 또는 IPsec SA(보안 연결)의 IKE 초기 협상에 지연이 있을 것으로 기대되지 않습니다. 따라서 도구는 처음에 실행될 때는 하나의 결과를 표시하지만 몇 초 후에 실행하면 다른 결과를 표시할 수 있습니다. 또한, 네트워크 액세스가 IPsec에서 고의적으로 거부된 곳에 위치에 대해 오류가 보고될 수 있습니다. 오류 유형은 도구와 IPsec 환경에 따라 달라집니다.

**참고**: 계층 1 섹션에서 *호출자*와 *대상*이라는 용어가 지원 직원이 공통된 문제를 해결하도록 사용됩니다. 계층 2 섹션에서는 고급 문제 해결 프로세스를 분명하게 제시하기 위해 IPsec 용어 *초기자*와 *응답자*를 사용하는 것이 좋습니다. 이 장의 이후 내용에서는 이러한 IPsec 용어를 사용합니다.

##### 그룹 정책 및 그룹 구성원

도메인 기반 IPsec 정책은 그룹 정책과 GPO 다운로드에 따라 다릅니다. 클라이언트 그룹 정책 시스템이 GPO 변경 사항을 검색 또는 다운로드하는 데 오류가 발생한 경우 IPsec 연결이 영향을 받을 수 있습니다. 그룹 정책 할당이 조직 단위(OU) 구성원에 의해 제어되고 컴퓨터 계정이 다른 OU로 이동, 삭제 또는 잘못된 OU에서 다시 만들어진 경우 부적합한 IPsec 정책이 할당될 수 있습니다.

이 솔루션에서는 도메인 보안 그룹을 사용하여 정책 할당을 제어하고 네트워크 액세스를 제어합니다. 그룹 구성원은 수명이 긴 Kerberos 버전 5 인증 프로토콜 티켓(TGT와 서비스 티켓 포함) 내에 포함됩니다. 따라서 관리자는 컴퓨터가 그룹 구성원 업데이트가 포함된 새 Kerberos TGT와 서비스 티켓 자격 증명을 받는 데 필요한 시간을 계획해야 합니다. Kerberos 프로토콜은 컴퓨터에 대한 Kerberos 티켓에 적절한 그룹 구성원이 포함되어 있는지 여부를 파악하는 것을 매우 어렵게 합니다. 이러한 어려움은 그룹 구성원에 대한 모든 정보가 티켓 내에 암호화된 양식으로 저장되기 때문이며 "설계상의 문제"입니다. 그룹 구성원은 티켓 자체가 아닌 디렉터리 서비스 내의 정보를 사용하여 확인되어야 합니다.

##### Kerberos 인증

서버 및 도메인 격리 설계에서는 IKE 인증에 Kerberos 버전 5 프로토콜을 사용합니다. Kerberos 프로토콜이 DNS 및 도메인 컨트롤러에서 사용할 수 있는 서비스와 성공적인 네트워크 연결을 요청하기 때문에 연결 부족은 Kerberos 인증과 IKE 실패를 일으킬 수 있습니다. Kerberos가 실패하는 경우 IKE 도한 실패합니다. 따라서 컴퓨터 A와 컴퓨터 B 간의 연결성 문제는 도메인 컨트롤러로 인증하는 Kerberos 프로토콜의 사용 불가로 인해 유발된 컴퓨터 A와 컴퓨터 C간의 네트워크 연결 차단에 의해 야기될 수 있습니다. 이와 같은 상황에서 Windows 감사 및 보안 로그의 547 이벤트에서 제공된 정보는 문제의 원인에 대한 중요한 정보를 제공합니다.

##### IPsec 보호 인바운드 트래픽 필요

이 서버 및 도메인 격리 솔루션에서는 IPsec 보호 통신이 인바운드 액세스에 필요하다는 것을 명시하고 있습니다. 이러한 요구 사항으로 인해 트러스트되지 않은 컴퓨터 또는 전담 네트워크 장치에서 실행되는 원격 모니터링 도구가 원격 컴퓨터가 연결 가능하지 않다는 것을 보고하게 됩니다. 이러한 컴퓨터 또는 장치가 "트러스트된" 환경에 참여할 수 없는 경우 일부 특정 제외 항목이 설계에 추가되지 않는 경우 모니터링 역할을 수행할 수 없게 됩니다. IPsec이 트러스트된 호스트에 대한 연결을 구축하는 데 필요할 수 있다는 사실로 인해 문제 해결이 복잡해집니다. 즉, 이는 관리자가 트러스트된 호스트에 연결한 다음 연결을 잃지 않고 IPsec 서비스를 중단할 수 없다는 것을 의미합니다. 관리자의 IPsec 정책이 선택 취소를 허용하게 되면 원격 연결은 서비스가 원격 컴퓨터에서 중단된 후에 3초 또는 4초 지연을 경험하게 됩니다. 그러나, 원격 컴퓨터에서 IPsec 서비스를 중단하면 모든 다른 현재 연결된 컴퓨터에서 사용 중인 IPsec SA를 지우게 됩니다. 이러한 다른 컴퓨터가 선택 취소를 할 수 없는 경우 통신은 중단되고 TCP 연결이 시간 초과됩니다. 갑작스런 TCP 통신 중단으로 응용 프로그램의 데이터 손상이 발생하기 때문에 IPsec 서비스 중단은 문제 해결 프로세스에서 마지막 옵션으로만 사용되어야 합니다. IPsec 서비스가 중단되기 전에 컴퓨터는 모든 연결된 사용자와 응용 프로그램이 제대로 연결을 종료할 수 있도록 종료 준비를 해야 합니다.

##### 통신 방향 문제

자주 나타나는 문제 해결 시나리오로 한 방향 통신에는 성공하지만 역 방향 통신에는 실패하는 경우가 있습니다. IKE 인증은 일반적으로 컴퓨터 간 상호 인증을 요구합니다. 한 대의 컴퓨터가 원격 컴퓨터에 대해 IKE 메인 모드를 실행시킬 때 Kerberos 티켓을 얻을 수 없다면 IKE는 실패합니다. 이러한 상황은 연결을 시작하는 컴퓨터의 Kerberos 클라이언트가 대상 컴퓨터의 도메인에 있는 도메인 컨트롤러에 액세스할 수 없는 경우 발생할 수 있습니다. 컴퓨터가 상호 트러스트(양방향 트러스트)되지 않은 도메인의 구성원인 경우 IKE 주 모드 협상은 한 대의 컴퓨터가 시작하면 성공하고 다른 컴퓨터가 시작하면 실패합니다. 이와 마찬가지로, 인바운드 네트워크 로그온 권한은 두 대의 컴퓨터에서 다를 수 있습니다. 이러한 이유로 IKE 주 모드와 빠른 모드 협상이 한 방향에서 실패할 수 있습니다. 또한, IPsec 정책이 양방향 협상과 호환되지 않기 때문일 수도 있습니다.

IPsec 계층 상위의 트래픽을 가로채는 호스트 기반 방화벽에서 연결의 방향을 강제로 적용할 수 있습니다. 일부 호스트 기반 방화벽은 IPsec 계층 하위의 트래픽을 가로챕니다. 성공적인 IPsec 통신이 구축된 후에 IPsec 보호 트래픽은 일정 기간 동안 양 방향에서 허용될 수 있습니다.

네트워크 라우터 또는 방화벽에 의한 상태 저장 필터링도 ICMP와 같은 다른 진단 프로토콜에 영향을 주지 않고 IKE 키 다시 대조 작업 또는 IPsec 트래픽 흐름을 차단할 수 있습니다. TCP와 UDP 포트는 서비스가 실행 중이 아니거나 IPsec 계층 상위에서 작동되는 장비(예: Windows 방화벽 또는 네트워크 라우터)가 액세스를 차단하기 때문에 한 대의 컴퓨터에서 액세스할 수 없을 수 있습니다.

##### 네트워크 추적 및 고급 네트워크 경로 문제 해결

IKE 협상 오류로 인해 오류를 경험하는 컴퓨터가 IKE 협상 응답을 중지하거나 일부 경우에 다시 시도 제한이 만료될 때 까지 마지막 "양호" 메시지를 다시 전송할 수 있습니다. IKE는 Kerberos 티켓이 대상 IP 주소에 대해 PMTU(경로 최대 전송 단위)를 초과하는 경우가 있으므로 Kerberos 티켓이 포함된 조각화된 UDP 다이어그램을 전송할 수 있어야 합니다. 조각화가 제대로 지원되지 않으면 그러한 조각은 일정 경로를 따라 네트워크 장치에 의해 손실될 수 있습니다. 또한, 네트워크는 IPsec 프로토콜 패킷 또는 IPsec 패킷의 조각을 제대로 전달할 수 없게 됩니다. TCP와의 IPsec 통합을 통해 TCP는 패킷 크기를 IPsec 헤더의 오버헤드를 수용할 수 있을 만큼 줄일 수 있습니다. 단, TCP 핸드셰이크 중에 최대 조각 크기(MSS)의 TCP 협상에는 IPsec 오버헤드가 고려되지 않습니다. 따라서, 성공적인 IPsec 보호 TCP 통신을 보장하기 위해 네트워크에서 ICMP PMTU 검색에 대한 요구 사항이 증가하게 되었습니다. 즉, 연결 오류 문제를 해결하면 통신 양측으로부터 로그뿐 아니라 통신의 한 측 또는 양 측의 네트워크 트레이스가 필요할 수 있습니다.

기술 지원 엔지니어는 네트워크 트레이스를 읽는 방법을 이해해야 하며 IKE 협상도 이해해야 합니다. 서버에 Windows Network Monitor 소프트웨어가 설치되어 있어야 합니다. Windows 2000 Network Monitor는 IPsec AH 및 IKE의 구문 분석을 제공합니다. Windows Server 2003은 IPsec ESP-null 구문 분석, 암호화가 오프로드되는 경우 ESP 파싱 및 NAT 통과에 사용된 UDP-ESP 캡슐화 파싱에 대한 지원을 추가합니다.

#### 문제 해결 도구 키트

문제 해결을 시작하기 전에 문제 해결 프로세스를 지원하기 위해 정보를 추출할 수 있는 유틸리티를 확인하는 것이 중요합니다. 이 섹션에서는 Windows 2000, Windows XP, Windows Server 2003 도움말 또는 Microsoft Windows Server™ 2003 웹 사이트의 [문제 해결 도구](http://www.microsoft.com/technet/prodtechnol/windowsserver2003/library/serverhelp/ebcbc96d-b236-401d-a98b-91c965a3d18f.mspx) (영문)페이지(www.microsoft.com/resources/documentation/WindowsServ/2003/standard/proddocs/en-us/sag\_IPSec\_tools.asp)를 통해 이용할 수 있는 정보를 반복하지는 않겠습니다.

참조된 Troubleshooting tools 페이지 또는 운영 체제 버전 간 요약 정보를 얻는 것이 유용한 곳에서 쉽게 찾을 수 없는 경우에 상세한 도구 정보만이 제공됩니다.

##### IP 보안 정책 관리 MMC 스냅인

IP 보안 정책 관리 MMC 스냅인이 로컬 IPsec 정책 또는 Active Directory에 저장된 IPsec 정책을 만들고 관리하는 데 사용됩니다. 또한, 원격 컴퓨터에서 IPsec 정책을 수정하는 데 사용될 수 있습니다. IP S보안 정책 관리 MMC 스냅인은 Windows Server 2003, Windows XP, Windows 2000 Server 및 Windows 2000 Professional 운영 체제에 포함되어 IPsec 정책의 세부 사항, 필터, 필터 목록 및 필터 작업을 검토하고 편집하며 IPsec 정책을 할당 및 할당 해제하는 데 사용될 수 있습니다.

##### IP 보안 모니터 MMC 스냅인

IP 보안 모니터 MMC 스냅인은 IPsec의 통계와 할성 SA를 보여 줍니다. 또한 다음 IPsec 구성 요소에 대한 정보를 확인하는 데 사용됩니다.

-   IKE 주 모드 및 빠른 모드

-   로컬 또는 도메인 IPsec 정책

-   컴퓨터에 적용되는 IPsec 필터  

이 스냅인이 Windows XP 및 Windows Server 2003 운영 체제에 속하는 경우 Windows XP와 Windows Server 2003 버전 간에 기능 및 인터페이스 차이점이 있습니다. 또한, Windows Server 2003 버전에는 다음과 같은 추가 기능이 있습니다.

-   정책 이름, 설명, 마지막 수정 날짜, 저장, 경로, OU 및 그룹 정책 개체 이름을 포함한 활성 IPsec 정책에 대한 세부 정보를 제공합니다. Windows XP에서 동일한 정보를 얻으려면 IPseccmd 명령줄 도구를 사용해야 합니다(이 섹션 후반에 설명).

-   통계는 하나의 디스플레이보다는 각 모드의 폴더에서 주 모드 또는 빠른 모드에 대해 별도로 제공됩니다.

    **참고:** Windows 2000에서 IP 보안 모니터는 자체 GUI(그래픽 사용자 인터페이스)가 있는 독립 실행형 실행 프로그램(IPsecmon.exe)입니다. 이 도구와 사용 방법은 http://support.microsoft.com/kb/257225에서 제공되는 Microsoft 기술 자료 문서 257225, "[Basic IPSec troubleshooting in Microsoft Windows 2000 Server](http://support.microsoft.com/kb/257225)"를 참조하십시오.

XP에서 사용 가능한 이 스냅인에 대한 업데이트는 http://support.microsoft.com/?kbid=818043에서 제공되는 Microsoft 기술 자료 문서 818043, "[L2TP/IPSec NAT-T update for Windows XP and Windows 2000](http://support.microsoft.com/?kbid=818043)"을 참조하십시오. 이 업데이트를 사용하면 Windows XP에서 Windows Server 2003 컴퓨터를 볼 수 있습니다. 업데이트된 IP 보안 모니터 MMC 스냅인은 Windows Server 2003에 만들어진 고급 기능(예: Diffie-Hellman 그룹 정보, 인증서 매핑 및 동적 필터)을 읽을 수는 있지만 편집할 수는 없습니다. 자세한 내용은 참조된 KB 문서를 참조하십시오.

##### Netsh

Netsh는 사용자가 네트워크 구성을 표시 또는 수정할 수 있는 명령줄 스크립팅 유틸리티입니다. 또한, Netsh를 로컬 또는 원격으로 사용할 수도 있습니다. Netsh는 Windows 2000, Windows XP 및 Windows Server 2003에서 사용할 수 있습니다. 단, Windows Server 2003 버전은 향상되어 IPsec 진단 및 관리 기능을 제공할 수 있습니다. IPsec에 대한 Netsh 명령은 Windows Server 2003에서만 사용할 수 있으며, Windows XP의 Ipseccmd를 대체하고 Windows 2000의 Netdiag를 대체합니다.

##### Ipseccmd

Ipseccmd는 IP 보안 정책 MMC 스냅인에 대한 대체 명령줄입니다. Windows XP에서만 사용할 수 있으며 Windows XP 서비스 팩 2를 사용할 경우 이 도구의 추가 기능을 활용할 수 있습니다.

Ipseccmd는 Windows XP CD의 지원 도구 폴더에서 설치해야 합니다. 업데이트된 버전은 Windows XP SP2에서만 사용할 수 있으며 Windows XP SP2 CD의 지원 도구 폴더로부터 설치해야 합니다. SP2 이전 버전은 업데이트된 컴퓨터에서 작동되지 않고 업데이트된 버전은 SP2 이전 컴퓨터에서 작동되지 않습니다.

업데이트된 Ipseccmd 유틸리티는 다음 기능을 가지고 있습니다.

-   IKE 로깅을 동적으로 켜고 끕니다.

-   현재 할당된 정책에 대한 정보를 표시합니다.

-   영구적인 IPsec 정책을 만들 수 있게 합니다.

-   현재 할당되고 활성화된 IPsec 정책을 표시할 수 있습니다.

업데이트된 Ipseccmd 유틸리티에 대한 자세한 내용은 앞서 언급한 Microsoft 기술 자료 문서 818043을 참조하십시오.

모든 IPsec 정책 설정 및 진단 통계를 표시하려면 다음 구문을 사용하십시오.

```
    ipseccmd show all
```

현재 할당되고 활성화된 IPsec 정책(로컬 또는 Active Directory)을 표시하려면 다음 구문을 사용하십시오.

```
    ipseccmd show gpo
```

**참고:** 이 명령은 SP2 버전에서만 작동됩니다.

Windows XP SP2에서 디버그 로깅을 활성화하려면 다음 구문을 사용하십시오.

    ipseccmd set logike  (IPsec 서비스 다시 시작 필요 없음)

디버그 로깅을 끄려면 다음 구문을 사용하십시오.

    ipseccmd set dontlogike  (IPsec 서비스 다시 시작 필요 없음)

**참고:** Ipseccmd를 사용해야 Windows XP SP2에서 Oakley 로깅을 활성화할 수 있으며 위 명령은 SP2 이전 컴퓨터에서는 작동하지 않습니다.

##### Netdiag

Netdiag는 명령줄 진단 도구로서 IPsec 정보를 포함하여 네트워크 연결 및 구성을 테스트하는 데 사용됩니다. Netdiag는 Windows 2000, Windows XP 및 Windows Server 2003에서 사용할 수 있지만 해당 기능은 운영 체제 버전에 따라 다릅니다. Windows Server 2003의 경우 Netdiag에는 더 이상 IPsec 기능이 포함되지 않습니다. 대신, netsh ipsec 컨텍스트를 사용할 수 있으며 기본 네트워크 테스팅도 Netsh를 통해 실행할 수 있습니다. 모든 운영 체제 버전에 대해 Microsoft 다운로드 센터를 확인하여 항상 최신 버전을 사용하는 것이 중요합니다. Netdiag는 사용하는 Windows 운영 체제 CD에 관계없이 Supprot Tools 폴더에서 설치해야 합니다.

**참고**: Windows XP SP2가 설치된 경우 Netdiag가 업데이트되지 않습니다.

IPsec 문제 해결에 대한 Netdiag의 관련성은 운영 체제 버전에 따라 다릅니다. 기능의 차이점은 다음 표에 설명되어 있습니다.

**표 7.1: 운영체제별 Netdiag IPsec 기능차이**

<table style="border:1px solid black;">
<colgroup>
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="20%" />
</colgroup>
<thead>
<tr class="header">
<th style="border:1px solid black;" >명령</th>
<th style="border:1px solid black;" >설명</th>
<th style="border:1px solid black;" >Windows
2000?</th>
<th style="border:1px solid black;" >Windows
XP?</th>
<th style="border:1px solid black;" >Windows
2003?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="border:1px solid black;">netdiag<br />
/test:ipsec</td>
<td style="border:1px solid black;">할당된 IPsec 정책 확인</td>
<td style="border:1px solid black;">필요함</td>
<td style="border:1px solid black;">필요함</td>
<td style="border:1px solid black;">아니요&#42;&#42;</td>
</tr>
<tr class="even">
<td style="border:1px solid black;">netdiag<br />
/test:ipsec<br />
/debug</td>
<td style="border:1px solid black;">활성 IPsec 정책, 필터 및 빠른 모드 통계 표시</td>
<td style="border:1px solid black;">필요함</td>
<td style="border:1px solid black;">예&#42;</td>
<td style="border:1px solid black;">아니요&#42;&#42;</td>
</tr>
<tr class="odd">
<td style="border:1px solid black;">netdiag<br />
/test:ipsec<br />
/v</td>
<td style="border:1px solid black;">활성 IPsec 정책, 필터 및 주 모드 통계 표시</td>
<td style="border:1px solid black;">필요함</td>
<td style="border:1px solid black;">예&#42;</td>
<td style="border:1px solid black;">아니요&#42;&#42;</td>
</tr>
</tbody>
</table>
  
\* 네트워크 통계를 제공하지만, IPsec 정책 이름만 표시합니다. Ipseccmd를 사용하는 경우에만 추가 IPsec 정보가 제공됩니다.
  
\*\* 네트워크 진단을 제공하지만 어떠한 IPsec 정보도 표시하지 않습니다. 대신, 다음 구문: netsh ipsec dynamic show all을 사용합니다.
  
##### IPsec을 지원하는 기타 유용한 도구
  
이전에 언급된 IPsec 특정 도구뿐 아니라 다음 표에는 문제 해결에 유용하며 사용자의 계층 2 문제 해결 도구 키트에 포함되어야 하는 기타 도구의 목록이 제시됩니다.
  
**표 7.2: IPsec 문제해결에유용한기타도구**

 
<table style="border:1px solid black;">
<colgroup>
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="20%" />
</colgroup>
<thead>
<tr class="header">
<th style="border:1px solid black;" >도구</th>
<th style="border:1px solid black;" >지원되는 운영 체제</th>
<th style="border:1px solid black;" >실행 방법</th>
<th style="border:1px solid black;" >역할</th>
<th style="border:1px solid black;" >추가 정보</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="border:1px solid black;">Ipsecpol.exe</td>
<td style="border:1px solid black;">Windows 2000만</td>
<td style="border:1px solid black;">Windows Server 2000 Resource Kit</td>
<td style="border:1px solid black;">디렉터리 또는 레지스트리에서 IPsec 정책 구성</td>
<td style="border:1px solid black;">Windows 2000 Resource Kit 도구 도움말</td>
</tr>
<tr class="even">
<td style="border:1px solid black;">Gpresult</td>
<td style="border:1px solid black;">Windows 2000, Windows Server <br />
2003, Windows XP</td>
<td style="border:1px solid black;">Windows 2000– Resource Kit(Windows XP 및 Windows Server <br />
2003의 경우 운영 체제의 일부임)</td>
<td style="border:1px solid black;">그룹 정책이 최종 적용된 시기 확인</td>
<td style="border:1px solid black;">Windows 2000 Resource Kit Tools 도움말, Windows XP 및 Windows Server <br />
2003 도움말</td>
</tr>
<tr class="odd">
<td style="border:1px solid black;">RSoP(정책의 결과 집합) MMC<br />
스냅인</td>
<td style="border:1px solid black;">Windows Server <br />
2003, Windows XP</td>
<td style="border:1px solid black;">운영??????? 체제의 일부</td>
<td style="border:1px solid black;">컴퓨터 또는 그룹 정책 컨테이너의 구성원에 대한 IPsec 정책 확인</td>
<td style="border:1px solid black;">Windows Server <br />
2003 도움말</td>
</tr>
<tr class="even">
<td style="border:1px solid black;">Srvinfo</td>
<td style="border:1px solid black;">Windows 2000, Windows Server <br />
2003, Windows XP</td>
<td style="border:1px solid black;">Windows 2000  및 Windows Server <br />
2003 Resource Kit</td>
<td style="border:1px solid black;">서비스, 장치 드라이버 및 프로토콜 정보</td>
<td style="border:1px solid black;">Windows Server <br />
2003 Resource Kit Tools 도움말</td>
</tr>
<tr class="odd">
<td style="border:1px solid black;">PortQry</td>
<td style="border:1px solid black;">Windows 2000, Windows Server <br />
2003, Windows XP</td>
<td style="border:1px solid black;">Windows Server <br />
2003 Resource Kit</td>
<td style="border:1px solid black;">네트워크 포트 상태 리포팅</td>
<td style="border:1px solid black;"><a href="http://support.microsoft.com/kb/310099">http://support.<br />
microsoft.com/<br />
kb/310099</a></td>
</tr>
<tr class="even">
<td style="border:1px solid black;">NLTest</td>
<td style="border:1px solid black;">Windows 2000, Windows Server <br />
2003, Windows XP</td>
<td style="border:1px solid black;">지원 도구</td>
<td style="border:1px solid black;">트러스트 관계 및 Netlogon 보안 채널 테스트</td>
<td style="border:1px solid black;">Windows Server <br />
2003 Support Tools 도움말</td>
</tr>
<tr class="odd">
<td style="border:1px solid black;">Klist</td>
<td style="border:1px solid black;">Windows 2000, Windows Server <br />
2003, Windows XP</td>
<td style="border:1px solid black;">Windows 2000 및 Windows Server <br />
2003 Resource Kit</td>
<td style="border:1px solid black;">Kerberos 티켓 리포팅</td>
<td style="border:1px solid black;">Windows Server <br />
2003 Resource Kit Tools 도움말</td>
</tr>
<tr class="even">
<td style="border:1px solid black;">Pathping</td>
<td style="border:1px solid black;">Windows 2000, Windows Server <br />
2003, Windows XP</td>
<td style="border:1px solid black;">운영 체제의 일부</td>
<td style="border:1px solid black;">네트워크 연결 및 경로 테스트</td>
<td style="border:1px solid black;">Windows 도움말</td>
</tr>
<tr class="odd">
<td style="border:1px solid black;">LDP</td>
<td style="border:1px solid black;">Windows 2000, Windows Server <br />
2003, Windows XP</td>
<td style="border:1px solid black;">지원 도구</td>
<td style="border:1px solid black;">Active Directory 테스팅용 LDAP 클라이언트</td>
<td style="border:1px solid black;">Windows Server <br />
2003 Support Tools 도움말</td>
</tr>
</tbody>
</table>
 

##### IPsec과 ICMP 기반 도구 사용

Windows XP 및 Windows Server 2003 Ping, Pathping과 Tracert는 IPsec을 인식하지만, 소프트 SA가 구축되기 전에는 제대로 작동하지 않습니다(선택 취소가 허용된 경우). IPsec SA가 이러한 유틸리티에서 사용된 ICMP 트래픽을 성공적으로 캡슐화하도록 협상된 경우 클라이언트와 목표 대상 간 중간 홉(라우터)을 검색할 수 없게 됩니다. Ping 패킷 손실에 대한 계산은 IKE가 성공적으로 대상과 IPsec SA 쌍을 협상하는 데 필요한 시간 동안 손실된 패킷을 보여줄 수 있습니다. 각 중간 홉에 대한 패킷 손실에 대한 계산은 ICMP 트래픽이 IPSec에 의해 캡슐화된 경우에는 사용할 수 없게 됩니다.

이러한 ICMP 유틸리티가 IPsec 드라이버가 아웃바운드 ICMP 에코 요청 패킷에 대한 IPsec 필터가 일치하고 따라서 IKE가 보안을 협상하도록 요청했는지를 검색하도록 제공됩니다. 이러한 상황이 발생하면 "IP 보안을 협상 중입니다."라는 메시지가 유틸리티에 의해 표시됩니다. Windows 2000의 알려진 버그로 인해 Ping 유틸리티는 다음 에코 요청을 다시 시도하기 전에 적절한 기간 동안 대기하지 않을 수 있습니다. 즉, 이는 소프트 SA가 구축될 때 까지 3초 동안 기다리는 대신 명령이 즉시 완료된다는 것을 의미합니다. Windows XP와 Windows Server 2003의 Ping 유틸리티는 다음 에코 요청이 전송되기 전까지 예상되신 시간(초)을 대기합니다.

다음과 같은 상황에는 "IP 보안을 협상 중입니다." 메시지가 표시되지 않습니다.

-   차단 필터로 인해 IPsec 드라이버가 아웃바운드 ICMP 패킷을 손실하는 경우.

-   허용 필터 또는 소프트 SA로 인해 IPsec 드라이버를 통해 ICMP 패킷이 보호되지 않은 채로 통과되는 경우.

-   IPsec 드라이버가 아웃바운드 패킷을 검색하지 못하는 경우(예를 들어, IPsec 드라이버 위치 계층에서 손실되는 경우).

    **참고:** ICMP를 사용하는 일부 도구는 IPsec에서 보안을 협상 중임을 검색할 수 없을 수 있고 일관성이 결여된 오류 있는 결과가 발생할 수 있습니다.

[](#mainsection)[페이지 위쪽](#mainsection)

### IPsec 문제 해결 프로세스

계층 1 지원으로 문제가 분명하게 확인되지 않은 경우, 계층 2 지원은 다음 섹션에서 신속하게 관련 문제 해결 절차를 파악할 수 있게 됩니다. 이 모델에서 계층 1 지원은 주로 클라이언트 기반 액세스 문제를 취급합니다. 서버의 관리 담당자가 기본 네트워크 연결 진단을 수행할 수 있으며 계층 2 지원을 건너뛸 수 있을 것으로 예상됩니다. 하지만, 각 조직은 해당 지원 환경에 맞게 모델을 조정해야 합니다. 계층 2 지원은 통신 오류가 발생하는 지점을 확인한 다음 시스템 아키텍처 상에서 관련 가능성을 조사해야 합니다.

조직에서 문제 해결 프로세스의 일부로 제공된 스크립트를 사용하고 있는 경우 해당 문제를 진단하는 데 사용될 수 있는 수많은 텍스트 로그 파일에 액세스하게 됩니다. 스크립트가 생성하는 파일에 대한 설명은 다음 표에 제공됩니다.

**표 7.3: IPsec\_Debug.vbs 스크립트에서만든파일**

 
<table style="border:1px solid black;">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead>
<tr class="header">
<th style="border:1px solid black;" >파일 이름</th>
<th style="border:1px solid black;" >설명</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="border:1px solid black;"> <CompName>_FileVer.txt</td>
<td style="border:1px solid black;">다양한 IPsec 관련 DLL의 파일 버전을 나타냅니다.</td>
</tr>
<tr class="even">
<td style="border:1px solid black;"> <CompName>_gpresult.txt</td>
<td style="border:1px solid black;">gpresult 명령의 결과</td>
</tr>
<tr class="odd">
<td style="border:1px solid black;"> <CompName>_ipsec_547_events.txt</td>
<td style="border:1px solid black;">보안 이벤트 로그의 IPSEC 547 오류 결과</td>
</tr>
<tr class="even">
<td style="border:1px solid black;"> <CompName>_ipsec_policy_version.txt</td>
<td style="border:1px solid black;">Detect_IPsec_Policy.vbs 스크립트의 결과 대화 상자에 현재 정책 버전과 Active Directory 정책과 일치하는지 여부를 나타냅니다.</td>
</tr>
<tr class="odd">
<td style="border:1px solid black;"> <CompName>_ipseccmd_show_all.txt</td>
<td style="border:1px solid black;">Windows XP에서만 이 파일은 ipseccmd 명령의 결과를 수집합니다.</td>
</tr>
<tr class="even">
<td style="border:1px solid black;"> <CompName>_kerberos_events.txt</td>
<td style="border:1px solid black;">시스템 이벤트 로그의 Kerberos 이벤트 결과</td>
</tr>
<tr class="odd">
<td style="border:1px solid black;"> <CompName>_klist_purge_mt.txt</td>
<td style="border:1px solid black;">시스템 티켓을 제거하는 동안 KList의 결과</td>
</tr>
<tr class="even">
<td style="border:1px solid black;"> <CompName>_lsass.log</td>
<td style="border:1px solid black;">lsass.log 파일을 복사합니다(있는 경우).</td>
</tr>
<tr class="odd">
<td style="border:1px solid black;"> <CompName>_netdiag.txt</td>
<td style="border:1px solid black;">netdiag 실행 결과</td>
</tr>
<tr class="even">
<td style="border:1px solid black;"> <CompName>_netsh_show_all.txt</td>
<td style="border:1px solid black;">서버 플랫폼에서만 netsh에서 모든 명령 표시 결과</td>
</tr>
<tr class="odd">
<td style="border:1px solid black;"> <CompName>_netsh_show_gpo.txt</td>
<td style="border:1px solid black;">서버 플랫폼에서만 netsh에서 gpo 명령 표시 결과</td>
</tr>
<tr class="even">
<td style="border:1px solid black;"> <CompName>_oakley.log</td>
<td style="border:1px solid black;">Oakley.log 파일을 복사합니다(있는 경우).</td>
</tr>
<tr class="odd">
<td style="border:1px solid black;"> <CompName>_OSInfo.txt</td>
<td style="border:1px solid black;">현재 운영 체제 정보의 결과</td>
</tr>
<tr class="even">
<td style="border:1px solid black;"> <CompName>_RegDefault.txt</td>
<td style="border:1px solid black;">변경하기 전에 원본 레지스트리 키 값의 결과 특정한 이유로 스크립트가 실패하는 경우 레지스트리 이전 값 재설정에 사용할 수 있습니다.</td>
</tr>
<tr class="odd">
<td style="border:1px solid black;"> <CompName>_userenv.log</td>
<td style="border:1px solid black;">userenv.log 파일을 복사합니다(있는 경우).</td>
</tr>
<tr class="even">
<td style="border:1px solid black;"> <CompName>_ <SrvName>_netview.txt</td>
<td style="border:1px solid black;"> <SrvName>에 대한 net view 명령의 결과</td>
</tr>
<tr class="odd">
<td style="border:1px solid black;"> <CompName>_ <SrvName>_ping.txt</td>
<td style="border:1px solid black;"> <SrvName>에 대한 ping 명령의 결과</td>
</tr>
<tr class="even">
<td style="border:1px solid black;"> <CompName>_winlogon.log</td>
<td style="border:1px solid black;">winlogon.log 파일을 복사합니다(있는 경우).</td>
</tr>
</tbody>
</table>
  
많은 잠재적 오류 지점이 있기 때문에 이 섹션에서는 네트워크 연결부터 시작하여 각 구조적 구성 요소를 순서대로 해결합니다. 다음 작업을 수행하는 데 도움이 되는 절차가 정의되어 있습니다.
  
-   IP 네트워크 구성, 도메인 컨트롤러와의 네트워크 연결 및 서비스, IPsec 관련 프로토콜의 클라이언트 서버 경로 연결을 확인합니다.
  
-   클라이언트와 서버 양측에서 그룹 정책 및 IPsec 정책이 제대로 적용되었는지 확인합니다.
  
-   IKE 협상과 IPsec 보호 통신과의 문제를 조사합니다.
  
-   필요한 경우 계층 3 문제 제기에 대한 문제의 원인을 확인합니다.  
  
먼저 다음과 같은 시나리오를 고려해 보기로 합니다. 클라이언트에서 서버에 Ping을 실행할 수는 있지만 해당 서버의 파일을 공유할 수는 없는 경우가 있을 수 있습니다. 해당 클라이언트는 이 서버에 대해서만 액세스가 불가능합니다. 이벤트 547(IKE 협상 오류)에 대한 보안 로그(서버 IP 주소 포함)를 검토해 보면 클라이언트에 IPsec 정책이 있고 IKE가 시작 중임을 알 수 있습니다. 클라이언트 이벤트 547이 IKE 협상 시간이 초과되었음을 의미하는 경우 서버 IKE가 협상에 실패했을 가능성이 있습니다. 이제 계층 2 지원에서는 547 이벤트에 대한 MOM 이벤트 데이터베이스를 검토하게 됩니다. 이는 지정된 서버에서 수집된 것으로 현재 클라이언트 IP 주소를 포함하고 있습니다.
  
#### 경고 - IPsec 서비스 시작 및 중지
  
Windows Server 2003 TCP/IP 문제 해결 문서 및 기타 참고 자료에서는 IPsec 서비스를 중단함으로써 IPsec에서 연결 문제를 일으키는지 확인하는 방법을 설명합니다. IPsec 서비스 중지로 컴퓨터에서 IPsec 필터링이 중단하게 되지만 IPsec이 제공하는 보호 기능을 비활성화하고, 컴퓨터를 트러스트되지 않은 네트워크 액세스에 노출시키며 패킷 보호를 비활성화할 수 있습니다. 또한, 도메인 격리 환경에서 IPsec으로 보호되지 않은 TCP와 UDP 트래픽은 다른 격리 도메인 구성원에 의해 손실됩니다. IPsec이 컴퓨터 한 대에서 비활성화된 경우 현재 IPsec 보안 연결이 구축된 원격 컴퓨터의 연결이 중단됩니다. IPsec 서비스가 중단되면, IKE는 모든 IPsec SA와 IKE SA에 대한 삭제 알림을 모든 활성 연결 컴퓨터에 보냅니다. 선택 취소가 허용된 IPsec 정책이 설정된 원격 컴퓨터는 3초 지연 후에 연결을 다시 구축하게 됩니다. 선책 취소가 허용되지 않는 IPsec 정책이 설정된 원격 컴퓨터는 통신할 수 없게 됩니다.
  
따라서, IPsec 서비스를 중단하지 않고 원격 시나리오의 문제를 해결하려면 다음 섹션에 제시된 방법을 사용하는 것이 중요합니다. IPsec 서비스는 다음 상황에 대한 IPsec 관련 문제를 제거하기 위한 마지막 방법으로서만 비활성화되어야 합니다.
  
-   브로드캐스트 및 멀티캐스트 트래픽 환경
  
-   인바운드 액세스에 IPsec을 요청하지 않는 원격 컴퓨터 연결(예를 들어, 예외 목록의 구성원인 컴퓨터)  
  
Windows 2000에서 IPsec 서비스를 중지하면 TCP/IP에서 IPsec 연결이 끊어지고 메모리에서 IPsec 드라이버를 언로드하게 됩니다.
  
Windows XP 및 Windows Server 2003에서 IPsec 서비스를 중지하면 IPsec 드라이버의 모든 필터가 삭제되고 드라이버 모드가 PERMIT으로 설정됩니다. 메모리에서 IPsec 드라이버를 언로드하지 않습니다. IPsec 서비스는 비활성화되고 IPsec 드라이버를 로드하지 않도록 컴퓨터를 다시 시작해야 합니다.
  
Windows 2000 및 Windows XP SP1에서 **Oakley.log** 파일에 대한 IKE 로깅은 IPsec 서비스를 다시 시작해야 합니다. 서비스를 중지하면 Windows XP SP2 및 Windows Server 2003에서 **Oakley.log** 파일에 대한 IKE 로깅을 활성화 및 비활성화하지 않아도 됩니다. Windows XP SP2의 Ipseccmd에 대한 최종 업데이트는 구문  
ipseccmd set logike 및 ipseccmd set dontlogike를 제공하여 동적으로 **Oakley.log** 파일을 활성화 및 비활성화합니다. Windows Server 2003 IKE 로깅은 온라인 도움말에 설명된 Netsh 명령을 사용하여 동적으로 활성화할 수 있습니다.
  
#### 네트워크 연결 확인
  
계층 1 지원에서 가능한 네트워크 연결 문제를 확인한 후의 첫 번째 단계는 기본 네트워크 연결이 있는지 파악하는 것입니다. 이 때 적합한 IP 구성이 사용되고 있는지, 초기자와 응답자 컴퓨터 간에 유효한 네트워크 경로가 있는지 그리고 이름 확인 서비스가 작동되고 있는지 확인해야 합니다.
  
##### 네트워크 IP 주소 구성 문제
  
동적 IP 구성이 성공하지 않거나 컴퓨터를 다시 시작한 후에도(또는 정상적인 작동 상태에서) 통신이 차단된 경우 IPsec이 원인일 수 있습니다. Windows Server 2003에서 그러한 문제는 IPsec 오류 복구 동작(예: 컴퓨터가 안전 모드 또는 Active Directory 복구 모드로 시작된 경우)과 관련될 수 있습니다.
  
**참고:** Windows Server 2003 오류 복구에 대한 자세한 내용은 Windows Server 2003 Deployment Kit, "Deploying IPsec"의 "[Understanding IPSec Protection During Computer Startup](http://www.microsoft.com/technet/prodtechnol/windowsserver2003/library/depkit/10091c6e-fca2-478d-bdae-ddd11d0739c7.mspx)" (영문)(www.microsoft.com/resources/documentation/WindowsServ/2003/all/deployguide/en-us/dnsbj\_ips.asp)을 참조하십시오.
  
Windows Server 2003은 IPsec 서비스가 성공적으로 할당된 정책을 시작하거나 적용할 수 없는 경우 오류 복구 동작을 마지막으로 수단으로 사용합니다. 오류 복구는 IPsec 정책이 컴퓨터에 할당되고 IPsec 서비스가 비활성화되지 않은 경우에만 적용됩니다. 따라서 컴퓨터 연결은 IPsec 드라이버가 도메인 기반 IPsec 정책을 강제로 적용하지 않기 때문에 정상적인 작동 중에 실패할 수 있습니다. 부트 모드 및 영국 구성으로 허용 및 차단되는 트래픽을 확인해야 통신 오류를 설명하기가 쉬울 수 있습니다. 대체 또는 추가 정보를 얻기 위해 다음 구문을 사용하여 명령줄에서 현재 상태를 쿼리할 수 있습니다.
  
```  
    netsh ipsec dynamic show config   
```  
Windows Server 2003의 경우 IPsec 드라이버가 TCP/IP 드라이버로 컴퓨터 시작 시 로드됩니다. 따라서, IPsec 드라이버 오류 복구 동작을 제거하려면 IPsec 서비스는 비활성화되고 컴퓨터가 다시 시작되어야 합니다. 이전에 참조된 IPsec 배포 장에서는 다른 트래픽이 차단된 경우에 서버에 대한 원격 액세스를 가능하게 해 주는 인바운드 RDP(Remote Desktop Protocol)을 제외하기 위해 권장되는 부트 제외 구성이 포함되어 있습니다.
  
서버 및 도메인 격리 솔루션에서 브로드캐스트 트래픽 및 DHCP 트래픽은 동적 IP 구성이 제대로 작동하도록 제외됩니다. 그러나, 예외 목록은 수동으로 유지 관리되므로 오래된 것일 수 있습니다. 컴퓨터가 적합한 DHCP 구성(예: 169.254.x.x이 자동 구성 IP 주소를 사용하는 경우)을 얻을 수 없거나 임대를 갱신하는 데 문제가 있는 경우 IPsec 정책은 적합한 제외 항목이 있는지 검토되어야 합니다. IPsec 서비스 실행 상태에서 Ipconfig를 사용하여 주소를 얻는 데 문제가 없는지 확인합니다.
  
-   DHCP 클라이언트의 경우 명령 창을 열고 pconfig /release 다음에 ipconfig /renew를 실행합니다.
  
주소 구성 문제가 Windows XP SP2 및 Windows Server 2003의 컴퓨터 시작 중에만 발생하는 경우 제외 구성(기본 제외 및 부트 제외)을 검사해야 합니다.
  
##### 이름 확인 문제
  
서버 및 도메인 격리 시나리오에 사용된 IPsec 정책 설계는 이름 확인이 작동하는지 확인하기 위해 사용되는 일반적인 절차와 충돌되어서는 안 됩니다. 예를 들어, Woodgrove 은행 시나리오에서 IPsec 정책 설계에서는 DNS 및 WINS 서버에 대한 모든 트래픽을 제외합니다. 단, 해당 DNS와 WINS 서버는 Ping 요청에 응답하지 않도록 구성할 수 있습니다. IPsec 서비스가 실행 중인 상태에서 이름 확인이 제대로 작동하고 있는지를 확인하려면 다음 질문에 대답하십시오.
  
-   클라이언트가 IP 구성에 있는 DNS 서버 IP 주소를 Ping할 수 있습니까?
  
-   nslookup이 DNS 서버를 찾을 수 있습니까?
  
-   클라이언트가 대상의 정규화된 DNS 이름을 Ping할 수 있습니까?
  
-   클라이언트가 대상의 단축된 DNS 또는 NetBIOS 이름을 Ping할 수 있습니까?
  
이름 확인 문제의 잠재적인 원인에는 활성화되고 잘못 구성된 HOSTS 파일, IP 속성의 잘못 구성된 DNS 서버 항목, 잘못된 DNS 기록 등록, 영역 파일 업데이트 문제, Active Directory 복제 문제, DNS 서버에 사용된 선택 취소 및 DHCP 자동 업데이트 문제가 포함됩니다.
  
NetBIOS 이름 확인 오류의 원인에는 활성화된 잘못 구성된 LMHOSTS 파일, IP 속성의 잘못 구성된 WINDS 서버 항목, WINS 서버 가용성, 잘못된 WINS 레코드, WINS 복제 문제, WINS 프록시 오류 및 WINS 서버에 연결하는 네트워크 시간 초과가 포함됩니다.
  
Active Directory 통합 DNS의 문제 해결 절차에 대한 자세한 내용은 Microsoft.com의 [Troubleshooting Active Directory - Related DNS Problems](http://www.microsoft.com/technet/prodtechnol/windows2000serv/technologies/activedirectory/maintain/opsguide/part1/adogd10.mspx) (영문)(www.microsoft.com/technet/prodtechnol/windows2000serv/technologies/activedirectory/maintain/opsguide/part1/adogd10.mspx) 페이지를 참조하십시오.
  
일부 보안 수준이 높은 환경에서는 IPsec을 사용하여 DNS와 WINS 서버를 보호할 수 있으나 이때는 이름 확인 문제가 발생할 수 있습니다. 예를 들어, DNS는 Active Directory에 통합되어 있으며 IPsec 정책에 동일한 IP 주소에 대한 중복 필터가 있는 경우, 필터 1개는 DNS 서버에 대한 보안을 협상하고 또 다른 필터는 도메인 컨트롤러를 제외할 수 있습니다. 자세한 내용은 이 장 후반부의 "IPsec 정책 문제 해결" 섹션을 참조하십시오.
  
이름 확인 문제가 지속되는 경우 초기자로부터 필터 목록을 받아서 중복 필터를 확인할 수 있습니다. 다음 명령줄 옵션을 사용하여 이 작업에 대한 필터 목록을 확인할 수 있습니다.
  
```  
    Ipseccmd show filters  
    Netsh ipsec static show all   
```  
이름 확인 문제가 지속되는 경우 IPsec 서비스는 이름 확인 테스트가 반복되는 동안 잠시 중지될 수 있습니다. 이름 확인 테스트가 IPsec 서비스 실행 상태에서만 실패하는 경우 이 섹션 후반에 논의되는 것처럼 어떤 IPsec 정책이 적용되고 있는지를 계속해서 확인해야 합니다.
  
##### 도메인 컨트롤러와 연결 및 인증 확인
  
IPsec 정책 구현, IKE 인증 및 가장 상위 계층 프로토콜이 도메인 컨트롤러에 대한 액세스에 따라 다르기 때문에 네트워크 연결 및 성공적인 인증 서비스에 작동에 대한 테스트는 IPsec 특정 문제 해결 단계(다음 섹션에서 설명된)가 수행되기 전에 수행되어야 합니다. Woodgrove 은행과 같은 시나리오에서 IPsec 정책 설계에서는 모든 도메인 컨트롤러에 대한 모든 트래픽을 제외하여 도메인 컨트롤러에 대한 네트워크 연결 테스트는 IPsec의 영향을 받아서는 안 됩니다. 단, 제외 목록의 도메인 컨트롤러 IP 주소 목록은 수동으로 유지 관리되어야 합니다. IKE 협상이 도메인 컨트롤러 IP 주소에 나타나는 경우 IPsec 정책은 잘못 할당되거나 업데이트되지 않을 수 있습니다.
  
**Active Directory의네트워크서비스에대한액세스문제를해결하려면**
  
-   클라이언트가 각 도메인 컨트롤러 IP 주소를 Ping할 수 있는지 확인합니다. Ping할 수 없는 경우 위의 네트워크 연결 단계를 참조하십시오.
  
-   어떤 IP 주소가 도메인 구성원의 도메인 컨트롤러에 사용되고 있는지 확인합니다. nslookup *<도메인이름>*을 사용하여 전체 IP 주소 목록을 반환합니다. 서버 및 도메인 격리 시나리오에서는 이러한 각 주수에 대해 *permit* 의 협상 정책(필터 작업)을 가진 빠른 모드 특정 필터가 있어야 합니다.
  
-   버전 2.0 이후 **portqry.exe** 도구 또는 PortQueryUI 도구를 사용하여 도메인 컨트롤러 UDP, LDAP와 RPC 포트에 대한 액세스를 테스트합니다. portqry에 사용된 UDP 프로토콜 메시지가 일반적으로 상위 계층 프로토콜 인증을 요청하지 않으므로 인증을 사용할 수 없는 경우 서비스 가용성을 확인할 수 있습니다. 이러한 단계에 대한 자세한 내용은 http://support.microsoft.com/?kbid=816103에서 제공되는 [HOW TO: Use Portqry to Troubleshoot Active Directory Connectivity Issues](http://support.microsoft.com/?kbid=816103)를 참조하십시오.
  
-   내부 네트워크에 연결된 경우 netdiag /v >outputfile.txt를 사용하여 대부분의 DNS 관련 및 도메인 컨트롤러 관련 연결 테스트를 수행할 수 있습니다. Netdiag는 여러 네트워크 연결 및 프로토콜을 사용하여 테스트를 수행합니다. 이러한 연결로 IKE 협상이 시작되고 IKE가 Kerberos 인증에 대해 도메인 컨트롤러를 찾을 수 없기 때문에 인증이 실패하는 경우 이벤트 547 오류는 보안 로그에 기록될 수 있습니다.
  
Windows 지원 도구 **klist.exe**는 성공적인 Kerberos 로그인 및 인증을 확인하기 위해 사용할 수 있습니다. Klist는 컴퓨터에 대한 Kerberos 티켓을 확인하기 위해 로컬 시스템 컨텍스트에서 실행되어야 합니다.
  
**도메인서버에로깅된 Kerberos 서비스티켓을확인하려면**
  
-   명령 프롬프트를 열고 다음을 입력합니다.
  
    ```  
        klist tickets   
    ```
  
**도메인컴퓨터티켓을확인하려면**
  
1.  작업 스케줄러가 실행 중이고 로그온한 사용자가 로컬 Administrators 그룹의 구성원인지를 확인합니다.
  
2.  명령줄 프롬프트에 현재 시스템 시간(예: 4:38 pm) 보다 1분 빠른 시간을 선택하고 다음을 입력합니다.
  
    ```  
        at 4:38pm /interactive cmd /k klist tickets   
    ```
  
    명령 창 제목 표시줄에는 **C:\\Windows\\System32\\svchost.exe**가 포함됩니다.
  
Kerberos 티켓에 사용자 또는 컴퓨터용 그룹 정보가 되는 경우에도 이 정보는 해당 그룹이 확인할 수 없도록 암호화됩니다. 따라서 그룹 구성원은 Active Directory의 그룹 구성원을 검사하여 수동으로 확인되어야 합니다. 컴퓨터에 Kerberos 티켓에 최신 그룹 구성원 정보를 가지고 있도록 하려면 klist를 사용하여 현재 Kerberos 티켓을 제거합니다. IKE 협상이 다시 시도되면 새 Kerberos 티켓은 자동으로 획득됩니다.
  
**컴퓨터에대한 Kerberos 티켓을제거하려면**
  
(1-4단계는 로컬 시스템 컨텍스트에서 실행되어야 함)
  
1.  작업 스케줄러가 실행 중이고 로그온한 사용자가 로컬 Administrators 그룹의 구성원인지를 확인합니다.
  
2.  명령줄 프롬프트에 현재 시스템 시간(예: 오후 4:38) 보다 1분 빠른 시간을 선택하고 다음을 입력합니다.
  
    ```  
        at 4:38pm /interactive cmd   
    ```
  
3.  klist purge를 입력하고 각 티켓 유형에 대해 Y 키를 눌러 모든 Kerberos 티켓을 제거합니다.
  
4.  klist tickets를 입력하여 어떠한 티켓도 없음을 확인합니다.
  
5.  이 절차가 IKE 협상 오류 문제 해결의 일부분인 경우 IKE 협상의 시간이 초과될 때까지 1분을 기다린 다음 해당 응용 프로그램으로 다시 대상 서버에 액세스합니다. 새 IKE 주 모드 협상은 최신 그룹 정보가 제공될 대상 컴퓨터에 대한 새 Kerberos TGT와 서비스 티켓을 요청합니다. 로컬 시스템 컨텍스트에서 실행 되는 명령 창에서 해당 응용 프로그램을 실행하지 않도록 주의하십시오.  
  
Kerberos 문제 해결에 대한 보다 자세한 내용은 다음 백서를 참조하십시오.
  
-   [Troubleshooting Kerberos Errors](http://www.microsoft.com/downloads/details.aspx?familyid=7dfeb015-6043-47db-8238-dc7af89c93f1&displaylang=en)(www.microsoft.com/downloads/details.aspx?FamilyID=7dfeb015-6043-47db-8238-dc7af89c93f1&displaylang=en
  
-   [Troubleshooting Kerberos Delegation](http://www.microsoft.com/downloads/details.aspx?familyid=99b0f94f-e28a-4726-bffe-2f64ae2f59a2&displaylang=en))(www.microsoft.com/downloads/details.aspx?FamilyID=99b0f94f-e28a-4726-bffe-2f64ae2f59a2&displaylang=en)
  
##### Active Directory에서 IPsec 정책의 사용 권한 및 무결성 확인
  
Active Directory에서 IPsec 정책 컨테이너에 대한 정보 확인이 필요할 수 있습니다. 다음은 지원 도구 **ldp.exe**를 사용하는 절차입니다.
  
**IPsec 정책컨테이너에대한정보를확인하려면**
  
1.  **시작**, **실행**을 클릭하고 **ldp.exe**를 입력한 다음 Enter 키를 누릅니다.
  
2.  **Connection**을 먼저 선택 후 **Connect**를 선택합니다. 대상 도메인의 이름을 지정합니다.
  
3.  **Connection**을 먼저 선택 후 **Connect**를 선택합니다. 대상 도메인에 대한 로그온 자격 증명을 지정합니다.
  
4.  **View**를 먼저 선택한 후 **Tree**를 선택합니다. 기본 DN 없음을 지정하고 IPsec 정책 컨테이너를 찾거나 기본 위치로서 IPsec 정책 컨테이너에 대해 LDAP DN을 지정합니다.
  
5.  트리 보기의 컨테이너 모드 옆의 **+** 기호를 클릭합니다. 컨테이너에 대한 읽기 권한을 가지고 있는 경우 컨테이너의 모든 IPsec 정책 개체가 표시됩니다.
  
    **참고**: 일부 도메인 사용자는 사용 권한의 구성 방법에 따라 컨테이너에 대해 읽기 권한을 갖지 못할 수 있습니다. 자세한 내용은 http://support.microsoft.com/?kbid=329194에서 제공되는 Microsoft 기술 자료 문서 329194, "[IPSec Policy Permissions in Windows 2000 and Windows Server 2003](http://support.microsoft.com/?kbid=329194)"을 참조하십시오.
  
고급 정책 검색 및 손상 문제의 고급 문제 해결의 경우 **ldp.exe**를 사용하여 수동으로 IP 보안 컨테이너이 내용과 IPsec 정책 개체 간의 관계를 검사할 수 있습니다. Windows 2000, Windows XP, Windows Server 2003은 Windows Server 2003 [How IPsec Works](http://www.microsoft.com/technet/prodtechnol/windowsserver2003/library/techref/8fbd7659-ca23-4320-a350-6890049086bc.mspx) 기술 참조(www.microsoft.com/resources/documentation/WindowsServ/2003/all/techref/en-us/w2k3tr\_ipsec\_how.asp)의 IPsec 정책 구조 다이어그램에 표시된 대로 IPsec 정책에 대해 동일한 기본 디렉터리 체계를 사용합니다.
  
다음 표에는 IPsec 정책 관리 MMC 스냅인에 구성된 Active Directory 개체 이름과 IPsec 정책 구성 요소 이름 간의 관계를 보여 줍니다.
  
**표 7.4: Active Directory 개체이름매핑에대한 IPsec 정책구성요소**

<table style="border:1px solid black;">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead>
<tr class="header">
<th style="border:1px solid black;" >IPsec 정책 구성 요소 이름</th>
<th style="border:1px solid black;" >Active Directory 개체 이름</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="border:1px solid black;">IPSec 정책</td>
<td style="border:1px solid black;">ipsecPolicy{GUID}</td>
</tr>
<tr class="even">
<td style="border:1px solid black;">IKE 정책 키 교환 보안 방법</td>
<td style="border:1px solid black;">ipsecISAKMPPolicy{GUID}</td>
</tr>
<tr class="odd">
<td style="border:1px solid black;">IPsec 규칙</td>
<td style="border:1px solid black;">ipsecNFA{GUID}</td>
</tr>
<tr class="even">
<td style="border:1px solid black;">IPsec 필터 목록</td>
<td style="border:1px solid black;">ipsecFilter{GUID}</td>
</tr>
<tr class="odd">
<td style="border:1px solid black;">IPsec 필터 작업</td>
<td style="border:1px solid black;">ipsecNegotiationPolicy{GUID}</td>
</tr>
</tbody>
</table>
  
**Ldp.exe**는 개체 버전과 복제 문제를 해결하는 데 도움이 될 수 있는 IPsec 정책 개체가 수정된 마지막 시간을 확인하는 기능을 제공합니다. IPsec 서비스에 대한 읽기 권한 문제를 해결하기 위해 로컬 시스템의 컨텍스트로 명령 창에서 실행할 수 있습니다.
  
**주의**: IP 보안 컨테이너의 모든 개체가 동일한 사용 권한을 가지는 것이 좋습니다. Microsoft는 개별 IPsec 정책 개체에 대해 사용 권한을 설정할 것을 권장하지 않습니다. IP 보안 컨테이너에서 관리되어야 하는 IPsec 정책, 권한에 대한 읽기/수정 액세스 제어에 대한 자세한 내용은 http://support.microsoft.com/?kbid=329194에서 제공되는 기술 자료 문서 329194, "[IPSec Policy Permissions in Windows 2000 and Windows Server 2003](http://support.microsoft.com/default.aspx?scid=kb;en-us;329194)"을 참조하십시오.
  
IPsec 정책이 손상되면 흔히 IPsec 객체에 더 이상 유효하지 않은 객체에 대한 DN 참조가 포함되게 되는 상황이 발생합니다. 그러나, 제어 문자가 개체 이름에 속하고, 개별 개체를 사용 권한 문제로 인해 읽을 수 없거나 개체에 대해 동일한 이름이 부적절한 IPsec 정책 설계(예: 두 개의 동일한 필터 목록 버전)를 유도한 경우에 손상이 발생할 수 있습니다. IPsec 정책 손상을 해결하는 방법에 대한 자세한 내용은 다음 "IPsec 서비스" 문제 해결 섹션을 참조하십시오.
  
**참고**: 이러한 개체에 대한 설계의 세부 내용은 Microsoft가 게시하지 않는 내부 비공개 데이터 구조로 여겨집니다. Windows 릴리스에 따라 이러한 객체의 형식이 서로 다를 수 있으며 Microsoft는 언제라도 이를 변경할 수 있습니다. 따라서, 이러한 개체는 각 플랫폼에서 사용할 수 있는 IPsec 정책 관리 MMC 스냅인과 명령줄 도구만 사용해서 관리되어야 합니다. 손상으로 인해 IPsec 정책 관리 MMC 스냅인 또는 명령줄 도구를 사용할 수 없게 되면 최종 옵션으로 LDP를 사용함으로써 개체를 삭제해야 합니다.
  
##### 네트워크 경로 연결
  
Microsoft는 서버 및 도메인 격리 솔루션에서 ICMP 프로토콜을 제외할 것을 권장합니다. 이런 권장 사항에는 Ping, Pathping 및 Tracert와 같은 유틸리티를 사용한 네트워크 경로 테스트에 ICMP를 사용해야 할 필요성을 포함하여 몇 가지 이유가 있습니다. 따라서, 이러한 유틸리티가 제대로 작동하여 "IP 보안을 협상 중입니다." 메시지를 표시하지 않아야 합니다. 이러한 메시지가 나타나면 부적합한 IPsec 정책이 할당되었을 수 있습니다.
  
**문제가기본네트워크구성또는경로연결과관련되어있는지확인하려면**
  
-   클라이언트가 자체 IP 주소 또는 로컬 루프백 주소 127.0.0.1을 Ping할 수 있습니까? 만약 Ping을 실행할 수 없다면 TCP/IP 구성에 문제가 있는 경우, 타사 방화벽을 설치한 경우, Ping 유틸리티가 없거나 IP 구성이 잘못된 경우일 수 있습니다. 기타 TCP/IP 구성 문제 해결 절차를 사용하여 조사하십시오.
  
-   클라이언트가 IP 구성에 표시된 기본 게이트웨이를 Ping할 수 있습니까? 만약 Ping을 실행할 수 없다면 클라이언트 IP 구성 문제인 경우, 로컬 인터페이스가 연결되지 않았거나 연결이 제한적인 경우, 로컬 또는 네트워크 필터에서 트래픽을 차단한 경우 또는 기본 게이트웨이의 네트워크 경로가 차단된 경우일 수 있습니다. 기타 TCP/IP 문제 해결 절차를 사용하여 조사하십시오.
  
-   클라이언트가 IP 구성에 표시된 DNS 서버를 Ping할 수 있습니까? 만약 Ping을 실행할 수 없다면 DNS 서버 자체에서 ICMP 에코 요청 메시지 수신을 허용하지 않거나 IPsec 정책에서 적절한 DNS 서버 IP 주소를 제외하지 않았거나 이미 언급했던 문제가 있을 수 있습니다. 기타 TCP/IP 문제 해결 절차를 사용하여 조사하십시오.
  
-   클라이언트가 DC와 같은 제외 목록의 IP 주소를 Ping할 수 있습니까? 만약 Ping을 실행할 수 없다면 IPsec에서 문제를 일으킨 것이 아니며 IPsec에 제외된 해당 IP 주소에 대한 필터가 설정되지 않은 경우입니다. 후자는 필터 구성을 검색하여 확인할 수 있습니다. 이 장 후반에서 다음 IPsec 정책 섹션을 참조하십시오.
  
-   클라이언트가 목표 대상의 IP 주소를 Ping할 수 있습니까? 만약 Ping을 실행할 수 있다면 IPsec이 없는 기본 네트워크 연결이 클라이언트와 목표 간에 구성된 경우입니다. 만약 Ping을 실행할 수 없다면 네트워크 경로가 유효한 범위를 확인하기 위해 대상이나 기타 다른 대상 IP 주소에 대해 tracert를 시도하십시오. 기타 TCP/IP 및 주요 네트워크 문제 해결 절차를 사용하여 조사하십시오.
  
경로 연결 테스트가 ICMP에 통과할 수 있지만, IKE 또는 IPsec 프로토콜을 사용해서는 통과할 수 없습니다. 특히, Kerberos 티켓이 포함된 IKE 주 모드의 인증 패킷의 IPsec 오버헤드는 조각화가 필요한 대상 IP 주소에 대한 PMTU보다 더 큰 경우가 있습니다. 따라서, 호스트 기반 방화벽, 라우터 필터링, 네트워크 방화벽 및 대상 호스트의 필터는 다음 프로토콜과 포트에 개방되어 조각화를 지원해야 합니다.
  
-   **IKE**. UDP 원본 포트 500, 대상 포트 500 및 조각
  
-   **IKE/IPsec NAT-T**. UDP 원본 포트 4500, 대상 포트 4500
  
-   **IPsec ESP**. IP 프로토콜 50 및 조각
  
-   **IPsec AH**. IP 프로토콜 51 및 조각
  
###### 경로의 상태 저장 필터링은 권장되지 않음
  
상태 저장 필터링은 상태가 일반적으로 활동 시간 제한에 기반하기 때문에 IKE, AH 및 ESP에 대한 연결 문제를 유발할 수 있습니다. 장치에서는 이러한 메시지가 IKE로 암호화되었기 때문에 IPsec SA가 삭제된 시기를 확인하기 위해 IKE 트래픽을 검사할 수 없습니다. IKE가 다른 방향으로 재지정할 수 있어야 한다는 것은 삭제 메시지가 다른 방향으로 전송될 수 있다는 것을 의미합니다. 한 측이 삭제 메시지를 받지 못하는 경우 피어가 더 이상 인식하지 못하고 피어를 사용하는 해당 패킷을 무시하는 경우에 IPsec SA 쌍이 있다는 것으로 생각할 수 있습니다. IKE가 재지정되는 방향은 바이트 기반 수명이 더욱 빠르게 만료되는 트래픽 흐름의 방향, 시간 기반 주기 만료 시 작은 오프셋 및 유휴 IPsec SA가 삭제된 후 패킷 흐름 방향에 따릅니다. Windows 방화벽을 통해 연결 및 IKE 협상을 시작하는 클라이언트의 IKE 트래픽의 호스트 기반 상태 저장 필터링에서는 문제가 발생하지 않습니다. IPsec 드라이버가 방화벽 필터링이 수행되는 계층보다 낮은 계층에서 패킷을 처리하는 Windows 방화벽이 IPsec 패킷을 필터링하지 않습니다. 그러나, IKE 포트는 방화벽을 통해 허용된 상위 계층 프로토콜 연결에 대해 들어오는 IKE 협상을 수신하기 위해 호스트 방화벽에서 개방되도록 구성되어야 합니다(예: SMB Protocol Over TCP 포트 445를 사용하는 파일 경우).
  
###### TCP에서 요구되는 ICMP PMTU 지원
  
Windows 2000 이후 릴리스의 기본 설정은 각 TCP 패킷의 IP 헤더에 **Don't Fragment** 비트 집합을 가지고 있습니다. 이 설정은 패킷의 보안을 유지하기 위해 AH 또는 ESP IPsec 전송 모드가 사용되는 경우 유지됩니다. 따라서, 너무 큰 패킷은 라우터에서 손실되어 라우터는 최대 허용 크기를 지정하는 **ICMP Destination Unreachable** 메시지를 반환해야 합니다. 이 동작은 TCP Path MTU Discovery라고 합니다. 클라이언트와 대상 컴퓨터 모두 너무나 큰 IPsec 패킷에 대해 ICMP PMTU 메시지를 수신할 수 있어야 합니다. 하드웨어 가속이 일반적으로 조각화된 패킷을 처리하지 않기 때문에 IPsec 보호 트래픽이 조각화를 피하는 것이 특히 중요합니다. 조각화된 Ipsec 패킷은 소프트웨어의 IPsec 드라이버로 처리되어야 합니다.
  
Windows 2000과 Windows XP는 NAT 통과 캡슐화(UDP 포트 4500)를 사용하는 IPsec 전송 모드 패킷에 대한 ICMP PMTU 검색 프로세스를 지원하지 않습니다. Windows Server 2003은 이러한 검색 프로세스를 지원하지 않습니다. PMTU 검색 없이 작동하기 위한 옵션 및 도구에 대한 자세한 내용은 Windows Server 2003 온라인 설명서의 "[TCP/IP Troubleshooting](http://www.microsoft.com/resources/documentation/windows/2000/server/reskit/en-us/cnet/cnbd_trb_gdhe.asp) (영문)" 섹션의 "Troubleshooting Translational Bridging" 페이지(www.microsoft.com/resources/documentation/Windows/2000/server/reskit/en-us/cnet/cnbd\_trb\_gdhe.asp)를 참조하십시오.
  
**참고:** IPsec UDP-ESP 연결이 NAT 외부의 호스트에서 시작되어 NAT 배후에 이르는 NAT 통과 시나리오에서 트래픽의 보안을 유지하려면 IPsec에 대해 TCP PMTU 검색을 활성화해야 하는 알려진 문제가 있습니다. 이 시나리오가 필요한 경우 다음 레지스트리 키를 정의하지 않거나 양 측에서 1로 설정함으로써 TCP PMTU 검색을 활성화하십시오  
**HKEY\_LOCAL\_MACHINE\\System\\CurrentControlSet\\Services\\Tcpip\\    Parameters\\EnablePMTUDiscovery=1**
(이 키는 둘 이상의 줄로 표시될 수 있지만 레지스트리에서는 한 줄임)The Microsoft Windows Server 2003 구성원 서버 기본 보안 템플릿과 기타 타사 구성에서 TCP PMTU를 비활성화하도록 이 레지스트리 키를 구성할 수 있습니다.
  
###### 조각화에 필요한 지원
  
네트워크 경로와 필터는 IKE, IPsec, AH 및 ESP 프로토콜에 대한 조각 통과를 지원해야 합니다. IKE는 UDP 패킷을 사용하여 필요에 따라 조각화되도록 할 수 있습니다. IPsec NAT 통과 구현은 IKE가 인증서로 인증하는 경우(예: L2TP/IPsec VPN 시나리오)에만 IKE 조각화 방지를 추가 지원합니다. Kerberos를 사용하는 IKE 인증은 조각화 방지를 지원하지 않고 Kerberos 티켓이 포함된 조각화된 UDP 패킷을 보내고 받을 수 있어야 합니다.
  
네트워크 경로는 IPsec이 IP 계층에서 아웃바운드 조각화 전에 전체 원본 IP 패킷을 보안하기 때문에 AH와 ESP에 대한 조각 통과를 지원해야 합니다. IPsec은 TCP와 통합되어 TCP 패킷이 DF(Don’t Fragment) 플래그가 설정(기본 설정)되어 있는 경우 TCP는 IPsec 캡슐화로 추가된 추가 바이트를 수용할 수 있는 정도로 패킷 크기를 줄일 수 있습니다.
  
IPsec은 UDP에 통합되어 있지 않고 UDP 응용 프로그램은 IPsec이 트래픽을 보호하는 경우 검색할 방법을 가지고 있지 않습니다. 따라서, IPsec AH 또는 ESP가 적용되면 전체 MTU 크기를 사용하는 UDP 패킷은 전송 시 호스트에 의해 조각화됩니다. 이와 유사하게, IPsec 정책 필터가 ICMP를 제외하지 않는 경우 Ping 유틸리티를 사용하면 온라인상에서 조각화된 IPsec AH 또는 ESP로 나타나는 ICMP 패킷이 생성될 수 있습니다.
  
자세한 내용은 http://support.microsoft.com/?kbid=233256Microsoft에서 제공되는 기술 자료 문서 233256, "[How to Enable IPSec Traffic Through a Firewall](http://support.microsoft.com/?kbid=233256)"을 참조하십시오.
  
###### 브로드캐스트 또는 멀티캐스트 트래픽에 필요한 지원
  
서버 및 도메인 격리의 IPsec 정책 설계는 임의  <-> 서브넷에서 필터를 사용합니다. 따라서, 아웃바운드 필터 서브넷-> 임의는 내부 서브넷 IP 주소를 사용하여 호스트에서 전송된 아웃바운드 브로드캐스트와 멀티캐스트 트래픽을 일치시킵니다. 단, IPsec이 멀티캐스트 또는 브로드캐스트 트래픽의 보안을 유지할 수 없기 때문에 필터와 일치하는 트래픽은 취소해야 합니다. 인바운드 멀티캐스트와 대부분의 브로드캐스트 유형은 해당 임의 -> 서브넷 인바운드 필터와 일치하지 않습니다. 멀티캐스트 또는 브로드캐스트 트래픽이 필요한 경우 레지스트리 키를 **NoDefaultExempt=1**로 설정할 수 있습니다. 이 키를 통해 멀티캐스트와 브로드캐스트 트래픽이 Windows XP 및 Windows Server 2003의 IPsec 필터링을 우회하게 할 수 있습니다. 이러한 구성으로 멀티캐스트 트래픽을 사용하는 RTC(Real Time Communications) 클라이언트 및 Windows Media Server의 알려진 문제를 방지할 수 있습니다. **NoDefaultExempt** 레지스트리 키의 사용 및 보안에 미치는 영향에 대한 자세한 내용은 다음 기술 자료 문서를 참조하십시오.
  
-   810207 - [IPSec default exemptions are removed in Windows Server 2003](http://support.microsoft.com/default.aspx?scid=kb;en-us;810207)(http://support.microsoft.com/?kbid=810207)
  
-   811832 - [IPSec Default Exemptions Can Be Used to Bypass IPsec Protection in Some Scenarios](http://support.microsoft.com/default.aspx?scid=kb;en-us;811832)(http://support.microsoft.com/?kbid=811832)
  
    **참고:** Windows XP SP2는 Windows Server 2003과 동일한 기본 제외 항목을 사용합니다.
  
레지스트리 키는 모든 플랫폼에 적합하게 기본 제외 목록을 제어하도록 설정할 수 있습니다. IPsec 필터링은 특정 브로드캐스트 또는 멀티캐스트 주소에 대상 주소 구성을 지원하지 않습니다.
  
###### 네트워크 장비의 진단이 유용하지 않을 수 있음
  
IPsec 캡슐화의 영향 중 하나는 TCP/IP 트래픽을 일반 텍스트로 간주하는 응용 프로그램에서는 더 이상 네트워크 트래픽을 검사할 수 없다는 점입니다. TCP와 UDP에 기반한 보고서를 검사 또는 제공하는 네트워크 진단 도구는 AH 또는 ESP 암호화가 사용되지 않는 경우에도 IPsec 캡슐화 패킷을 중단하려 하지 않습니다. 이러한 도구를 업데이트하려면 공급업체에서 IPsec AH 또는 ESP Null 패킷을 검사해야 합니다.
  
##### 네트워크 인터페이스 카드 및 드라이버 문제
  
IPsec 패킷 손실이 특별한 기능을 수행하는 NIC(네트워크 인터페이스 카드)로부터 발생할 수 있습니다. 클러스터링 또는 "팀 구성"을 수행하는 카드는 IPsec 호환성에 대해 테스트를 받아야 합니다. 비 IPsec 기능을 가속화하는 NIC 카드는 IPsec 보호 트래픽에 문제가 있을 수 있습니다. TCP 기능을 가속화하는 NIC는 대용량 TCP 데이터 버퍼(대량 전송 오프로드)를 효율적으로 전송할 수 있는 기능뿐만 아니라 TCP 체크섬 계산 및 유효성 검증(체크섬 오프로드)을 지원할 수 있습니다. Windows 2000 이후 릴리스는 IPsec이 허용 및 차단 기능을 수행하는 경우에는 IPsec 드라이버에 필터가 있는 경우 TCP/IP 스택에서 이러한 오프로드 기능을 자동으로 해제합니다. WHQL(Windows Hardware Quality Lab)의 인증과 서명을 받지 못한 네트워크 카드 드라이버에서 트래픽 보호를 위해 IPsec을 사용하는 경우 문제가 발생할 수 있습니다. WHQL에서는 광범위한 테스트 집합을 사용하여 IPsec 오프로드를 지원하기 위해 제작된 NIC 드라이버를 인증합니다. 문제 해결을 지원하기 위해 Windows 2000, Windows XP 및 Windows Server 2003 TCP/IP 스택은 모든 형식의 TCP/IP 오프로드를 비활성화할 수 있는 레지스트리 키 옵션을 지원합니다. 일부 NIC 드라이버도 네트워크 연결의 고급 속성을 사용하여 오프로드를 비활성화할 수 있는 기능을 지원합니다. 드라이버 수준의 구성 변경 사항이 적용되려면 컴퓨터를 다시 시작해야 합니다.
  
##### IPsec 프로토콜의 패킷 손실 문제 해결
  
패킷은 취소 또는 손실되어 응용 프로그램 연결에 영향을 줄 수 있습니다. 이 섹션에서는 패킷이 IPsec에서 취소되는 일반적인 경우를 확인합니다. 앞서 언급한 것처럼 특정 네트워크 장치는 IP 프로토콜 유형 50 또는 51 또는 UDP 포트 500 또는 4500가 통과를 허용하지 않을 수 있습니다. 마찬가지로 IPsec 캡슐화 패킷으로 인해 일부 패킷이 조각화되고 네트워크를 통과할 수 없게 될 수 있습니다. 그러한 경우에, 전송 및 수신되는 패킷을 확인하고 서로 연관시키기 위해 해당 통신의 양측 모두에서 네트워크 모니터 추적이 일반적으로 필요합니다. 반복적으로 나타나는 동일한 패킷 크기로 표시된 재전송을 살펴 보십시오. IPsec이 없는 일반적인 프로토콜 동작을 캡처하고 IPsec 보호 트래픽의 프로토콜 동작과 비교해야 합니다.
  
###### 이벤트 오류 4285
  
**이벤트타이틀: 해시인증실패**
  
IKE와 IPsec은 네트워크를 전환하는 동안 패킷 수정에 대한 보호를 제공해야 합니다. 장치가 무결성 해시로 보호되는 패킷 일부를 수정하는 경우 수신 IKE 또는 IPsec 드라이버는 이 패킷을 취소하고 시스템 로그에 이벤트 4285로 기록되는 Hash Authentication Failure 오류가 발생합니다. 경험을 통해 일부 장치, 네트워크 드라이버 및 타사 패킷 프로세서는 일정한 수의 조각, 일정한 프로토콜 유형 또는 특정 상황(장치가 혼잡하고, 트래픽을 모니터링하거나 다시 부팅하는 등)의 일정한 크기의 패킷을 손상시키는 경우가 있습니다. 이러한 오류는 악의적인 응용 프로그램 또는 보호 상태를 인식하지 못한 응용 프로그램에 의해 패킷에 대한 공격을 나타낼 수 있습니다. 이 오류는 DoS(서비스 거부)를 나타내는 것일 수 있습니다.
  
손상된 패킷의 IPsec 패킷 취소를 검색하려면 다음 방법을 사용할 수 있습니다. 그러나, 이러한 손상의 원인을 발견할 수 있도록 이러한 관찰 내용과 네트워크 모니터 추적의 연관성을 찾아 내는 것도 중요합니다.
  
-   **IPsec Packets Not Authenticated** 카운터를 조사합니다. Windows Server 2003에서 이 카운터는 성능 카운터의 IPsec 카운터를 사용하거나, 명령을 사용하거나 IP 보안 모니터 MMC 스냅인의 통계를 검토하여 확인할 수 있습니다.
  
    ```  
        netsh ipsec dynamic show stats   
    ```  
    Windows XP에서 이 카운터는 명령을 사용하거나  
    
    ```  
        ipseccmd show stats  
    ```  
    **IP 보안 모니터 MMC 스냅인의 통계를 검토하여 확인할 수 있습니다. Windows 2000에서는 이 카운터가 ipsecmon.exe** 그래픽 디스플레이에 나타나거나  

    ```  
        netdiag /test:ipsec /v  
    ``` 

    명령을 사용하면 나타납니다.
  
-   IPsec 드라이버 로깅을 활성화하여 원본 IPsec에서 시스템 로그의 이벤트 4285를 확인합니다. IPsec 드라이버 로깅 활성화 방법에 대한 자세한 내용은 이 장의 "도구 키트" 섹션을 참조하십시오. 이벤트 텍스트는 다음과 같이 나타납니다.
  
    Failed to authenticate the hash for 5 packet(s) received from 192.168.0.10. 일시적인 오류일 수 있으나, 지속되는 경우 이 시스템에서 IPsec 정책 에이전트 서비스를 중지한 다음 다시 시작하십시오.   
  
이벤트 텍스트는 IPsec 서비스를 다시 시작하면 문제를 해결할 수 있지만, 대부분의 패킷 손실 문제의 원인은 IPsec 시스템이 아닐 수 있음을 나타냅니다. 서비스를 다시 시작해도 문제가 해결되지 않으며 더 많은 문제가 발생할 수 있습니다. 문제의 원인이 IPsec 관련 문제인지를 확인하기 위한 최후의 수단으로서만 IPsec 서비스를 중단해야 합니다.
  
이러한 오류를 확인하려면 원본 IP 주소, 시간, 어댑터 또는 오류가 발생하는 상황의 패턴을 확인하기 위해 조사해야 합니다. 패킷의 수가 적으면 이 오류를 조사할 필요는 없습니다. 로컬 시스템에서 손상의 원인을 제거한 후 시작하는 것이 중요합니다. IPsec 오프로드를 비활성화하고, 고급 속성에서 제공되는 구성을 사용하여 고급 또는 성능 기능을 비활성화하고 공급업체가 제공하는 최신 NIC 드라이버, 특히 Windows Hardware Quality Lab에서 인증하고 서명한 드라이버를 사용해 보십시오. 그런 다음, 패킷이 전송되는 네트워크 경로의 특징을 조사하십시오. TCP/IP 패킷 취소 통계와 동일한 구성을 사용하는 다른 컴퓨터에서 패킷 손상의 다른 증거를 찾으십시오. **Datagrams Received Discarded**의 IP 카운터는 IPsec이 패킷을 취소할 때마다 올라갑니다.
  
**참고:** TCP/IP 오프로드 기능을 비활성화하려면 Windows 2000, Windows XP 또는 Windows Server 2003이 실행되는 컴퓨터에 다음 레지스트리 키를 사용하십시오.  

**HKEY\_LOCAL\_MACHINE\\System\\CurrentControlSet\\Services\\IPSEC\\**  
**EnableOffload DWORD 레지스트리값을 0으로**  

 (이 키는 둘 이상의 줄로 표시될 수 있지만 레지스트리에서는 한 줄임)  
그런 다음 컴퓨터를 다시 시작합니다.
  
###### 이벤트 오류 4268
  
**이벤트제목: 잘못된보안매개변수색인(SPI)과함께수신된패킷**
  
Windows 2000과 Windows XP(SP1 포함)의 IKE 구현에는 특정 상황에서 패킷이 손실되는 알려진 문제가 있습니다. 이 문제는 Windows Server 2003 및 Windows XP SP2에서 해결되었습니다. 상위 계층 프로토콜 통신의 영향은 프로토콜이 이미 다양한 이유로 일부 패킷 손실이 발생한다는 사실이 알려져 있기 때문에 일반적으로 무시할 수 있습니다. 이 문제는 다음과 같은 경우일 수 있습니다.
  
-   느리지만 일관된 불량 SPI 카운터 값 증가
  
-   시스템 로그 이벤트 4268 메시지(활성화된 경우) 기본적으로 Windows 2000는 이러한 메시지를 시스템 로그에 이벤트 4268로 기록합니다. Windows XP는 기본적으로 이 이벤트를 기록하지 않지만 드라이버 로깅은 활성화되어 있어야 합니다. 이벤트 텍스트는 다음과 유사합니다.
  
    "Received  <number> packet(s) with a bad Security Parameters Index from  <ip address>. 오류가 계속되면 이 시스템에서 IPsec 정책 에이전트 서비스를 중지한 다음 다시 시작하십시오.   
  
이벤트 텍스트에서는 문제를 해결하려면 IPsec 서비스를 다시 시작할 것을 제안하지만 이러한 유형의 패킷 손실의 원인은 IPsec 시스템의 설계가 문제입니다. 서비스를 다시 시작해도 문제가 해결되지 않으며 더 많은 문제가 발생할 수 있습니다. 앞서 언급한 것처럼 문제의 원인이 IPsec 관련 문제인지를 확인하기 위한 최후의 수단으로서만 IPsec 서비스를 중단해야 합니다.
  
IPsec 보안 매개 변수 색인(SPI)은 보안 연결이 패킷을 처리하기 위해 사용되어야 한다는 것을 응답자에게 알려 주는 패킷의 레이블입니다. SPI가 인식되지 않은 경우 "불량 SPI"로 나타납니다.  이 오류는 수신 컴퓨터가 패킷을 처리한 IPsec SA가 없는 경우 수신된 IPsec 포맷 패킷을 수신했음을 나타냅니다. 따라서, 해당 패킷을 취소해야 합니다.
  
패킷이 취소될 수 있을지라도 사소한 오류 메시지입니다. 생성된 불량 SPI 이벤트의 수는 컴퓨터의 사용 정도 및 재지정 시 IPsec 보호 데이터의 전송 속도에 따라 다릅니다. 다음 상황은 이러한 이벤트를 더 많이 생성할 수 있습니다.
  
-   1기가비트 이상의 연결에서 IPsec 트래픽을 대량 전송하는 경우.
  
-   부하가 높은(느린) 서버와 빠른 클라이언트가 있는 경우
  
-   빠는 서버와 통신하는 느린 클라이언트가 있는 경우
  
-   IKE가 많은 클라이언트와 동시에 재지정하게 하는 서버에 대해 많은 활성 클라이언트가 있는 경우  
  
이로써 IPsec 보호 TCP 연결이 손실된 데이터를 다시 전송하기 위해 몇 초씩 느려질 수 있습니다. 일부 패킷이 손실되는 경우 TCP는 해당 연결을 위해 혼잡 방지 모드를 시작할 수 있습니다. 몇 초 안에 완전한 속도로 연결이 다시 이루어져야 합니다. 파일 복사, 단말기 서버 및 기타 TCP 기반 응용 프로그램은 이러한 몇 개의 손실된 패킷을 알아 채지 못합니다. 단, TCP가 고속 링크에서 패킷 버스트를 손실해서 연결을 다시 설정해야 하는 경우에 나타납니다. 연결이 다시 설정되면 소켓은 종료되고 응용 프로그램은 파일 전송을 중단시킬 수 있는 연결 중단을 통보 받습니다.
  
이러한 오류의 일반적인 원인은 IKE가 IPsec SA 키 입력을 동기화하는 방법과 관련된 Windows 2000의 알려진 문제입니다. IKE 빠른 모드 초기자가 응답자보다 빠른 경우 초기자는 새로운 IPsec 보안 패킷을 응답자가 수신할 준비하는 것보다 더 빠르게 전송할 수 있습니다. IETF(Internet Engineering Task Force) RFC(IPsec Requests for Comment)에 명시된 것처럼 IKE가 새 IPsec 보안 연결 쌍을 구축하는 경우 초기자는 새 아웃바운드 IPsec SA를 사용하여 데이터를 전송하고 느려진 응답자는 아직 인식되지 않은 IPsec 보호 트래픽을 수신합니다. IKE 키 재지정이 경과된 시간과 IPsec SA 보호 하에서 전송된 데이터 양 모두에 의존하기 때문에 불량 SPI 이벤트는 반드시 일정한 간격은 아닐지라도 정기적으로 나타날 수 있습니다
  
타사 상호 운용성 시나리오에서 불량 SPI 오류는 IPsec 피어가 삭제 오류를 수용하여 처리하지 않았거나 IKE 빠른 모드 협상의 마지막 단계를 완료하지 못하는 문제를 나타낼 수 있습니다. 이 오류는 또한 공격자가 컴퓨터에 스푸핑 또는 주입된 IPsec 패킷으로 컴퓨터를 플러딩하고 있음을 나타낼 수도 있습니다. IPsec 드라이버는 이러한 오류를 카운트하여 불량한 SPI 활동을 보관하기 위해 기록합니다.
  
**LogInterval** 레지스트리 키는 이러한 이벤트를 조사하여 취소하는 데 사용될 수 있습니다. 문제 해결 시 최소 값(60초 간격)으로 설정하여 이벤트가 신속하게 등록되도록 합니다. Windows 2000의 경우 IPsec 정책 에이전트 서비스를 중지한 후 다시 시작하여 IPsec 드라이버를 다시 로드할 수 있습니다. Windows XP 및 Windows Server 2003의 경우 컴퓨터를 다시 시작해야 TCP/IP 및 IPsec 드라이버를 다시 로드할 수 있습니다.
  
Windows 2000의 경우 이러한 이벤트는 현재 레지스트리 키 설정 또는 패치로 제거할 수 없습니다. Windows XP 및 Windows Server 2003의 기본 설정은 이러한 이벤트를 보고하지 않는 것입니다. 이러한 이벤트를 보고하려면 netsh ipsec 명령줄 옵션 또는 레지스트리 키를 통해 직접 IPsecDiagnostics 구성을 사용하여 활성화•••••••••••••••••••••  수 있습니다.
  
다음 방법을 사용하여 이러한 오류를 최소화할 수 있습니다.
  
-   IPsec 정책 설정을 조정합니다. 빠른 모드 주기를 21시간 또는 24시간(유휴 IPsec SA가 사용되지 않는 경우 5분 단위로 삭제)으로 늘립니다(보안 요구 사항이 허용하는 경우). 동일한 키를 사용하여 너무 많은 데이터를 암호화함으로써 발생할 수 있는 보안 취약점을 방지하기 위해 ESP 암호화를 사용하는 경우에는 100MB 이상의 주기를 설정해서는 안 됩니다.
  
-   기본 또는 빠른 모드 전달 완전 보안(PFS)을 사용하여 이 문제가 협상되지 않은 특정 IPsec SA에 대해 발생하지 않도록 합니다. 단, 설정으로 인해 많은 클라이언트를 서비스하는 컴퓨터에 대한 부하가 상당히 증가하게 되어 다른 협상에 대한 응답을 지연시킬 수 있습니다.
  
-   CPU 또는 기타 하드웨어를 추가하여 성능을 높이거나 응용 프로그램 부하를 줄입니다.
  
-   이미 설치되지 않은 경우 IP 하드웨어 가속 NIC를 설치합니다. 이러한 카드는 IPsec이 높은 처리량 데이터 전송에 사용한 CPU 사용률을 상당히 줄여줍니다.
  
-   CPU 사용률이 높게 유지되는 경½½우 Diffie-Hellman 계산 속도를 높이기 위한 하드웨어 가속기 제품의 사용을 검토하십시오. 이러한 제품은 일반적으로 Diffie-Hellman 계산 속도를 가속화하는 Diffie-Hellman 지수화 오프로드 기능이 있는 PCI 카드입니다. 가속화가 되면 SSL(Secure Sockets Layer) 프로토콜을 사용하는 인증서의 공개 및 개인 키 작업에도 이점을 제공합니다. 제공업체에 "ModExpoOffload interface in CAPI for Diffie-Hellman calculations"를 지원하는 카드가 있는지 확인하십시오.
  
-   가능한 경우, IPsec 보호(예: 전용 LAN 상의 서버 백업 트래픽)가 필요하지 않은 고속 트래픽을 허용하는 필터를 만드십시오.
  
이러한 옵션이 작동하지 않고 Windows XP SP2 또는 Windows Server 2003 업그레이드가 가능하지 않은 경우 Microsoft 기술 지원 서비스에 현재 사용 가능한 옵션이 있는지 문의하십시오.
  
###### 이벤트 오류 4284
  
**이벤트제목: 보안이유지되야할안전한패킷**
  
이 이벤트는 IPsec 보안 연결이 패킷이 IPsec 보안 연결 내부에 있어야 하는 일반 텍스트로 수신되는 경우에 구축되었음을 나타냅니다. 이러한 패킷은 취소되어 IPsec 보안 연결에 대한 패킷 주입 공격을 방지합니다. **Datagrams Received Discarded**에 대한 IP 카운터가 증가해도 IPsec은 이러한 이유로 손실된 패킷을 기록하는 카운터는 가지고 있지 않습니다. 이러한 문제는 다음과 같이 나타나는 시스템 로그 오류 이벤트 4284에서만 확인할 수 있습니다.
  
"Received  <number> packet(s) in the clear from  <IP address> which should have been secured.
  
오류가 계속되는 경우 이 시스템에서 IPsec 정책 에이전트 서비스를 중지한 다음 다시 시작하십시오.
  
이전 오류에 대한 이벤트 제안 사항을 따라서는 안 됩니다. IPsec 서비스를 다시 시작해도 오류가 수정될 가능성은 없습니다.
  
가장 가능성이 있는 오류의 원인은 정책 구성 문제일 수 있습니다. 즉, 보다 구체적인 아웃바운드 허용 필터로 인해 한쪽에서 안전한 트래픽을 전송하는 경우 문제가 발생할 수 있습니다. 예를 들어, 클라이언트에 서버와 관련한 모든 트래픽의 보안을 유지하는 필터가 있고 서버 정책에서 일반 텍스트 HTTP 응답을 허용하는 보다 구체적인 필터가 있는 경우, 서버에서는 아웃바운드 HTTP 패킷을 제외한 모든 클라이언트 트래픽에 보안을 유지합니다. 클라이언트에서는 이러한 패킷을 수신하지만 보안상의 이유로 무시합니다. 클라이언트에서는 서버로 또는 서버에서 전송되는 모든 트래픽이 IPsec SA 쌍 내부 보안이 유지될 것으로 기대하기 때문입니다.
  
이 이벤트는 두 컴퓨터 간 트래픽이 전송되지만 피어 하나에서 IPsec 보안 연결 또는 IPsec 드라이버의 필터를 삭제하게 되는 타사 클라이언트 상호 운영에서 발생하며 정상 운영 시에도 발생할 수 있습니다. 예를 들어, 한 측은 IPsec 정책 할당을 취소하거나 IPsec SA 및 필터를 제거하는 정책 업데이트가 발생할 수 있습니다. 한 측의 피어가 활성 상태의 상위 레벨 프로토콜 통신이 발생하는 동안 이미 필터를 제거했기 때문에 IKE 삭제 메시지는 도착하여 오류를 유발하는 일반 텍스트 패킷이 도착하기 적에 다른 피어에 의해 처리되지 않을 수 있습니다. 또한, 삭제 메시지를 처리하는 데 걸리는 시간은 피어 컴퓨터의 현재 부하에 따라 다릅니다.
  
이러한 오류 메시지는 IPsec 보안 연결이 전체 필터 집합이 IPsec 드라이버에 적용되기 전에 구축될 수 있기 때문에 대형 정책이 로드되는 동안 발생할 수 있습니다. 이러한 상황이 발생하면 IPsec SA는 정책 로딩이 완료된 후 제외될 트래픽에 대해 협상할 수 있습니다.
  
오류 메시지에는 특정 활성 인바운드 보안 연결에 대한 트래픽 선택기와 일치(고의적 또는 우연히)하는 일반 텍스트 트래픽이 전송되는 주입 공격을 나타내는 것일 수도 있습니다.
  
이 문제는 IPsec 정책 설계자에게 문제를 제기해야 합니다.
  
###### IPsec NAT-T Timeouts When Connecting Over Wireless Networks
  
Windows Server 2003 또는 Windows XP 기반 클라이언트 컴퓨터가 IPsec NAT-T를 사용하는 무선 네트워크에서 서버에 연결하려고 할 때 연결 시간이 초과되는 문제가 최근에 발견되었습니다. 자세한 내용은 Microsoft 기술 자료 문서 [885267](http://support.microsoft.com/?kbid=885267)( http://support.microsoft.com/?kbid=885267)를 참조하십시오.
  
#### 올바른 IPsec 정책 확인
  
이 섹션에서는 IPsec 정책 할당 및 해석과 관련된 문제를 검사하는 단계를 설명합니다. 올바르게 해석된 IPsec 정책의 필터는 IPsec이 패킷을 허용하고 차단하며 원격 IP 주소의 IPsec SA가 트래픽을 보안하도록 협상하기 위해 IKE를 실행하도록 IPsec 드라이버에 있어야 합니다. 응답자로서 IKE를 안내하기 위한 적합한 필터가 있어야 합니다. 이 솔루션에서 IPsec 정책 설계에서는 모든 트래픽(ICMP 제외)이 IPsec으로 보호되어야 합니다. 정책에는 또한 제외 목록의 각 IP 주소에 대한 필터도 포함됩니다.
  
**참고:** Windows 2000의 경우에 IPsec 서비스는 IPsec 정책 에이전트로 불려지나 Windows XP 및 Windows Server 2003의 경우에 이 서비스는 IPsec 서비스로 불려집니다.
  
지원 엔지니어는 IPsec에 위한 그룹 정책의 사용, IPsec 정책 우선 순위 및 IPsec 정책 해석에 대해 잘 알고 있어야 합니다. 이러한 주제에 대한 정보 참조는 이 장 후반의 "추가 정보" 섹션에서 확인할 수 있습니다.  
  
##### IPsec에 대한 그룹 정책의 문제 해결
  
그룹 정책은 도메인 기반 IPsec 정책을 도메인 구성 할당에 대한 메커니즘을 제공합니다. 도메인 구성원 별로 할당된 GPO의 검색은 호스트 컴퓨터에 대한 IPsec 정책 할당을 구현하는 것입니다. 따라서, GPO 검색의 문제로 인해 컴퓨터가 적합한 IPsec 정책을 적용하지 못하게 됩니다. IPsec 정책 관리에 대한 그룹 정책에 발생하는 일반적인 문제는 다음이 포함됩니다.
  
-   Active Directory의 다양한 구성 요소의 복제 지연
  
-   그룹 정책 폴링 및 다운로드 프로세스의 문제
  
-   IPsec 정책 버전 할당에 대한 혼동
  
-   IPsec 서비스가 실행되지 않음
  
-   Active Directory의 IPsec 정책은 검색할 수 없어서 캐시된 사본을 대신 사용함
  
-   현재 할당된 IPsec 정책 검색에 대한 IPsec 정책 폴링으로 인한 지연
  
복제는 IPsec 정책, GPO, GPO IPsec 정책 할당 및 IPsec 정책의 속성 변경과 보안 그룹 구성원 정보와 같은 Active Directory의 IPsec 관련 개체 수로 인해 지연될 수 있습니다. 도메인 구성원에 서서히 영향을 끼치기 때문에 IPsec 구성 변경의 영향을 평가하기 위해 주의 깊게 계획해야 합니다.
  
그룹 정책 문제 해결 절차에 대한 자세한 내용은 다음 백서를 참조하십시오.
  
-   [Troubleshooting Group Policy in Windows 2000](http://support.microsoft.com/?kbid=810739)( http://support.microsoft.com/?kbid=810739
  
-   [Troubleshooting Group Policy in Microsoft Windows Server](http://www.microsoft.com/downloads/details.aspx?familyid=b24bf2d5-0d7a-4fc5-a14d-e91d211c21b2&displaylang=en))(www.microsoft.com/downloads/details.aspx?FamilyId=B24BF2D5-0D7A-4FC5-A14D-E91D211C21B2&displaylang=en.  
  
도메인 기반 IPsec 정책 할당은 다음 두 가지 구성 요소로 구현됩니다.
  
-   GPO에서 IPsec 정책의 할당에 대한 IPsec 정책 관리 MMC 스냅인(보안 정책 MMC 스냅인의 확장 형태)
  
-   GPO에서 IPsec 관련 정보를 처리하는 IPSec용 그룹 정책 클라이언트 측 확장자(CSE)(**gptext.dll**으로 구현됨)  
  
IPsec 정책 관리 MMC 스냅인은 선택한 IPsec 정책 정보를 LDAP Distinguished Name(DN)으로 참조된 GPO의 IPsec 구성 요소에 저장함으로써 GPO에 할당합니다.
  
**CN=IPSEC,CN=Windows,CN=Microsoft,CN=Machine,CN={GPOGUID},**  
**CN=Policies,CN=System,DC=domain,DC=Woodgrove,DC=com**
  
할당된 IPsec 정책의 LDAP DN은 GPO 속성 ipsecOwnersReference에 저장됩니다.
  
그룹 정책이 컴퓨터에 적용한 GPO 목록을 검색하는 경우 IPsec 정책 할당이 포함된 GPO는 다음 위치의 IPsec 클라이언트측 확장자에 대한 GUID의 레지스트리에 저장됩니다.
  
**HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Microsoft**  
**\\Windows\\CurrentVersion\\Group Policy**  
**\\History\\{e437bc1c-aa7d-11d2-a382-00c04f991e27}**
  
IPsec CSE는 IPsec 정책 할당이 GPO에 있을 때마다 보안 정책 CSE에 의해 활성화됩니다. 보안 정책을 처리하는 문제가 있는 경우 IPsec 정책을 처리하는 데 문제가 있을 수 있습니다. 각 그룹 정책 확장자에 대한 GUID를 찾으려면 다음 레지스트리 하위를 보십시오.
  
**HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Microsoft**  
**\\WindowsNT\\CurrentVersion\\WinLogon\\GPExtensions**
  
그룹 정책 CSE에 대한 IPsec 배포 관련 GUID는 다음과 같습니다.
  
-   보안. {827D319E-6EAC-11D2-A4EA-00C04F79F83A}
  
-   IP 보안.{E437BC1C-AA7D-11D2-A382-00C04F991E27}
  
-   스크립트. {42B5FAAE-6536-11D2-AE5A-0000F87571E3}
  
IPsec CSE는 LDAP DN와 할당된 IPsec 정책에 대한 관련 문제를 다음 레지스트리 키에 복사합니다.
  
**HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows\\**  
**IPSec\\GPTIPSECPolicy**
  
여러 GPO에 IPsec 정책 할당이 포함된 경우 IPsec CSE는 각 GPO에 대해 호출됩니다. GPO 우선 순위 규칙은 IPsec CSE가 처리할 GPO를 수신하는 순서로 적용됩니다. 이 순서는 GPO 자체의 설정과 일부 할당된 GPO가 검색되지 못하게 하는 Read ACL에 의해 영향을 받을 수 있습니다. IPsec CSE가 호출될 때 마다 GPO의 IPsec 관련 정보(DN 포함)는 이 레지스트리 키에 덮어씁니다. 모든 GPO가 처리되면 CSE는 도메인 기반 IPsec 정책이 할당되었음을 IPsec 서비스에 신호를 보냅니다. 그런 다음, IPsec 서비스는 **GPTIPsecPolicy\\DSIPSECPolicyPath** 값을 읽어 적합한 IPsec 정책을 검색합니다.
  
IPsec 서비스는 계획해서 할당된 IPsec 정책 디렉터리 개체의 최종 업데이트 시간에 기반하여 할당된 IPsec 정책의 변경 사항을 폴링합니다. 서비스는 최종 도메인 정책으로서 캐시된 IPsec 정책을 유지 관리합니다.
  
할당된 IPsec 정책의 이름이 실제로 사용 중인(및 캐시된) IPsec 정책의 이름과 동기화되지 않도록 하는 알려진 문제가 있습니다. IPsec 서비스는 **GPTIPsecPolicy** 레지스트리 키(예: **DSIPSECPolicyName**)의 정보를 업데이트하지 않지만, IPsec 정책의 이름은 IPsec CSE가 호출되는 경우에만 변경됩니다. 단, IPsec CSE가 GPO의 IPsec 정책 할당 DN 속성의 변경 사항이 없으면 호출되지 않습니다. 이 레지스트리 값은 IPsec 모니터 MMC 스냅인과 명령줄 도구에서 사용되어 현재 할당된 IPsec 정책의 이름을 보고합니다. 따라서, IPsec 도구는 현재 사용 중이 아닌 CSE에서 마지막 처리되었던 IPsec 정책 이름을 보고할 수 있습니다. 이 버그에 대해서는 몇 가지 해결 방안이 있습니다. 자세한 내용은 이 가이드의 5장, "격리 그룹을 위한 IPsec 정책 만들기"의 "정책 버전 관리" 섹션을 참조하십시오.
  
**참고:**  Microsoft는 IPsec 규칙 명명 규칙에는 이름에 버전 번호를 포함하여 현재 할당된 정책 버전을 쉽게 확인할 수 있도록 하는 것이 좋습니다. 그렇지 않으면 정책 이름이 동일하게 유지되는 경우 쉽게 버전 변경 사항을 알 수 없게 됩니다.
  
그룹 정책을 강제로 새로 고침한 후에도 적절한 IPsec 정책이 할당되지 않으면 소스 **Userenv** 또는 **SceCli**의 응용 프로그램 로그 오류에서는 그룹 정책 처리 문제를 나타냅니다. 더욱 자세하게 이 문제를 조사하려면 그룹 정책 로깅을 활성화해야 합니다. 그룹 정책 로그와 로깅 레벨에는 다양한 유형이 있습니다. 보안 CSE에 대한 로그는 IPsec CSE에서 보고한 오류 뿐 아니라 오류 처리 보안 정책을 확인하는 데 필요합니다. IPsec CSE에 명시적인 로그는 없습니다. 그룹 정책이 어떤 도메인 컨트롤러 IP 주소가 각 개체의 검색에 사용되고 있는지를 확인하기 위해 새로 고침할 때 트래픽을 수집하기 위해 네트워크 모니터 추적이 필요할 수 있습니다. 다음과 같은 문제가 발생할 수 있습니다.
  
-   개체 찾을 수 없음을 유발하는 복제 문제 또는 지연
  
-   도메인 컨트롤러 로케이터의 로드 균형 조정은 할당된 IPsec 정책에 대한 LDAP 쿼리가 동일한 사이트의 다른 도메인 컨트롤러에서 검색되는 동안 하나의 도메인 컨트롤러에서 GPO가 검색될 수 있게 합니다.
  
보안 CSE에 대한 자세한 로그 파일을 만들려면 다음 레지스트리 키를 사용하십시오.
  
**HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Microsoft**  
**\\WindowsNT\\CurrentVersion\\CurrentVersion\\Winlogon**  
**\\GpExtensions\\{827d319e-6eac-11d2-a4ea-00c04f79f83a}\\**
  
**ExtensionDebugLevel** 항목을 0x2의 **REG\_DWORD** 값으로 설정합니다.
  
로그 파일이 **%windir%\\Security\\Logs\\Winlogon.log**에 만들어집니다.
  
**참고:** 잘못된 DNS 항목은 컴퓨터 및 사용자 로그온이 성공한다 해도 그룹 정책이 Active Directory로부터 다운로드되지 않는다는 것을 의미할 수 있습니다. DNS 문제에 대한 자세한 내용은 "이름 확인 문제" 섹션을 참조하십시오.
  
##### IPsec 서비스 문제 해결
  
IPsec 서비스는 IPsec 정책 관리 MMC 스냅인을 사용하기 위해 실행될 필요가 없습니다. 단, 관리자가 로컬 정책을 할당하는 경우 **정책할당** 열에 오류가 표시됩니다.
  
다음과 같은 공통적인 문제로 인해 IPsec 서비스가 시작 동안 실패할 수 있습니다.
  
-   **컴퓨터가안전모드또는 Active Directory 복구모드로시작되었습니다**. 이러한 경우에 IPsec 드라이버는 IPsec 정책이 할당된 경우 기본적으로 상태 저장 아웃바운드 통신을 제공하게 됩니다. 부팅 예외가 설정되어 있지 않으면 인바운드 연결이 차단됩니다.
  
-   **IKE는 UDP 포트 500 및포트 4500을독점적으로제어할수없습니다**. netstat –bov를 사용하여 각 포트에 대한 프로세스와 코드 모듈을 사용합니다. portqry –local –v 명령은 더욱 자세한 정보를 제공합니다. 일부 Winsock 계층화된 서비스 공급자(LSP)가 설치되어 IPsec을 방해할 수 있습니다. LSP와 IPsec에 대한 자세한 내용은 이 장 후반의 "응용 프로그램 관련 문제 해결" 섹션을 참조하십시오.
  
-   **IPsec 정책손상**. 할당된 IPsec 정책을 완전히 읽거나 적용할 수 없어 IPsec 서비스가 많은 오류를 보고하게 됩니다. 이러한 오류로 서비스 자체가 실패하지는 않지만 그룹 정책 및 IPsec 서비스가 수정된 정책을 검색하지 못하도록 차단하는 등 통신을 실패하게 할 수 있습니다. Windows XP와 Windows Server 2003에서 도메인 기반 정책이 적용될 때 발생하는 오류에 대비하여 안전한 정책으로 적용될 영구 정책 또는 로컬 정책의 설계에 보다 주의를 기울여야 합니다. 영구 정책과 컴퓨터 시작 정책(bootmode 제외) 모두 문제 해결 조사에 포함되어야 합니다. 이러한 정책은 다른 오류 상황으로 인해 적용되는 유일한 정책인 경우에 다른 수단으로 컴퓨터에 대한 원격 액세스를 허용해야 합니다.
  
Windows 2000 IPsec 구현은 IPsec 정책 저장소(**polstore.dll**)라는 모듈을 사용하여 IPsec 정책 에이전트와 IPsec 정책 관리 MMC 스냅인이 하나의 모듈을 사용하여 모든 세 가지 지원되는 정책 저장 위치(로컬, 원격 컴퓨터 및 Active Directory)에 액세스합니다. 이 설계는 새 IPsec 정책 유형(시작 정책 및 영구 정책) 및 SPD(Security Policy Database)가 추가로 Windows XP 및 Windows Server 2003에서 변경 및 개선되어 IPsec 모니터 쿼리 및 IKE 쿼리에 대한 실시간 IPsec 정책 상태를 유지 관리합니다. 이 구조적 변경은 Windows 2000에 기록된 IPsec 이벤트의 텍스트가 Windows XP 및Windows Server 2003에서 변경되었다는 것을 의미합니다. 또한, 원격 권리에 사용된 RPC 인터페이스에 상당한 변경 사항이 있었음을 의미합니다. Windows Server 2003의 경우 RPC 인터페이스가 다시 상당히 업데이트되었습니다. 따라서, IPsec 정책 관리 MMC 스냅인은 동일한 운영 체제 버전이 설치되지 않은 원격 컴퓨터에 연결할 수 없습니다. 또한, Windows XP SP2 및 Windows Server 2003 SP1의 보안 모델은 기본적으로 원격 RPC 연결로 제한하고 Windows 방화벽을 기본적으로 활성화되도록 변경됩니다. 자세한 내용은 [Changes to Functionality in Microsoft Windows XP Service Pack 2 - Part 2: Network Protection Technologies](http://www.microsoft.com/technet/prodtechnol/winxppro/maintain/sp2netwk.mspx)(www.microsoft.com/technet/prodtechnol/winxppro/maintain/sp2netwk.mspx)를 참조하십시오.
  
이러한 변경 사항으로 인해 IPsec 서비스의 원격 RPC 인터페이스는 안전 수단으로서 사용되지 않았습니다. 따라서 IPsec 모니터 및 IPsec 정책 관리 MMC 스냅인은 이러한 컴퓨터에서 원격 모니터링을 수행할 수 없습니다. IPsec의 원격 관리는 IPsec MMC 스냅인을 원격 프로세스로서 실행하는 원격 데스크톱(터미널 서버)을 사용하여 수행해야 합니다.
  
Windows 2000의 경우, 기본적으로 IPsec 드라이버는 시작 프로세스 종료 후에 정책 에이전트 서비스에 의해 로드됩니다. IPsec 드라이버는 정책 에이전트가 IPsec 드라이버에게 활성 정책을 처음 알리기 전까지 IP 패킷 처리의 일부가 아닙니다. 활성 IPsec 정책이 없는 경우 IPsec 드라이버는 인바운드 및 아웃바운드 IP 트래픽 처리에 포함되지 않습니다. Windows XP 및 Windows Server 2003의 경우 이 설계는 시작 프로세스 동안 TCP/IP 드라이버에 의해 IPsec 드라이버가 로드되도록 개선되었습니다. 이 드라이버는 IPsec 서비스로 필터가 로드될 때까지 패킷을 처리하지 않습니다.
  
Windows 2000의 경우 서비스 시작 문제에 대해 IPsec 정책 에이전트에 의해 오류가 기록될 수 있습니다. 이러한 오류에는 다음이 포함됩니다.
  
-   **IP 보안정책에이전트가시작하지못했습니다. IP 보안정책을강제할수없습니다.** 이 오류는 RPC 하위 시스템에 등록되는 경우 IPsec 정책 에이전트에 발생하는 문제로 인해 발생된 것일 수 있습니다. 타사 Winsock LSP로 인해 IKE의 초기화가 실패할 수 있습니다.
  
-   **정책에이전트 RPC 서버실패항목**
  
    -   **프로토콜시퀀스등록**
  
    -   **인터페이스등록**
  
    -   **인터페이스바인딩등록**
  
    -   **인터페이스끝점등록**
  
    -   **인증메커니즘등록**
  
    -   **수신**
  
    이러한 오류는 IPsec 정책 에이전트 서비스가 서비스 시작 동안 제대로 초기화되지 않도록 하는 RPC 서비스 내에 고급 보안 설정 또는 문제에 대한 변경 사항으로 인해 발생할 수 있습니다. 따라서, IPsec 정책 에이전트가 기능하지 않거나 중단되고 종료될 수 있습니다.
  
-   **정책에이전트가시작하지못했습니다. SCM 데이터베이스에연결하지못했습니다. 오류:  <번호>**. IPsec 서비스는 IPsec 서비스가 권한 없는 서비스 계정으로 실행되도록 구성되었기 때문에 발생할 수 있는 서비스 제어 관리자 데이터베이스를 열 수 없습니다. 로컬 시스템으로 실행되어야 합니다. 그렇지 않으면, 서비스 제어 관리자와 문제를 상의하십시오.
  
-   **정책에이전트가 IPSEC 드라이버에연결하지못했습니다**. IPsec 드라이버가 성공적으로 로드되어 TCP/IP 스택과 연결되지 못했습니다. IPsec 서비스가 시작될 때 Windows 2000에서 이 작업을 수행하도록 제작되었습니다. 연결을 방해하는 타사 소프트웨어가 있을 수 있거나 운영 체제에 이 기능에 필요한 코드 모듈이 없을 수 있습니다.
  
-   **정책에이전트가 PSEC 정책을로드하지못했습니다**. IPsec 정책 에이전트가 모든 필터를 IPsec 드라이버로 로드하는 동안 오류가 발생했습니다. 이 오류는 커널 메모리가 부족하거나 IPsec 드라이버가 부적합하게 초기화되어 발생되었을 수 있습니다. 문제가 지속되면 Microsoft 기술 지원 서비스에 문의하십시오.
  
-   **정책에이전트가 ISAKMP 서비스를시작하지못했습니다**. 이 오류는 다른 서비스가 이미 사용하고 있기 때문에 IKE가 UDP 포트 500 또는 포트 4500을 독점적으로 제어할 수 없어 발생합니다. 네트워크 포트 할당을 방해하는 타사 보안 소프트웨어 또는 로컬 시스템 컨텍스트에서 실행되지 않는 IPsec 서비스로 인해 발생할 수도 있습니다.
  
-   **ISAKMP/Oakley 서비스에대한 SSPI 원래이름을결정할수없습니다**. Windows 2000은 SSPI(보안 지원 공급자 인터페이스) 함수 호출 QueryCredentialsAttributes가 실패하는 경우 이 메시지를 기록합니다. 이 오류는 컴퓨터가 도메인에 성공적으로 로그인할 수 없다는 것을 나타냅니다.
  
-   **SAKMP/Oakley 서비스에대한 Kerberos 서버인증을얻을수없습니다**. Windows 2000 오류 메시지는 일반적으로 IPsec 서비스가 Kerberos 인증을 필요로 하고 도메인 컨트롤러를 사용할 수 없는 IPsec 정책이 할당된(도메인 정책의 레지스트리 캐시에서) 원격 네트워크에서 IPsec 서비스가 시작되는 경우에 발생합니다. 따라서, Kerberos 인증은 제대로 작동하지 않습니다. 내부 네트워크에서 이 이벤트는 도메인의 구성원이 아니거나 IPsec 서비스 초기화 동안 Kerberos 프로토콜을 사용하여 도메인 컨트롤러에 연결할 수 없는 컴퓨터에 기록될 수 있습니다.
  
-   **IP 보안드라이버가시작되지못했기때문에보안통신정책을강요할수없습니다. 시스템관리자에게즉시문의하십시오.** 이 오류는 IPsec 드라이버 로딩, TCP/IP 스택 바인딩 또는 정책을 추가하기 전에 초기화 등에 문제로 인해 발생됩니다. 파일 손상 또는 사용 권한이 원인일 수 있습니다. 드라이버 로딩을 금지하는 보안 설정 또는 타사 보안 소프트웨어를 찾으십시오. **FIPS.sys** 내부 서명이 초기화 동안 인증될 수 없는 경우 로드되지 못하고 IPsec 드라이버도 로드에 실패할 수 있습니다. **FIPS.sys** 서명 오류가 발생하면 Microsoft로부터 제공되는 서명된 이진 파일 원본 또는 새 이진 파일로 교체해야 합니다. 컴퓨터를 다시 시작합니다. 문제가 지속되면 Microsoft 기술 지원 서비스에 문의하십시오.  
  
Windows XP와 Windows Server 2003의 경우에 다음 IPsec 서비스 오류 이벤트는 이 서비스를 시작할 수 없음을 나타냅니다.
  
-   **IPSec 서비스가 IPsec 드라이버를초기화하지못했습니다. 오류코드는  <번호>입니다. IPSec 서비스를시작할수없습니다**. IPsec 드라이버를 일부 이유로 로드할 수 없습니다. 문제가 지속되면 Microsoft 기술 지원 서비스에 문의하십시오.
  
-   **IPSec 서비스가 IKE 모듈을초기화하지못했습니다. 오류코드는  <번호>입니다. IPSec 서비스를시작할수없습니다**. 이 문제의 일반적인 원인은 IKE가 일정한 소켓 옵션을 사용하지 못하게 하는 타사 Winsock LSP입니다. 이 오류는 IKE가 UDP 포트 500 및 4500을 독점적으로 제어할 수 없는 경우에도 보고됩니다.
  
-   **IPSec 서비스가 RPC 서버를초기화하지못했습니다. 오류코드는  <번호>입니다. IPSec 서비스를시작할수없습니다**. IPsec 서비스는 IKE, SPD 및 정책 에이전트 사이에 프로세스 간 통신을 위해 RPC 하위 시스템에 의존합니다. RPC 문제 해결 방법을 사용하여 RPC가 제대로 작동되고 있는지 확인하십시오. 컴퓨터를 다시 시작한 후에도 문제가 지속되면 Microsoft 기술 지원 서비스에 문의하십시오.
  
-   **IPSec 서비스에중대한오류가발생하여종료했습니다. 오류코드는  <번호>입니다중지된 IPSec 서비스로인해컴퓨터에잠재적인보안위험이있을수있습니다. 시스템관리자에게문의하여서비스를다시시작하십시오.** IPsec 서비스에 이벤트 텍스트에  <번호>로 표시되고 더 이상 실행되지 않는 오류가 발생했습니다. IPsec 드라이버가 로드되고 정상 모드(IPsec 정책 필터를 강제 적용하는) 또는 차단 모드 상태입니다. 각 이벤트는 IPsec 드라이브가 차단 모드 상태였는지 나타나게 됩니다. 드라이버가 정상 모드 상태가 아닌 경우 허용 및 차단 필터 작업은 예상한 대로 작동합니다. 협상 작업의 필터는 IKE을 사용할 수 없기 때문에 트래픽을 손실합니다.
  
-   **이전실패오류코드  <번호>때문에 IPSec 서비스가 IPSec 드라이버를차단모드로설정했습니다**. 이 메시지는 IPsec 드라이버가 IPsec 정책 처리 중 발생한 오류로 인해 오류 복구 동작으로 차단 모드 상태가 되었다는 알림입니다. 이 동작은 Windows Server 2003에서만 사용 가능합니다. 차단 모드로 인해 netsh insec 명령을 사용하여 구성되었던 인바운드 제외를 허용합니다.  
  
##### IPsec 정책 검색 문제 해결
  
IPsec 서비스는 인증 및 암호화된 TCP LDAP 쿼리를 사용하여 모든 플랫폼에 대해 할당된 IPsec 정책을 다운로드합니다. LDAP 서명 및 Kerberos 세션 키를 사용한 봉인 옵션이 있습니다. 따라서, 로컬 시스템으로 실행되는 IPsec 서비스는 Active Directory 서버에서 LDAP 서비스에 대한 Kerberos 서비스 티켓을 획득할 수 있어야 합니다. 할당된 적절한 IPsec 정책은 **GPTIPsecPolicy** 레지스트리 키의 IPsec CSE로 저장되도록 확인되고 서비스가 실행되는 경우 다음 문제로 인해 IPsec 서비스가 Active Directory에서 해당 정책을 검색할 수 없게 됩니다.
  
-   도메인 컨트롤에 대한 통신 문제
  
-   도메인 컨트롤러의 컴퓨터 계정 로그온 문제
  
-   Kerberos 티켓 발행 문제
  
-   LDAP 서비스 사용 가능성 문제
  
-   LDAP 쿼리로 요청된 특정 IPsec 정책 또는 구성 요소 개체 발견 문제
  
-   요청된 IPsec 정책 개체에 대한 읽기 권한 문제
  
-   저장소로 개체 저장 시 문제 또는 저장소 개체의 우연 또는 고의적인 삭제로 인한 정책 손상  
  
    **참고**: Windows XP 또는 Windows Server 2003에 만들어지고 이러한 릴리스에서 사용 가능해진 새 기능을 사용하는 IPsec 정책에는 이후 정책이고 Windows 2000 IPsec 정책 관리 MMC 스냅인에 의해 저장된 경우 이러한 기능이 약간 제거되었을 수 있습니다. 단, Windows 2000 시스템이 추가 기능이 있는 IPsec 정책을 검색한 경우 단순히 무시하여 Windows 2000 시스템에서 가장 적용되는 경우 IPsec 정책의 동작을 변경 또는 변경하지 않을 수 있습니다.
  
IPsec 정책 관리 MMC 스냅인에 알려진 문제는 Active Directory 또는 원격 컴퓨터에서 IPsec 정책을 관리할 때 발생합니다. MMC 스냅인이 느린 연결에서 실행되는 경우 대용량 정책에 모든 변경 사항을 저장하는 데 시간이 많이 걸릴 수 있습니다. MMC 스냅인 창이 닫혀 있는 경우 아직 저장되지 않은 IPsec 정책 개체 또는 변경 사항이 손실됩니다. 이 기능으로 IPsec 정책이 손상될 수 있습니다. IPsec 정책 관리 MMC 스냅인이 느린 링크에서 실행되는 경우 원격 데스크톱 세션을 사용하여 이 스냅인을 로컬 프로세스로 실행하십시오.
  
일반적으로 IPsec 정책을 만드는 명령줄 도구 스크립트는 테스트되어야 합니다. 테스트하려면 로컬 시스템에 정책을 만들고 IPsec 정책 관리 MMC 스냅인으로 검토하여 무결성을 확인하십시오. 테스트 컴퓨터는 로컬 IPsec 정책을 적용하고 IPsec 모니터 MMC 스냅인의 세부 사항을 조사하여 예정되는 필터 주문을 확인해야 합니다.
  
IPsec 정책 읽기 오류 및 손상의 문제를 해결하기 위한 절차는 저장소 위치에 따라 다릅니다. 이 솔루션은 도메인 기반 IPsec 정책만을 사용하지만, 다른 유형의 IPsec 정책은 문제가 발생시키는 방식으로 구성되었을 수 있습니다.
  
각 정책 유형에 대한 문제 해결 정책은 이 섹션의 나머지 부분에서 검토됩니다. 일반적으로, 계층 2 지원은 명령줄 또는 GUI 도구를 사용하여 올바른 IPsec 정책이 검색되고 해당 정책이 올바르게 해석되고 있는지 확인해야 합니다. 각 정책 유형을 삭제하는 단계는 정책 새로 고침으로 올바른 정책이 분명하게 설치될 것이라는 예상과 함께 여기에 표시됩니다. 적절한 정책이 스크립트로부터 검색 또는 설치되지 않는 것처럼 보이는 경우 문제는 계층 3 지원으로 제기됩니다.
  
###### IPsec 시작 정책
  
Netsh 유틸리티를 통해 Windows Server 2003에서만 지원되는 부트 모드와 부트 예외 옵션을 구성할 수 있습니다. 이 구성은 아래와 같은 기본 값으로 다음 레지스트리 키에 저장됩니다.
  
-   **HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\IPSec\\**  
    **OperationMode=3 (Stateful)**
  
-   **HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\IPSec\\**  
    **BootExemptList = (exemption for inbound DHCP, see below)**
  
기본 **OperationMode** 값은 IPsec 드라이버가 아웃바운드 트래픽의 상태 저장 필터링을 수행할 것을 요청합니다. IPsec 서비스가 실행 중인 경우
  
```  
    Netsh ipsec dynamic show config  
```  
이 명령을 사용하여 시작 구성을 표시합니다. IPsec 서비스가 실행되고 있지 않은 경우(예: 안전 모드로 시작되는 경우) 레지스트리 도구를 사용하여 레지스트리 키 값을 조사하여 변경할 수 있습니다.  
시작 중에 IPsec 상태 저장 필터링으로 인해 발생한 트래픽 문제를 해결하기 위해 IPsec 드라이버를 상태 저장 필터를 수행하는 대신 시작 시 트래픽을 허용하도록 설정합니다. IPsec 서비스가 실행 중인 경우
  
```  
    netsh ipsec dynamic set config bootmode value=permit  
```  
 이 명령을 사용하여 시작 모드가 허용되도록 설정합니다. IPsec 서비스가 실행되고 있지 않은 경우 레지스트리 도구를 사용하여 **OperationsMode=1**를 변경합니다. 또한, IPsec 드라이버는 IPsec 서비스가 수동 시작에 대해 구성되거나 비활성화된 경우 시작 보안 모드를 적용하지 않습니다. 서비스가 수동 시작되도록 구성되어 있거나 비활성화된 경우 IPsec 드라이버가 허용 모드에서 로드하도록 컴퓨터를 다시 시작합니다.  
###### 영구 IPsec 정책
  
영구 정책은 Windows XP와 Windows Server 2003에서 지원됩니다. 공통된 오류 상황 중 하나는 기존 영구 정책이 새 영구 정책이 정의되기 전에 삭제되지 않거나 새 정책이 이미 할당된 다른 설정과 충돌하는 경우에 발생합니다. 이 장에 설명된 솔루션은 영구 정책을 사용하지 않습니다. 단, 일부 환경의 문제 해결 지침에 사용될 수 있기 때문에 이 장에 제공됩니다.
  
영구 정책 레지스트리 키는 기본으로 존재하며 다음과 같이 비어 있습니다.
  
**HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows\\**  
**IPSec\\Policy\\Persistent**
  
Windows XP의 경우 영구 정책을 검색하는 최상의 방법은 이 레지스트리 키가 비어 있지 않은지 확인하는 것입니다. ipseccmd show 명령은 IPsec 서비스에 포함된 활성 정책을 보고하지만 특정 설정이 영구 정책으로 발생했음을 보고하지 않습니다. IPsec 서비스는 정책을 활성 설정으로 해석할 때 영구 정책 규칙의 이름을 무시합니다. ipseccmd가 필터 및 필터 작업에 이름을 제공하지 않기 때문에 영구 정책으로 인해 발생된 필터와 필터 이름을 나타내기 위해 이름 명명 규칙을 사용할 수 없습니다. **ipsecpol.exe** 또는 **ipseccmd.exe**를 사용하여 만들 때마다 영구 정책의 항목이 포함될 필터에는 "text2pol{GUID}" 유형의 이름이 설정됩니다. 단, 스크립트를 사용하여 만들어진 로컬 또는 도메인 정책도 이러한 이름을 갖게 됩니다.
  
영구 정책이 먼저 적용되고 로컬 또는 도메인 IPsec 정책과 통합됩니다. 따라서 로컬 및 도메인 정책 모두 영구 설정만을 검토할 수 있기 전에 적용 해제되어야 합니다. 사용
  
```  
ipseccmd show all  
```  
하여 IPsec 서비스가 시작되면 영구 설정을 포함하여 모든 활성 정책을 표시합니다.  
특정 영구 정책과 관련된 개체(규칙, 필터 목록 및 필터 작업)를 모두 삭제하려면 다음 명령으로 영구 정책 이름을 지정합니다.
  
```  
 ipseccmd.exe -w PERS -p "policy name" –o   
```  
모든 영구 정책이 제거되었는지 확인하는 가장 쉬운 방법은 **Persistent** 키의 모든 하위 키를 삭제하는 것입니다. 그러나, **Persistent** 키 자체를 삭제하면 영구 정책을 만들려고 할 때 앞으로 ipseccmd 명령은 실패합니다. 영구 정책 및 정책 충돌의 손상을 해결하려면 영구 정책 저장소의 모든 개체를 삭제하고 ipseccmd 스크립트를 다시 한번 실행하여 만듭니다.
  
Windows Server 2003의 경우 영구 정책은 로컬 및 도메인 IPsec 정책과 유사한 전체 관리 기능을 갖게 됩니다. 이 영구 정책은 앞서 참조된 동일한 레지스트리 위치에 저장됩니다. 다음 Netsh 명령 스크립트는 **show\_persistent.netsh** 파일에 명령을 사용하면 구성된 영구 정책을 나타냅니다.
  
```  
 Netsh –f show\_persistent.netsh   
```  
**show\_persistent.netsh** 파일은 다음 줄이 포함된 텍스트 파일입니다.
  
```  
 Pushd ipsec static Set store persistent show all exit   
```  
다음 Netsh 명령 스크립트는 다음과 같은 모든 영구 정책을 삭제하는 데 사용될 수 있습니다.
  
```  
 pushd ipsec static set store persistent delete all exit   
```  
###### 로컬 IPsec 정책
  
로컬 IPsec 정책은 Windows 2000, Windows XP 및 Windows Server 2003에서 지원되어 다음 레지스트리 키 아래에 저장됩니다.
  
**HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows\\**  
**IPSec\\Policy\\Local**
  
로컬 정책이 할당된 경우 할당된 정책은 다음과 같이 키에 저장됩니다.
  
**HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows\\**  
**IPSec\\Policy\\Local\\ActivePolicy**
  
도메인 정책이 할당되지 않은 경우 할당된 로컬 정책은 구성된 영구 정책에 추가되어 활성 정책이 됩니다. 상당히 간편해진 문제 해결 방법으로 ipsecpol 또는 ipseccmd 스크립트로 만들어진 IPsec 정책은 IPsec 정책 관리 MMC 스냅인으로 편집되어 생산 환경에서 사용되기 전에 각 필터에 대해 필터 이름을 정의해야 합니다. 또는,
  
```  
netsh ipsec  
```  
명령을 사용하여 Windows Server 2003 기반 컴퓨터에서 정책을 만든 다음 테스트 후 Windows 2000과 Windows XP 기반 컴퓨터나 도메인으로 가져올 수 있는 파일로 내보낼 수 있습니다.  
Windows 2000의 경우
  
```  
netdiag /test:ipsec /debug   
```  
명령을 사용하여 할당 및 활성 정책 세부 정보를 확인합니다. IPsec 정책 관리 MMC 스냅인 또는 레지스트리 도구를 사용하여 로컬 저장소의 IPsec 정책 개체를 삭제해야 합니다. 할당된 IPsec 정책을 강제로 다시 로드하려면 서비스를 중지하고 다시 시작해야 합니다.  
Windows XP의 경우
  
```  
ipseccmd show gpo  
```  
```  
netdiag /test:ipsec   
```  
명령을 사용하여 할당 및 활성 정책 세부 정보를 확인합니다. IPsec 정책 관리 MMC 스냅인, 레지스트리 도구 또는 명령을 사용하여  
```  
ipseccmd.exe -w REG -p " <policy\_name>" –o   
```  
명명된 IPsec 정책을 삭제합니다. 간편하게 모든 로컬 정책을 제거하려면 이전에 참조된 저장소 위치에 대한 모든 하위 키를 삭제합니다.  
IPsec 서비스를 해당 정책을 다시 로드하도록 적용하려면 IPsec 서비스를 중지하고 다시 시작하거나 IPsec 정책 관리 MMC 스냅인을 사용하여 IPsec 정책의 할당을 취소하거나 다시 할당합니다. 명령을 사용하여
  
```  
sc policyagent control 130   
```  
정책을 다시 로드할 수도 있습니다. 정책이 다시 로드되면 능동적으로 IPsec SA를 사용하여 트래픽을 송수신하고 있는 컴퓨터의 연결 지연 또는 중단을 일으킬 수 있는 모든 IPsec 및 IKE SA가 삭제됩니다.  
Windows Server 2003의 경우
  
```  
netsh ipsec static show gpoassignedpolicy   
```  
명령, IPsec 정책 관리 MMC 스냅인 도는 IPsec 모니터 활성 정책 노드를 사용하여 현재 할당된 로컬 정책을 표시합니다.  
명령을 사용하여
  
```  
netsh ipsec dynamic show all   
```  
현재 활성 정책 구성을 확인합니다. 또한, IPsec 모니터를 사용하여 활성 정책의 다른 부분을 검사할 수 있습니다.  
Windows Server 2003에서 로컬 정책을 삭제하고 다시 로드하려면 Windows XP에 있는 것과 동일한 명령을 사용합니다.
  
```  
netsh ipsec   
```  
명령을 사용하여 정책의 할당을 취소, 다시 할당 및 삭제할 수 있습니다.  
###### Active Directory IPsec 정책
  
이 정책은 Windows 2000, Windows XP 및 Windows Server 2003에서 지원됩니다. 할당된 도메인 IPsec 정책은 다음 위치의 로컬 레지스트리에 저장됩니다.
  
**HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows\\**  
**IPSec\\GPTIPSECPolicy**
  
도메인 정책의 로컬 레지스트리 캐시는 다음 위치에 저장됩니다.
  
**HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows\\**  
**IPSec\\Policy\\Cache**
  
디렉터리 저장소는 IPsec 정책 관리 MMC 스냅인 또는 Active Directory에 대해 로컬 프로세스로서 실행되는 netsh ipsec 명령에 의해 관리되어야 합니다. 직접 캐시의 내용을 확인할 수 있게 지원하는 도구는 없습니다. 레지스트리 도구는 캐시가 존재하고 적절한 내용이 포함되어 있는지 확인하기 위해 사용되어야 합니다. 이와 마찬가지로 레지스트리 도구는 **GPTIPsecPolicy** 및 **Cache** 레지스트리 키를 삭제하여 도메인 정책을 삭제하는 데 사용됩니다. 그런 다음 IPsec 서비스를 다시 시작하거나 서비스 제어 명령을 사용하여 도메인 정책 없이 IPsec 정책이 다시 로드되도록 강제해야 합니다.
  
도메인 기반 IPsec 정책 할당을 새로 고침하고 IPsec 정책을 로드하며 캐시 콘텐츠를 업데이트하려면 **gpudpate /force**를 사용합니다.
  
일시적으로 도메인 정책이 로컬 컴퓨터에 적용되는 것을 차단하려면 **GPTIPsecPolicy** 및 **Cache** 레지스트리 키 모두의 권한이 로컬 시스템 계정에 대한 읽기 액세스를 거부하도록 구성할 수 있습니다. IPsec 보안 모니터 MMC 스냅인 및 명령줄 도구는 여전히 이러한 도구가 로컬 관리자 사용자의 컨텍스트에서 실행되는 GPTIPsecPolicy 정보를 읽기 때문에 할당된 것으로 나타날 수 있습니다. 도메인 기반 IPsec 정책의 길어진 기간의 차단의 경우 컴퓨터는 Active Directory에서 적합한 GPO을 읽지 못하도록 해야 합니다.
  
Windows 2000의 경우 다음 오류는 정책에 문제가 있는 경우 나타날 수 있습니다.
  
-   **디렉터리체계에바인딩하지못했습니다**. IPsec 정책 에이전트 서비스는 Active Directory IP 보안 정책 컨테이너에 대한 인증된 LDAP 바인딩을 수행하지 못했습니다. 이 오류는 성공적으로 로그인하여 Kerberos 인증을 받지 못하는 컴퓨터 계정으로 인해 발생했습니다. Keberos가 LDAP 서비스 티켓을 IPsec 정책 에이전트 서비스로 발행하지 못하여 발생할 수도 있습니다.
  
-   **IPSEC 정책저장소개체에바인딩하지못했습니다**. 개체가 현재 존재하지 않는 IPsec 개체(예: 규칙 또는 필터 목록)에 정의되어 있습니다. IPsec 정책 또는 Active Directory 저장소 정책이 손상되었거나 기존 IPsec 정책이 개체를 참조하고 있지만 객체가 삭제되었습니다. 모든 정책 규칙이 손상되지 않고 **키교환** 속성(**일반** 탭)이 제대로 보이는지 확인하려면 IPsec 정책 관리 MMC 스냅인을 사용하여 IPsec 정책을 검토합니다.
  
-   **도메인컨트롤러를찾지못했습니다. 컴퓨터가도메인에소속되어있는지와네트워크연결상태를확인하십시오.** IPsec 정책 저장소 모듈은 도메인 기반 IPsec 정책을 검색할 LDAP 디렉터리를 찾지 못했습니다.
  
-   **도메인컨트롤러의디렉터리서비스와통신하지못했습니다. 시스템관리자에게문의하십시오.** IPsec 저장소 모듈이 LDAP 서명 및 봉합을 사용하여 할당된 IPsec 정책을 다운로드하지 못했습니다.
  
-   **저장된개체를찾지못했습니다**. IPsec 정책을 완전하게 검색할 수 없어 제대로 작동하지 않기 때문에 이 오류는 일반적으로 심각합니다. IPsec 정책 저장소 모듈은 IPsec 정책 또는 규칙 중에 포함된 개체(규칙, 필터 목록, 필터 작업 또는 ISAKMP 설정)를 LDAP 호출 또는 원격 레지스트리 호출을 사용하여 GUID를 찾지 못했습니다. 이 오류는 다음 중 하나가 원인일 수 있습니다.
  
    -   참조하는 개체가 참조된 개체 앞에 도착하거나 쿼리가 서로 다른 두 개의 도메인 컨트롤러를 대상으로 하는 경우에 복제가 지연됩니다.
  
    -   IPsec 정책에서 사용되고 있는 동안에 개체가 삭제되었을 수 있습니다.
  
    -   개체에 열거 또는 읽기 기능을 거부하는 권한이 있거나 개체가 있지 않았던 이전으로 IPsec 정책 저장소가 복구되었습니다.
  
    -   IPsec 정책 손상으로 인해 쿼리에 잘못된 GUID가 발생했습니다.
  
    -   대상 IP 주소로 네트워크 연결을 수행할 수 없습니다.
  
    -   LDAP 또는 원격 레지스트리 서비스를 사용할 수 없습니다.
  
-   **요청된작업을완료할수없습니다. 정책저장소가열려있지않습니다.** Active Directory, 원격 컴퓨터 또는 로컬 컴퓨터 저장소를 열 수 없습니다. 이 오류는 사용 권한 또는 인증 오류로 인해 발생합니다.
  
-   **(i) Active Directory 저장소정책이없거나 (ii) Active Directory 저장소정책을적용하지못하고캐시된정책이없으므로활성로컬레지스트리정책을사용합니다.** 이 이벤트는 IPsec 정책이 컴퓨터에서 로컬로 정의되고 도메인 기반 정책이 이를 덮어 쓰도록 적용될 수 없음을 확인합니다.
  
-   **(i) Active Directory 저장소나활성로컬레지스트리정책또는 (ii) Active Directory 저장소정책을적용하지못했고캐시된정책이나활성로컬레지스트리정책이없으므로 IPSEC 정책을사용하지않습니다.** 이 이벤트는 어떤 정책도 컴퓨터에 할당되어 있지 않은 기본 상태를 확인합니다.
  
Windows XP와 Windows Server 2003의 경우 다음 이벤트는 IPsec 서비스가 특정 정책 유형을 검색하지 못했음을 나타냅니다. 로컬 정책을 Windows Server 2003과 Windows XP SP2에서 성공적으로 확인할 수 없는 경우 정책은 무시되고 영구성 순서로 할당된 다음 정책이 확인됩니다.
  
-   **PAStore 엔진이** "***< 정책 이름 >***" 에 대해 컴퓨터에 영구 저장소 IPSec 정책을 로드하지 못했습니다. **오류 코드는** < **번호** > 입니다. IPsec 서비스는 영구 정책이 로컬 레지스트리에 할당되어 저장되어 있음을 검색했지만 영구 정책 개체 중 적어도 하나의 콘텐츠를 확인하지 못했습니다. 모든 레지스트리 키에 대한 권한을 확인합니다. 정책이 손상되었을 수 있습니다. 모든 영구 정책을 삭제한 후 다시 만듭니다.

-   **PAStore 엔진이** "***< 정책 이름 >***" 에 대해 컴퓨터에 로컬 저장소 IPSec 정책을 로드하지 못했습니다. **오류 코드는** < **번호** > 입니다. IPsec 서비스는 로컬 정책이 로컬 레지스트리에 할당되어 저장되어 있음을 검색했지만 영구 정책 개체 중 적어도 하나의 콘텐츠를 확인하지 못했습니다. 모든 레지스트리 키에 대한 권한을 확인합니다. 정책이 손상되어 삭제한 후 다시 만들어야 합니다.

-   **PAStore 엔진이** "***< 정책 이름 >***" 에 대해 컴퓨터에 디렉터리 저장소 IPSec 정책을 로드하지 못했습니다. **오류 코드는** < **번호** > 입니다. IPsec 서비스 중 Active Directory에서 할당된 IPsec 정책을 확인할 때 하나 이상의 오류가 발생했습니다. 이 오류는 모든 정책 개체가 검색되기 전에 네트워크 연결의 오류이거나 IPsec 정책 또는 읽기 권한이 허용된 개체가 없어 발생했을 수 있습니다.

-   **PAStore 엔진이 Active Directory IPSec 정책의 변경 여부를 폴링하여 Active Directory 에 연결할 수 없으며 Active Directory IPSec 정책의 캐시 사본을 사용하여 마이그레이션했음을 감지했습니다 . 마지막 폴링 이후에 Active Directory IPSec 정책에 대해 변경한 사항은 적용할 수 없습니다 .** 이 메시지는 일정한 폴링 간격으로 IPsec 서비스가 성공적으로 Active Directory에 연결하지 못했고(예: DNS 서비스 손실로 인해) 현재 활성 IPsec 정책에 어떤 변경 사항도 없다는 것을 나타냅니다. 본래 활성 정책이 적용된 경우에만 Active Directory 연결이 사용 가능하고 IPsec 서비스는 캐시에서 최신 버전을 검색하고 저장하게 됩니다. 따라서, IPsec 서비스는 이제 IPsec 도메인 정책의 레지스트리 캐시가 정책의 기본 소스일 것이라고 추측합니다. 디렉터리에 도달하기 위해 폴링이 계속됩니다. 

  
##### IPsec 정책 해석 문제 해결
  
IPsec 정책의 해석은 완벽한 정책이 해당 저장소 위치에서 검색된 후에 수행됩니다. 최신 네트워크 인터페이스 IP 수소를 사용하여 정책의 일반 필터를 특정 필터로 확장합니다. 그런 다음 인바운드 및 아웃바운드 특정 필터의 목록이 패킷 처리를 위해 IPsec 드라이버로 로드됩니다. 인터페이스 변경 이벤트가 IPsec 서비스로 전달되어 필요한 경우(예를 들어, 내 IP 주소 필터의 경우) IPsec 드라이버의 IPsec 필터 구성을 가능한 빨리 조정합니다.
  
Windows 2000의 경우 다음 메시지가 정책을 적용을 위한 적합한 해석 또는 IPsec 구성 요소 구성과 관련된 문제를 나타낼 수 있습니다.
  
-   **데이터종류특성에알수없는데이터형식이지정되어있습니다**. IPsec 정책 일부에 정책 저장소 엔진이 인식하지 못하는 데이터 형식이 포함되어 있습니다. 이 오류는 정책 손상을 나타내거나 앞으로 일부 지점에서의 정책 버전 문제를 나타낼 수 있습니다. Windows XP 및 Windows Server 2003의 IPsec 정책 기능은 Windows 2000 IPsec 정책 에이전트에 투명하도록 제작되었습니다.
  
-   **데이터를 BLOB에서읽지못했습니다**. IPsec 정책 개체에서 IPsecData 특성의 데이터 형식이 예상한 것이 아닙니다. 이 오류는 항상 정책 손상 또는 버전 문제를 나타냅니다. 수정되어야 모든 IPsec 설정이 의도된 대로 성공적으로 적용됩니다.
  
-   **정책에이전트에인터페이스목록이없습니다.** IPsec 정책 에이전트가 필터링할 IP 네트워크 인터페이스를 찾지 못했습니다. 이 메시지의 텍스트의 오류는 Windows 소스 코드에서 직접 발생하거나 여기 나타난 것처럼 나타날 수 있습니다.
  
-   **Ip Public Help Api에서인터페이스테이블을가져오지못했습니다. 인터페이스에기반한필터가확장되지않으며 IPSEC 드라이버에연결되지않습니다.** IPsec 정책 에이전트가 컴퓨터의 인터페이스 목록을 나열하려고 했을 때 오류가 발생했습니다. 네트워크 인터페이스가 없거나 네트워크 인터페이스 관리자 내에 내부 오류가 있을 수 있습니다. 완전한 PnP 호환 장치, 파일 손상 또는 NIC 드라이버 내부 또는 기타 관련 Windows 네트워킹 구성 요소 문제가 원인일 수 있습니다. IPsec은 모든 연결보다는 특정 연결 유형(예: 원격 액세스)에 대한 규칙으로 구성된 인터페이스 유형에 기반하여 필터링합니다. 다시 시작한 후에도 문제가 지속되면 Microsoft 기술 지원 서비스에 문의하십시오.
  
-   **IP Public Help API에서 IP 주소테이블을가져오지못했습니다. 인터페이스에기반한필터가확장되지않으며 IPSEC 드라이버에연결되지않습니다.** IPsec 정책 에이전트가 IP 도우미 API의 함수 호출을 사용하여 컴퓨터의 모든 IP 주소를 나열하려고 했을 때 오류가 발생했습니다. 구성된 IP 주소가 없거나 위와 유사한 문제가 원인일 수 있습니다.
  
-   **IP 주소항목인덱스를인터페이스테이블에서찾지못했습니다. IP 주소를무시합니다**. IPsec 정책 에이전트는 모든 IP 주소가 네트워크 인터페이스 목록에 나타나는지 확인합니다. 새 네트워크 인터페이스가 추가 또는 제거되는 과도기적 상태로 인해 이 문제가 발생합니다. 이 메시지는 IPsec 서비스가 정책의 일반 내 IP 주소 필터에 대해 이 무시된 IP 주소에 대해 특정 필터를 만들지 않습니다. 이로서 이 IP 주소를 사용하면 일시적인 예상하지 못했던 연결 동작으로 나타날 수 있습니다. 그렇지 않으면, 이 오류는 IP 인터페이스 구성의 내부 상태의 문제를 나타낼 수 있으며 이 문제의 경우 Microsoft 기술 지원 서비스에서 추가로 진행을 조사해야 합니다. IP 주소가 IPsec 정책 에이전트(TCP/IP 스택이 아님)에 의해 무시되었기 때문에 어떠한 IPsec 필터도 해당 IP 주소에 대해 만들어지지 않습니다. 따라서 어떠한 보안 조치(예: 허용 또는 차단) 및 IPsec SA 협상 조치도 이 IP 주소를 사용한 트래픽에 대해 수행되지 않습니다.
  
-   **필터목록에일치하는필터미러가존재합니다**. 이 오류는 IPsec 정책에서 중복 필터 상태를 나타냅니다. IPsec 정책 설계는 인바운드 및 아웃바운드 방향에 대한 빠른 모드 특정 필터가 중복되지 않도록 분석되어야 합니다.
  
-   **주필터목록에추가된필터가없었습니다**. IPsec 정책 에이전트는 저장소에서 검색된 IPsec 정책에 필터가 없음을 발견했습니다. IPsec 정책은 기본 응답 규칙만을 포함하거나 규칙 또는 필터 목록을 확인하는 동안 오류가 발생했습니다.
  
-   **1 단계요청이없습니다. ISAKMP 정책을무시합니다.** IKE 주 모드 보안 방법(SAKMP 정책 개체)을 찾을 수 없는 경우에 IPsec 정책이 손상됩니다.
  
-   **2 ‹¨걀„ 요청이없습니다. 협상정책을무시합니다.** 필터 작업 보안 방법(IKE 빠른 모드 2 단계 요청)이 없는 상태에서 IKE는 해당 필터와 일치하는 트래픽에 대한 빠른 모드 협상에 실패합니다. IPsec 정책이 손상되었을 가능성이 있습니다.
  
-   **정책에유효한요청이없습니다**. IPsec 정책에 규칙의 필터 작업에 유효한 작업 방법이 없거나 IKE 주 모드에 대한 설정(일반 탭에서 구성한 키 교환 설정)이 포함되어 있지 않습니다.
  
-   **정책에이전트가기존필터를 IPSEC에삽입하려고시도했습니다.** IPsec 드라이버가 중복 필터가 있는지 검색하고 중복 필터를 거부합니다. 다른 필터가 IPsec 드라이버로 이미 처리된 것과 같이 중복 필터에 같은 조치가 있는 경우에도 심각하지는 않습니다. 그러나, 필터 작업이 다른 경우, 이는 지원되지 않는 IPsec 정책 설계입니다. 일정 시간 후의 결과가 다를 수 있고 정책 변경 사항이 처리된 순서에 따라 다릅니다. IPsec 정책은 중복을 피하도록 제작되어야 합니다.
  
-   **항목을 IPSEC 정책표에추가할수없습니다.** IPsec 정책 에이전트로 IPsec 드라이버에 새 필터를 추가하지 못했습니다. 이 오류는 해당 필터와 일치하는 트래픽의 보안이 유지되지 않음을 의미합니다. 낮은 커널 메모리 조건 하에서 이 오류가 발생할 수 있습니다. 오류가 지속되면 Microsoft 기술 지원 서비스에 문의하십시오.
  
-   **정책에이전트가 IPSEC에서필터를삽입하거나업데이트하지못했습니다.** 필터 삽입에 대한 이전 메시지와 같이 IPsec 드라이버의 필터 목록은 할당된 IPsec 정책이 요청한 것이 아닙니다. 따라서, 보안이 의도된 대로 제공되지 않습니다.
  
-   **Active Directory 저장소정책을적용하지못하여(네트워크가연결되지않거나정책무결성이올바르지않는이유로) 캐시된정책을사용합니다.** 도메인 기반 IPsec 정책이 할당되면 IPsec 정책 에이전트는 먼저 Active Directory에서 최신 정책을 확인하려고 합니다. 이 메시지는 해당 디렉터리에서 IPsec 정책을 검색할 수 없고 레지스트리에 캐시된 마지막 도메인 정책에서 정책을 적용하고 있다는 것을 보고합니다.  
  
Windows Server 2003의 경우 다음 이벤트는 IPsec 정책을 해석하는 중에 오류가 발생했음을 나타냅니다. 대부분의 경우에 Windows XP는 동일한 이벤트 텍스트를 사용합니다. IPsec 정책이 제대로 작동하려면 이 문제를 해결해야 합니다.
  
-   **PAStore 엔진이** "< **정책 이름** >" 에 대해 컴퓨터에 영구 저장소 IPSec 정책을 로드하지 못했습니다. **오류 코드는** <**번호** > 입니다. IPsec 서비스는 영구 정책이 레지스트리에 구성되어 있음을 확인했지만 모두 성공적으로 적용하지 못했습니다. 이미 적용된 영구 정책은 제거되고 IPsec 드라이버는 프로그래밍적으로 각 메시지에 따라 모드(부트 시간 제외)를 차단합니다.

-   **PAStore 엔진이** "< **정책 이름** >" 에 대해 컴퓨터에 로컬 레지스트리 IPSec 정책을 로드하지 못했습니다. **오류 코드는** < **번호** > 입니다. 이 메시지는 로컬 레지스트리에서 로컬 IPsec 정책을 적용하는 과정에서 적어도 한 개 이상의 오류가 발생했음을 나타냅니다. 이 메시지는 해당 정책이 손상되었거나 해당 권한이 잘못되었음을 나타냅니다.

-   **PAStore 엔진이 DN** " <**CN=ipsecPolicy{GUID}**" 에 대해 컴퓨터에 있는 Active Directory 저장소 IPSec 정책을 적용하지 못했습니다. 오류 코드는 <**번호**> 입니다. IPsec 서비스에서 **GPTIPsecPolicy** 레지스트리 키에 DN으로 지정된 도메인 정책을 발견했으나 적용하지 못했습니다. 이 메시지는 정보 제공용이며 도메인 컨트롤러가 모바일 클라이언트에 연결할 수 없다는 알림이기도 하지만 이 메시지 이후에는 캐시된 정책(있는 경우)을 성공적으로 응용해야 합니다. 그러나, GPO가 존재하지 않고, 읽을 수 없는 IPsec 정책을 구현하고 있거나 해당 정책이 손상되었음을 나타낼 수 있습니다.

-   **PAStore 엔진이** " <**정책 이름** >" 에 대해 컴퓨터에 있는 Active Directory 저장소 IPSec 정책의 로컬 캐시 사본을 적용하지 못했습니다. 오류 코드는   < 번호 > 입니다. 이 메시지는 IPsec 서비스가 도메인 정책이 할당되어야 함을 알고 있고 Active Directory에서 검색된 정책을 적용하지 못했음을 나타냅니다. 이제 로컬 레지스트리에서 할당된 도메인 정책의 캐시된 사본을 적용할 때 적어도 한 개 이상의 오류가 발생했습니다. 이 오류는 해당 캐시가 손상되었거나 해당 권한이 잘못되었음을 나타냅니다. 어떠한 도메인 정책도 적용되지 않아 다른 격리 도메인 구성원과의 연결에 영향을 끼칠 수 있으므로 매우 심각한 상황입니다. 로컬 정책(정의된 경우)이 우선 순위 순서에서 다음에 옵니다.

-   **PAStore 엔진이 컴퓨터에 있는 활성 IPSec 정책** "< **정책 이름** >" 의 일부 규칙을 적용하지 못했습니다. 오류 코드는 < 이름 > 입니다. IPSec 모니터 스냅인을 실행하여 자세하게 문제를 진단하십시오.이 문제는 일반적으로 빠른 모든 보안 방법(요청)이 없는 경우와 마찬가지로 여기에서 논의된 다른 문제와 관련되어 발생합니다.

-   **IPSec 서비스가 컴퓨터의 완전한 네트워크 인터페이스 목록을 얻지 못했습니다 . 이로 인해 일부 네트워크 인터페이스는 IPSec 필터를 적용하여 적절한 보호를 받지 못하기 때문에 컴퓨터에 잠재적인 보안 위험이 있을 수 있습니다 . IPSec 모니터 스냅인을 실행하여 문제를 더 자세히 진단해 보십시오.** 이 메시지는 Windows 2000에 사용된 몇 가지 IP 도우미 API 메지를 대체합니다. 무선 네트워크를 더 이상 사용하지 않는 경우처럼 인터페이스가 추가되고 제거되거나 연결 상태가 변하는 경우에 발생한다면 심각하지 않은 오류입니다. 동작 대기 또는 최대 절전 모드에서 다시 시작하는 동안에 발생하고 다시 시작 동안 검색되는 다른 네트워크 인터페이스 구성이 있는 경우에도 심각하지 않습니다.  
  
##### RRAS VPN 정책 구성 문제
  
이 장의 초반부의 계층 1 지원 섹션에서 언급한 것처럼 RRAS 서비스는 일부 조직에서 IPsec 정책 충돌의 일반적인 원인입니다. 이 섹션에서는 L2TP/IPsec VPN 서버에 대해 기본 제공된 IPsec 정책이 이 솔루션에 사용된 도메인 정책과 충돌을 일으키는 이유를 설명합니다. 이 상황은 중복 필터 문제의 한 가지 예입니다.
  
다음 논의에서 Woodgrove 은행 시나리오에 사용된 IPsec 정책 설계가 이 문제를 설명하기 위해 사용됩니다. 단, 이러한 원리는 대부분의 기업급 IPsec 배포에 적용됩니다.
  
L2TP/IPsec 서버용 IPsec 정책은 RASMAN(RAS Manager) 서비스에 의해 자동 생성되며 다음 필터를 포함합니다.
  
-   임의 IP 주소에서 내 IP 주소로, UDP, 원본 1701, 대상 임의(인바운드)
  
-   내 IP 주소에서 임의 IP 주소로, UDP, 원본 임의, 대상 1701(아웃바운드)
  
    **참고:** 이 정책에 대한 자세한 내용은 http://support.microsoft.com/?kbid=248750에서 제공되는 기술 자료 문서 248750,  "[Description of the IPSec policy created for L2TP/IPsec](http://support.microsoft.com/?kbid=248750)"을 참조하십시오.
  
따라서, 이 서버에 대한 IKE 협상 응답을 제어하는 주 모드 특정 필터는 인바운드 필터의 주소 부분입니다.
  
-   임의 IP 주소에서 내 IP 주소 -> 인증서 인증
  
"내 IP 주소"를 사용하면 인바운드 필터는 VPN 서버의 각 IP 주소로 확장될 수 있습니다. VPN 서버에 인터넷 연결에 대해 외부 인터페이스 IP 주소가 있고 LAN 연결에 대해 내부 인터페이스가 있다는 가정으로 IKE 주 모드 특정 인바운드 필터는 다음과 같습니다.
  
-   임의 IP 주소에서  <외부 인터페이스 IP 주소> -> 인증서 인증
  
-   임의 IP 주소에서  <내부 LAN 인터페이스 IP 주소> -> 인증서 인증
  
내부 LAN 인터페이스에 대한 두 번째 필터는 서버 및 도메인 격리 IKE 주 모드 인바운드 필터보다 더욱 구체적입니다.
  
-   임의 IP에서 서브넷 -> Kerberos 인증
  
따라서, 관리자가 트러스트된 클라이언트를 사용하여 VPN 서버를 관리하는 경우 IKE는 VPN 서버의 내부 IP 주소로 시작됩니다. IKE 인바운드 정책 조회는 더욱 구체적인 주 모드 필터와 일치하고 L2TP에 대한 IKE 주 모드 설정으로 회신합니다. 인증서 인증은 이 솔루션에 사용된 Kerberos 인증 대신에 사용됩니다.
  
두 번째 충돌 케이스는 인터넷 VPN 클라이언트가 연결 관리자 클라이언트의 차단 기능을 사용하는 경우에 발생할 수 있습니다. 차단 클라이언트는 "차단 키"를 VPN 서버의 내부 LAN IP 주소로 전달하여 차단을 끝내고 네트워크에 대한 전체 VPN 액세스 권한을 얻도록 해야 합니다. 이 시나리오에서 VPN 클라이언트 도메인 IPsec 정책은 랩톱 시작 시 캐시에서 적용됩니다. VPN 차단 연결이 성공적으로 구축되면 내부 IP 주소가 VPN 클라이언트에 할당됩니다. 클라이언트 내부 IP 주소는 도메인 격리 IPsec 정책에 정의된 서비스 필터(임의  <-> 내부 서브넷)로 보호되어야 합니다. 이 필터는 VPN 클라이언트가 VPN 터널을 통해 내부 서버 및 기타 워크스테이션에 액세스할 때 종단 간 IPsec 인증 액세스를 구성하는 데 필요합니다.
  
단, 이 솔루션의 서브넷 필터는 클라이언트 VPN 터널 가상 인터페이스의 내부 IP 주소에서 VPN 서버의 내부 LAN 인터페이스로 IKE 협상을 시작하게 됩니다. 서버가 도메인 및 서버 격리에 사용된 정책과는 호환되지 않는 *오직* 인증서 인증만을 수락하도록 응답하기 때문에 IKE 주 모드가 실패합니다. 정책이 인증성 인증을 허용하지 않은 경우 클라이언트의 IKE 빠른 모드는 모든 트래픽에 대해 필터를 제안하고 VPN 서버는 제안된 필터가 너무나 일반적이기 때문에 협상에 실패하게 됩니다. VPN 서버는 L2TP(UDP 원본 1701, 대상 임의 또는 UDP 대상 1701, 대상 1701)에 고유한 빠른 모드 필터만을 수락합니다.
  
RRAS 서버 L2TP/IPsec 정책과 격리 정책 간의 충돌을 해결하기 위해 다음 정책을 사용할 수 있습니다.
  
-   제외 목록에 RRAS 서버 내부 LAN IP 주소를 포함합니다.
  
-   VPN 서버에서 L2PT 포트를 사용 안 합니다. PPTP만을 사용합니다.
  
-   RASMAN에 **ProhibitIPsec** 레지스트리 키를 사용하여 L2PT에 대한 자동 IPsec 정책을 사용 안 합니다. 수동으로 UDP 1701 트래픽에 대한 인증서 인증에는 외부 IP 주소만을 내부 IP 주소를 사용하는 도메인 격리를 위한 모든 트래픽에 대해서는 Kerberos 인증만을 사용하도록 IPsec 정책 구성을 사용자 지정합니다.
  
    **참고:** 이 구성에 대한 자세한 내용은 http://support.microsoft.com/kb/240262에서 제공되는 기술 자료 문서 240262, "[How to Configure a L2TP/IPSec Connection Using Pre-shared Key Authentication](http://support.microsoft.com/kb/240262)"을 참조하십시오.
  
이 목록에서 가장 간단한 솔루션은 RRAS 서버의 내부 NIC가 IPsec을 사용하지 못하도록 제외하는 것입니다.
  
#### IKE 문제 해결
  
IKE와 IPsec은 가장 일반적으로 네트워크 필터링이 UDP 500 또는 IPsec 프로토콜 패킷을 허용하지 않기 때문에 처음 배포 시 실패합니다. 이러한 이유로, 사전 공유된 키를 사용하는 사전 정의된 예제 서버(요청) 정책과 같은 단순한 정책이 할당된 고정 IP 워크스테이션 또는 서버를 구축하는 것이 유용합니다. IKE 감사 이벤트를 수집하려면 감사를 사용해야 합니다. 기본 도메인 IPsec 정책이 동일한 사전 공유된 키로 인증되고 테스트 컴퓨터의 IP 주소에 대한 모든 트래픽(ICMP 포함)에 하나의 필터에 하나의 규칙이 포함된 모든 도메인 구성원에 배포됩니다.
  
그런 다음, 도메인 로그온 스크립트가 Ping을 수행하기 위해 배포되거나
  
```  
 <testserver>  
```  
```  
nbtstat –n  <testserver>  
```  
모든 도메인 구성원의 IKE 협상을 테스트 서버로 실행합니다. IKE 주 모드 성공 감사에 IP 주소를 분석 및 요약하여 모든 컴퓨터가 정책을 수신하고 있고 모든 네트워크 영역이 IKE 및 IPsec 프로토콜을 사용하여 테스트 컴퓨터에 연결할 수 있다는 것을 확인할 수 있습니다.  
다음에서 제공되는 URL을 사용하여 테스트 서버에서 각 지역에 위치한 컴퓨터로, 네트워크의 모든 영역에서 IPsec와 조각화가 작동하는 방법을 확인할 수 있습니다.
  
```  
ping –l 5000  <IP address>  
```  
–l 5000 옵션으로 Ping이 5000바이트 ICMP 패킷 페이로드를 발생시킵니다. 전체 IP 패킷은 IPsec 프로토콜로 캡슐화된 다음 온라인 전송 전에 IP 계층에서 조각화됩니다. 모든 조각이 대상에 수신되고 동일한 조각 수로 구성된 응답이 다시 전송됩니다. 경험을 통해 혼합하거나 다른 속도의 네트워크(예를 들어, 1기가비트 및 100메가비트 이더넷 간) 간 경계 역할을 하는 장치에 조각을 전달하는 문제가 있을 수 있다는 사실이 확인되었습니다. 이와 유사하게 , 다른 MTU 호스트(예: ATM(Asynchronous Transfer Mode), FDDI(Fiber Distributed Data Interface), 토큰 링)에 상주하는 호스트는 IPsec 보호 TCP 패킷에 대한 네트워크 경로를 제대로 찾기 위해 ICMP PMTU 메시지가 필요합니다. 다른 네트워크 MTU에 대한 자세한 내용은 http://support.microsoft.com/kb/314496에서 제공되는 기술 자료 문서 314496, "[Default MTU Size for Different Network Topology](http://support.microsoft.com/kb/314496)"를 참조하십시오.  
##### IKE 협상 문제 해결
  
IKE는 오류가 IKE 빠른 모드가 일반적으로 응답자인 컴퓨터에서만 시작되는 경우와 같이 특정 상황에서만 발생할 수 있기 때문에 문제를 해결하기 어렵습니다. 또한, 오류는 Kerberos 프로토콜 오류와 같은 인증 시스템의 오류 또는 호환되지 않은 정책 설계 또는 기존 정책이 도메인 정책과 통합되는 경우에 발생할 수 있습니다. IKE 오류로 인해 오류 상태를 경험하는 컴퓨터가 IKE 협상 참여를 중지하고 협상의 다른 컴퓨터가 재시도 한계를 모두 사용하여 시간이 초과됩니다. IKE가 실패하면 오류는 검토하고 변경 사항을 적용하지 않은 상태에서 로그를 수집하십시오. 표준 감사는 IPsec 구성 또는 서비스의 실행 상태를 변경시키지 않고 동적으로 활성화할 수 있습니다. 그러나 Windows 2000의 경우 IPsec 서비스는 **Oakley.log** 파일에 대한 상세한 IKE 로깅을 활성화하도록 다시 시작되어야 합니다. Windows XP SP2와 Windows Server 2003의 경우 IKE 로깅은 필요 시 명령 줄을 통해 활성화하고 비활성화할 수 있습니다.
  
일부 상황에서 IPsec 서비스를 중지하고 다시 시작하여 네트워크 트래픽을 검토하고 깨끗한 상태에서 **Oakley.log** 파일 결과를 수집해야 합니다. IPsec 서비스가 수동 또는 컴퓨터 다시 시작 또는 종료의 일환으로 중지되면 IKE는 삭제 메시지를 보내 모든 활성 연결 피어의 IPsec SA 상태를 정리하려 합니다. IKE가 모든 활성 피터에 삭제 메시지를 보내기를 완료하기 전에 운영 체제가 패킷을 보내는 기능을 비활성화하여 IPsec SA 상태가 피어에 남아 있을 수 있습니다. 이러한 상황이 발생하면 피어는 다시 시작된 컴퓨터에 안전하게 연결되어 있다고 믿게 됩니다. 다시 시작 후에 컴퓨터가 피어에 새 IKE 협상을 시작하지 않는 경우 피어는 IPsec SA가 다시 연결하려고 시도하기 위한 시간이 초과될 때까지 5분을 대기해야 합니다. SA를 다시 연결하려면 1분 동안 빠른 모드 협상을 먼저 시작한 후에 IKE 주 모드를 시작합니다.
  
Windows 2000 이후 릴리스에는 IKE 로깅이 향상되고 있습니다. 이 섹션에 문서화된 이벤트는 Windows 2000 이벤트의 특성이 유지하지만, Windows XP와 Windows Server 2003에 해당됩니다.
  
Windows 보안 로그는 IKE 협상 오류의 원인을 파악하려고 할 때 권장되는 시작 지점입니다. IKE 이벤트를 확인하려면 그룹 보안 정책 설정 "로그온 이벤트 감사"에서 성공 또는 오류에 대해 감사가 활성화되어야 합니다. 감사가 활성화된 후에 IKE 서비스는 감사 항목을 만들고 협상이 실패한 이슈에 대한 설명을 제공합니다. 그러나, IKE 협상 오류에 대한 설명은 항상 이벤트 547 오류로 보고되고 동일한 오류 메시지에는 예상되는 몇 가지 원인이 있습니다. 이벤트 547 오류 및 예상 원인에 대한 목록은 다음 섹션에 상세하게 설명되어 있습니다.
  
Windows XP SP2와 Windows Server 2003에서 모든 IKE 감사는 **DisableIKEAudits** 레지스트리 키로 비활성화할 수 있습니다. 조사 중인 컴퓨터에서 반드시 이 값을 확인하십시오. IKE 감사는 다른 로그온/로그오프 범주 이벤트가 효율적으로 모니터링될 수 없는 너무 많은 성공 또는 실패 이벤트를 생성하는 경우에 비활성화될 수 있습니다.
  
오류 코드 값은 IKE 감사 이벤트와 로그 세부 내역으로 보고되는 경우가 있습니다. 이러한 오류 코드 값에 대한 자세한 설명은 Microsoft MSDN®, http://msdn.microsoft.com/library/en-us/debug/base/system\_error\_codes\_\_12000-15999\_.asp의 [System Code Errors (12000-15999)](http://msdn.microsoft.com/library/en-us/debug/base/system_error_codes__12000-15999_.asp) 페이지를  
참조하십시오.
  
IKE 협상 문제를 해결하려면 IPsec 정책 설계의 예상 동작, IKE 협상 프로세스 및 IKE 오류 이벤트에 대한 심도 깊은 지식이 필요합니다. 이 섹션에서는 Woodgrove 은행 도메인 격리 시나리오와 관련된 가장 공통된 이벤트만을 설명하려 합니다. 모든 IKE 감사 이벤트 또는 오류 상황은 해결하지 않습니다.
  
IKE 협상 프로세스가 잘 이해되면 통신의 적어도 한 측의 네트워크 추적을 얻어 **Oakley.log** 파일을 수집하려 하기 전에 IKE 내의 문제를 확인할 수 있습니다. 서버 및 도메인 격리 시나리오의 배포된 서버는 네트워크 모니터로 추적을 수집할 수 있는 기능을 가지고 있어야 합니다.
  
**Oakley.log** 파일은 가장 자세한 로깅을 제공하고 협상 양측에서 모두 필요할 수 있습니다(동기화된 경우). 그러나, 이 로그를 활성화하면 IKE 협상 속도가 느려져 타이밍 조건을 변경시키고 서비스가 레지스트리 키(Windows 2000와 Windows XP SP1에서 필요)를 다시 읽도록 다시 시작된 경우 모든 기존 상태가 손실될 수 있습니다. 현재, **Oakley.log** 파일 해석에 대해 게시된 가이드는 없습니다. 이 가이드의 목적에 대해 그러한 해석은 계층 2 기술 집합의 일부로 고려됩니다. 공간 상의 제약으로 몇 가지 오류에 대한 로그 세부 정보에 대한 간단한 요약을 여기에 제공합니다. **Oakley.log** 파일 해석에 대한 자세한 내용은 Microsoft 기술 지원 서비스에 문의하십시오.
  
다음 네 가지 상세 로깅 파일이 IKE에 유지 관리됩니다.
  
-   **Oakley.log**. IKE에 대한 현재 로그(50,000줄로 제한)
  
-   **Oakley.log.bak**. 50,000줄이 **Oakley.log**에 쌓이면 이 파일이 만들어지고 새 빈 **Oakley.log** 파일이 시작됩니다. IPsec 서비스가 실행 중인 동안 필요한 경우 새 **Oakley.log** 파일이 이 파일을 덮어쓰게 됩니다.
  
-   **Oakley.log.sav**. 이전 **Oakley.log** 파일은 IPsec 서비스가 시작하면 이 이름으로 저장됩니다.
  
-   **Oakley.log.bak.sav**. 이전 **Oakley.log.bak** 파일은 IPsec 서비스가 시작하면 이 이름으로 저장됩니다.
  
문제 해결 과정 중에 범하게 되는 가장 일반적인 실수는 로깅과 네트워크 추적이 수집된 두 대의 컴퓨터의 시간을 동기화하지 않는 것입니다. 이로써 불가능한 것은 아니지만 로그의 상호 연관성을 어렵게 합니다. 네트워크 추적의 패킷에 대한 IKE 메시지의 상호 연관성은 ISAKMP 헤더 쿠키와 IKE 빠른 모드 메시지 ID 필드를 사용하여 교차 확인되어야 합니다.
  
##### 예상되는 IKE 동작
  
IKE 주 모드 초기화가 의도된 대상 IP 주소에 연결하지 못하도록 네트워크에서 차단된 경우 IPsec 보안 통신은 협상될 수 없습니다. 초기자가 선택을 취소하도록 구성되지 않은 경우 대상 연결 오류는 다음과 같은 텍스트 항목으로 보안 로그에 감사 이벤트 547로 나타납니다.
  
-   피어로부터 응답이 없습니다.
  
-   협상이 시간 초과되었습니다.
  
-   성립이 완료되기 전에 IKE SA를 감지했습니다.  
  
단, 도메인 격리 클라이언트의 경우 정책에서 선택 취소를 허용한다면 오류로 나타나지 않을 수 있습니다. IKE 주 모드 성공 이벤트 541은 소프트 SA가 구축되면 만들어집니다. 541 이벤트가 소프트 SA를 나타내는 표시는 아웃바운드 SPI가 0이고 모든 알고리즘이 없음으로 표시됩니다. 다음 예는 이러한 매개 변수가 541 이벤트에 어떻게 나타나는지를 보여 줍니다.
  
```  
 ESP Algorithm None HMAC Algorithm None AH Algorithm None Encapsulation None InboundSpi 31311481 (0x1ddc679) OutBoundSpi 0 (0x0) Lifetime (sec)  <whatever is configured for QM lifetime> Lifetime (kb) 0   
```  
**참고**: 동일한 대상 IP 주소에 대한 소프트 SA 이벤트는 다른 타임스탬프와 다른 인바운드 SPI 값을 갖게 됩니다.
  
활성 IKE 주 모드가 있는지와 관련하여 두 대의 컴퓨터가 동기화되어 있지 않을 때 마다 1분 연결 지연이 발생합니다. 5분 지연은 한 대의 컴퓨터가 해당 컴퓨터 간 활성 IPsec SA 쌍이 있고 다른 컴퓨터(예: 서버)가 이러한 SA를 삭제했고 빠른 모드 키 재지정을 시작하지 않은 경우에 발생할 수 있습니다. Windows 2000 IKE는 손실되는 경우가 있는 단일 삭제 메시지를 지원했습니다. Windows XP와 Windows Server 2003은 손실된 패킷의 보호 수단으로 여러 삭제 메시지 형태로 "안정적인" 삭제 기능을 지원하기 위한 지원을 추가했습니다.
  
가장 일반적인 시나리오는 도메인 격리 랩톱 사용자가 도킹 스테이션에서 랩톱을 꺼내 회의에 가져가는 상황입니다. 도킹 스테이션은 유선 이더넷 연결이고 네트워크 인터페이스를 제거하면 해당 인터페이스와 관련된 모든 필터도 제거되어야 합니다(내 IP 주소에서 확장된 필터인 경우).
  
단, 협상 기능을 가진 어떠한 필터도 도메인 격리 솔루션에서 내 IP 주소를 사용하지 않고 모드 임의  <-> 서브넷 필터를 사용합니다. 따라서, IPsec SA 및 IKE SA 상태는 이러한 필터가 각 주소 변경에 대해 삭제되지 않기 때문에 랩톱에서 활성 상태를 유지합니다. 필터가 "내 IP 주소"에서 확장된 경우 IP 주소가 사라지면 이러한 필터는 삭제됩니다.
  
어떠한 유형의 필터가 IPsec 드라이버에서 삭제될 때마다 드라이버는 IKE에게 해당 IP 주소를 사용하는 모든 IKE SA 및 IPsec SA도 삭제해야 합니다. IKE는 해당 SA에 삭제 메시지를 보내고 내부적으로 지우려 합니다. 이러한 삭제 메시지는 다른 원본 IP가 삭제 메시지가 전송될 때 연결된 인터페이스에 있을 수 있는 경우에도 IKE SA에 사용된 것과 동일한 소스 IP가 포함됩니다. 원본 IP 주소는 ISAKMP 헤더 쿠키 쌍이 인식되고 패킷에 대한 암호화 문제가 유효한지는 원격 컴퓨터에 중요하지 않습니다. 그러나, 삭제 메시지는 연결 끊기가 발생한(랩톱을 꺼내는) 몇 초 만에는 네트워크 연결이 없기 때문에 삭제 메시지가 전송되지 않을 수 있습니다.
  
이러한 임의  <-> 서브넷 필터의 특별한 경우에 필터는 절대로 삭제되지 않습니다. 이는 IKE와 IPsec SA가 즉시 삭제되지 않았음을 의미합니다. 잠시 동안 형식적으로 연결된 원격 컴퓨터에서 IPsec SA이 시간 초과되고 IKE 빠른 모드 삭제 메시지가 이전의 랩톱 주소로 전송됩니다. IKE 주 모드 SA는 이러한 원격 컴퓨터에서 기본 8시간 동안 활성화 상태를 유지하지만 IKE에 알려진 내부 이유가 발생하기 전에 언제라도 삭제될 수 있습니다. 물론, IKE SA 삭제 메시지는 이전 IP 주소로 랩톱에서 수신되지 않습니다. 마지막으로 랩톱이 도킹 스테이션에 다시 연결되면 동일한 IP 주소를 다시 받습니다. 파일 공유, 전자 우편 클라이언트 및 기타 응용 프로그램은 일반적으로 동일한 대상에 다시 연결합니다. 그러나, 랩톱과 이러한 원격 대상 간의 IKE 상태에 차이가 있을 수 있습니다. 랩톱에는 IKE 기본 상태가 유지된 경우 IKE 빠른 모드 협상을 시도하게 됩니다. 빠른 모드는 원격 피어가 삭제한 암호화 상태를 사용해서 이러한 메시지를 인식하지 못하고 응답하지도 않습니다. 랩톱에서 IKE는 1분 후에 재시도 제한을 만료한 후에 새 IKE 주 모드 협상을 시도하고 결국 성공합니다. 따라서, 랩톱 사용자는 원격 리소스 연결 시 1분 지연을 알게 됩니다. Microsoft는 IPsec을 지원하는 모든 Windows 버전의 향후 업데이트에 이 동작을 개선할 수 있을 것으로 기대합니다.
  
IKE 협상은 다양한 이유로 인한 시간 제한을 보고할 수 있습니다. IKE가 "성립이 완료되기 전에 IKE SA를 감지했습니다." 이벤트로 협상이 시간 초과되는 경우를 제외하고 재시도 한계를 모두 사용했기 때문에 IKE 협상의 단계(선택 취소 제외)가 실패하는 경우 "협상이 시간 초과되었습니다." 이벤트가 발생합니다. 이러한 두 개의 이벤트는 본질적으로 동일합니다. 다음과 같은 이벤트가 발생하면 네트워크 연결 상태를 빈번하고 신속하게 변경하는 모바일 클라이언트에 대한 일상적인 작업 동안 예상되는 심각하지 않은 일반적 이벤트입니다.
  
-   사용자가 도킹 스테이션에 랩톱 장착 또는 제거
  
-   사용자가 연결선 분리
  
-   랩톱 컴퓨터 최대 절전 모드 또는 대기 모드로 전환
  
-   연결선 범위 외부로 컴퓨터 이동
  
-   VPN 연결 해제
  
-   연결된 상태에서 PCMCIA 네트워크 카드 꺼내기
  
원격 컴퓨터에서 이러한 이벤트로 마치 피어 컴퓨터가 네트워크에서 사라진 것처럼 보입니다. 원격 컴퓨터는 IKE 협상 단계가 시간 초과될 때까지 키 재지정 또는 재협상을 시도합니다.
  
네트워크 시간 초과 오류는 Windows Server 2003에서 향상되어 IKE 협상에서 시간 초과가 협상의 마지막 성공 단계를 확인함으로써 발생했는지 확인됩니다. 이러한 이벤트는 IKE가 NAT - T 기능 없이 협상하는 경우에 네트워크 주소 변환(NAT)가 있음으로써 발생할 수 있습니다. 단, 원격 피어에 IKE 협상 원인이 발생한 경우에도 IKE 협상이 시간 초과됩니다.
  
따라서, 모든 협상 시간 초과 및 "성립이 완료되기 전에 IKE SA를 감지했습니다." 이벤트의 경우에 계층 2 지원에서 IKE가 시간 초과를 로그하기 최대 1분 동안 해당 컴퓨터에서 547 오류 및 이벤트를 확인함으로써 원격 컴퓨터가 협상에 실패했는지 확인해야 합니다.
  
###### IKE 협상 성공 이벤트
  
IKE 협상이 성공한 경우 IKE 주 모드 SA는 IPsec 모니터 MMC 스냅인 및 명령줄 쿼리 도구를 통해 나타납니다.
  
**현재 IKE 주모드 SA의목록을표시하려면**
  
-   Windows 2000의 경우:
  
    ```  
        ipsecmon.exe, netdiag /test:ipsec /v   
    ```
  
    **참고**: 이 명령은 IKE 주 모드 SA가 아닌 IPsec SA만을 보여 줍니다.
  
-   Windows XP의 경우:
  
    ```  
        IPsec monitor snapin, ipseccmd show sas   
    ```
  
-   Windows Server 2003의 경우**:**
  
    **참고:** 이 줄은 편의를 위해 여러 줄로 나눌 수 있습니다. 단, 시스템에서는 분리 표시 없이 한 줄로 입력해야 합니다.
  
    ```  
        IPsec monitor snapin, netsh ipsec dynamic show \[mmsas | qmsas\]   
    ```
  
성공적인 주 모드 및 빠른 모드 SA는 감사가 활성화된 경우 보안 로그에 다음 이벤트를 생성하게 됩니다.
  
-   **541**. IKE 주 모드 또는 퀵 모드 설정
  
-   **542**. IKE 퀵 모드 삭제
  
-   **543**. IKE 주 모드 삭제
  
##### IKE 주 모드 정보 제공용 로그 항목
  
주 모드 변경에 문제가 있는지를 확인하려면 컴퓨터의 이벤트 로그에서 다음 기록된 이벤트를 살펴보십시오.
  
**표 7.5: IKE 주모드정보제공용로그메시지**

 
<table style="border:1px solid black;">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead>
<tr class="header">
<th style="border:1px solid black;" >로그 텍스트</th>
<th style="border:1px solid black;" >설명</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="border:1px solid black;">새 정책이 이전 정책으로 만들어진 SA를 유효화했습니다.</td>
<td style="border:1px solid black;">IPsec 정책 변경이 현재 IKE 또는 IPsec SA의 삭제로 인해 발생했음을 나타내는 Windows 2000 메시지입니다. 이 오류는 무시해도 좋습니다. 새 IPsec SA가 새 IPsec 정책을 사용하는 현재 트래픽 흐름에 기반하여 형성됩니다.</td>
</tr>
<tr class="even">
<td style="border:1px solid black;">IKE에는 수많은 보류 중인 보안 연결 구축 요청이 있으며 DoS(서비스 거부) 방지 모드를 시작합니다.</td>
<td style="border:1px solid black;">이 상태는 시스템 부하량이 높고 다량의 클라이언트 연결 시도로 인해 발생되는 정상적인 상태입니다. IKE에 대한 DoS(서비스 거부)의 결과일 수도 있습니다. DoS(서비스 거부)로 인해 발생한 경우 실패한 IKE 협상에 대해 스푸핑된 IP 주소인지 많은 감사를 진행하게 됩니다. 그렇지 않으면, 컴퓨터는 과도한 부하에 시달리게 됩니다.<br />
IKE는 IKE 주 모드 SA 구축 요청으로 플러딩되어 DoS(서비스 거부) 공격 응답 전략의 일부로 상당 부분 손실하려고 한다는 것을 나타냅니다.</td>
</tr>
<tr class="odd">
<td style="border:1px solid black;">DoS(서비스 거부) 방지 모드로부터 복구했으며 정상 작동을 계속합니다.</td>
<td style="border:1px solid black;">IKE는 DoS(서비스 거부) 공격 상태로 여겨지는 상태에서 복구되어 정상 작동 상태를 재개했습니다.</td>
</tr>
</tbody>
</table>
  
이러한 항목이 있다는 사실이 곧 통신 실패를 의미하는 것은 아닙니다. 이러한 항목은 정보 제공용이며 문제의 실제 원인을 파악하는 데 도움을 주기 위한 추가 정보를 제공하는 데 사용될 수 있습니다.
  
###### IKE 주 모드 협상 오류 이벤트 \#547
  
다음 IKE 오류 이벤트는 IKE 주 모드 협상이 실패할 때 발생할 수 있습니다.
  
-   **피어로부터응답이없습니다**. 이 이벤트는 IPsec을 사용하지 않고 제외 목록의 구성원이 아닌 컴퓨터의 아웃바운드 연결에 예상됩니다. 단, 계층 2 지원은 IKE 협상을 차단하는 연결 문제에 대해 알려 이 이벤트를 생성하기도 합니다.
  
-   **정책구성안됨**. 이 이벤트는 원본 IP 주소가 내부 서브넷 내의 주소인 경우의 문제를 나타내거나 일치하지 않는 필터 집합을 나타낼 수 있습니다. 그렇지 않으면, 컴퓨터에 특정 주소 범위 도는 서브넷을 협상하기 위한 규칙이 없다는 것을 예상할 수 있습니다. 그러한 서브넷의 컴퓨터는 IKE 시작을 시도하지만 구성된 정책이 없기 때문에 회신을 얻지 않습니다.
  
-   **IKE 보안특성을받아들일수없습니다**. 이 이벤트는 제대로 구성된 시스템에서 발생하지 않습니다. 문제의 원인을 파악하려면 "올바른 IPsec 정책 확인" 섹션의 단계를 완료하십시오.
  
다음 "협상이 시간 초과되었습니다." 메시지는 이전에 논의된 이유로 인해 발생할 수 있습니다. 또한, 원격 컴퓨터가 IKE 협상에 실패했음을 나타낼 수도 있습니다. 일반적으로 , 계층 2 지원은 연결이 중단된 컴퓨터의 가장 일반적인 원인인 협상 시간 초과와 IKE 모드 또는 IKE 빠른 모드 협상에 대한 응답자가 들어오는 요청에 대한 특정 필터를 찾지 못하는 정책 설계 비호환성이라는 보다는 원격 컴퓨터의 IKE 오류를 조사하는 데 집중합니다.
  
-   협상이 시간 초과되었습니다.
  
-   협상이 시간 초과되었습니다. - 처리된 첫 번째(SA) 페이로드 응답자 델타 시간 63
  
-   협상이 시간 초과되었습니다. - 처리된 두 번째(SE) 페이로드 초기자 델타 시간 63
  
-   협상이 시간 초과되었습니다. - 처리된 두 번째(SE) 페이로드 응답자
  
###### IKE 빠른 모드 감사 오류(547)
  
다음 IKE 오류 이벤트는 IKE 빠른 모드 협상이 실패할 때 발생할 수 있습니다.
  
-   정책 구성 안됨-처리된 세 번째(ID) 페이로드 초기자
  
-   특성 불일치로 보안 연결 협상 실패
  
-   일반 처리 오류
  
-   IPsec 드라이버로부터 들어오는 SA에 대한 새 SPI를 얻을 수 없습니다.
  
-   IPsec 드라이버가 Oakley 협상에 실패함(필터가 존재하지 않음)
  
-   IPSec 드라이버에 보안 연결을 추가하려는 시도가 실패했습니다.
  
-   협상이 시간 초과되었습니다.
  
IKE 빠른 모드는 올바르게 설계된 IPsec 정책 및 일반 운영 부하 상태에서는 실패하지 않습니다. 이러한 오류가 수신된 경우 계층 2 지원은 먼저 "올바른 IPsec 정책 확인" 섹션의 단계를 먼저 따라야 합니다. 그런 다음, 계층 2 지원은 이러한 이벤트와 100% CPU 사용률 또는 매우 낮은 커널 메모리 상태와 같은 비정상적인 성능 상태와의 연관성을 조사해야 합니다.
  
협상 시간 초과로 인한 IKE 빠른 모드 오류는 컴퓨터가 더 이상 이전에 설명된 이유에 대해 이전 IP 주소를 사용하지 않는 경우에 발생할 것으로 예상됩니다.
  
##### 인증으로 발생된 IKE 오류 문제 해결
  
다음 메시지는 IKE 인증 오류와 관련됩니다.
  
-   지정된 대상을 알 수 없습니다 / 인증에 대한 기관에 연결하지 못했습니다.
  
-   지정한 대상에 도달할 수 없거나 대상을 알 수 없습니다. - 처리된 첫째(SA) 페이로드 초기자 델타 시간 0
  
-   IKE 인증 자격 증명을 받아들일 수 없습니다.
  
-   로그온하지 못했습니다.
  
-   Kerberos를 사용하여 인증하지 못했습니다.
  
-   IKE가 올바른 컴퓨터 인증서를 찾지 못했습니다.
  
처음 두 개의 메시지는 원격 컴퓨터에 대한 서비스 티켓에 Kerberos ID를 얻기 위해 원격 컴퓨터를 사용할 수 없음을 나타냅니다. 도메인 트러스트가 없거나 도메인 컨트롤러에 대한 액세스를 사용할 수 없기 때문에 이러한 상황이 존재합니다.
  
아웃바운드 IKE 협상이 "네트워크에서 이 컴퓨터 액세스" 설정으로 인해 실패하는 경우 액세스 권한을 강제 적용하는 측의 IKE 협상은 이전에 설명된 대로 547 이벤트 "Kerberos를 사용한 인증 실패"를 보고합니다. 해당 이벤트는 "네트워크 권한으로 이 컴퓨터 액세스"를 선택할 때 문제가 오류인 것을 명시적으로 나타내지 않으며, 따라서 **Oakley.log** 파일은 생성된 특정 오류를 확인하기 위해 서버에서 획득되어야 합니다. IKE 초기자의 그룹 구성원은 실제로 승인된 그룹의 구성원인지를 확인하기 위해 조사 받아야 합니다. 컴퓨터가 승인된 권한을 가진 그룹 구성원인 경우 컴퓨터는 새 구성원을 반영하는 Kerberos 티켓을 갖지 못할 수 있습니다. 또한, 컴퓨터는 적절한 Kerberos 티켓을 얻지 못할 수 있습니다. 이 장 초반의 "도메인 컨트롤러의 연결 및 인증 확인"에 논의된 절차를 완료하십시오.
  
#### 응용 프로그램 관련 문제 확인
  
이 섹션에서는 응용 프로그램 설계가 Microsoft Windows의 IPsec 사용과 사용 작용하는 방법을 다룹니다. IPsec 설계자는 이러한 영향을 이해하고 지원 직원은 이러한 영향을 이해하여 신속하게 문제를 분류하고 확인할 수 있도록 지원해야 합니다. IPsec 정책 적용은 응용 프로그램에 굉장히 투명합니다. 그러나, IPsec 정책이 할당 또는 트래픽을 보호하는 환경은 응용 프로그램이 다르게 작동되도록 할 수 있습니다. 다음 섹션에서는 Woodgrove 은행 도메인 격리 솔루션의 컨텍스트에서 이러한 내용을 강조합니다.
  
##### ICMP이 허용되었지만 TCP와 UDP에서 IPsec이 필요합니다.
  
일부 응용 프로그램은 ICMP 에코 요청(Ping) 메시지를 사용하여 대상 주소에 도달할 수 있는지를 확인합니다. 예를 들어, IPsec은 이 솔루션에서 ICMP 트래픽을 보호하지 않아 응용 프로그램은 목적 대상에서 ICMP 응답을 받을 수 있습니다. 단, 응용 프로그램은 IKE 협상이 실패하면 IPsec 보호 TCP 및 UDP를 사용하여 목적 대상에 연결할 수 없을 수 있습니다.
  
##### 초기 연결 지연
  
IKE 협상은 TCP 3방향 핸드셰이크 또는 인증되지 않은 Nbtstat 단일 패킷 쿼리 및 응답 이상을 완료하는 데 상당히 더 많은 처리 및 시간이 필요합니다. 목적 대상에서 빠른 TCP 또는 UDP 연결 응답을 기대하는 응용 프로그램은 대상이 응답하지 않는 것을 파악하고 오류 보고 또는 대체 대상에 대한 연결 시도와 같은 다른 조치를 취할지 결정할 수 있습니다. Kerberos 인증을 사용하는 IKE 협상은 일반적으로 성공적으로 1-2초 이내에 완료됩니다. 그러나, 이러한 타이밍은 특히 컴퓨터와 네트워크 패킷 손실의 CPU 사용량과 같은 많은 요인에 의존합니다. 선택 취소는 TCP 핸드셰이크의 첫 번째 패킷이 보호되지 않은 상태로 전송되기 전에 항상 3초를 기다려야 합니다.
  
##### 네트워크 응답을 대기하는 응용 프로그램 중지
  
일부 응용 프로그램은 오류 메시지를 연결 또는 수신할 시간이 매우 빠르다는 것으로 작성됩니다. 이러한 응용 프로그램은 연결이 사용자 인터페이스에 변경 사항을 표시하기 전에 완료(소켓 바인딩 작업이 완료)되기를 기다려야 합니다. 이러한 응용 프로그램 트래픽이 IPsec의 보호를 받으면 응용 프로그램은 성공적인 연결 동안 잠시 중단될 수 있습니다. 이 응용 프로그램은 IKE 협상 오류 또는 IPsec 차단 필터로 인해 연결이 성공하지 못하는 경우 종료되거나 다른 비정상적인 오류가 발생할 때까지 대기합니다. 네트워크 소켓 계층은 IPsec 필터 도는 IKE가 트래픽의 보안을 협상하고 있다는 것을 알지 못합니다. 응용 프로그램은 일반적으로 이러한 상태를 원격 호스트 다운 또는 네트워크 오류로 인해 발생되는 것으로 해석합니다. 단, 사용할 수 없거나 연결이 거부된 대상 컴퓨터에 의해 유발되었기 때문에 도메인 컨트롤러에 도달할 수 없는 오류를 해석할 수도 있습니다.
  
##### 영향을 받는 커널 모드 네트워크 패킷 처리
  
네트워크 드라이버 또는 커널 레벨 패킷 처리와 관련된 응용 프로그램은 IPsec이 트래픽을 보호하는 경우 제대로 작동하지 않습니다. 이러한 응용 프로그램은 패킷을 변경하여 IPsec이 패킷을 손실하게 할 수 있습니다. 또한, 응용 프로그램은 IPsec 수정으로 인해 혼동되어 시스템 오류(파란색 오류 화면)가 발생할 수 있습니다.
  
##### 영향을 받는 격리 도메인의 호스트에서 네트워크 검색
  
네트워크에서 원격 IP 주소 또는 개방형 포트를 신속하게 조사하는 호스트 기반 도구는 IPsec이 조사 트래픽을 보안하려고 하는 경우 더욱 느리게 실행됩니다. 조사 트래픽은 IKE가 단 몇 초 또는 몇 분 내에 수백 개의 IP 주소를 초기화하여 로컬 호스트에 DoS(서비스 거부)를 일으킵니다. SNMP 기반 도구는 이벤트 수집기로서 작동되는 트러스트되지 않은 호스트로 전송되는 SNMP 트랩 이벤트에 따라 다릅니다. IPsec이 선택 취소를 허용해도 아웃바운드 SNMP 트랩 패킷은 소프트 SA가 구축되기 전에 IPsec 드라이버에 의해 무시될 수 있습니다. 이와 유사하게 일부 UDP 기반 응용 프로그램(예: NTP 및 Windows 도메인 컨트롤러 로케이터)만은 응답을 받을 때까지 3초를 기다려서 대상에 도달할 수 없는 응용 프로그램 오류 또는 거짓 보고서를 유발합니다.
  
##### Winsock 계층화된 서비스 공급자(LSP) 문제
  
일부 합법적인 응용 프로그램(예: 개인 방화벽) 및 일부 악의적인 응용 프로그램(예: 스파이웨어)은 자신의 네트워크 트래픽 주입 기능(일명, Winsock 계층화된 서비스 공급자(LSP))을 삽입하여 문제를 일으킬 수 있습니다. Microsoft IPsec 구현의 IKE 구성 요소는 WSAIoctl() 호출을 통해 확인된 함수 포인터가 있는 확장형 Winsock API 함수를 사용합니다. 이러한 함수 호출이 설치된 LSP를 통해 전달이 허용되지 않은 경우 IKE는 필요한 UDP 포트를 모니터할 수 없습니다. Windows Server 2003의 경우에 IPsec은 이를 필요한 구성 요소의 오류로 해석하고 보안 정책을 강제 적용하여 방어적으로 반응합니다. "보안 모드 실패"가 호출되고 IPsec 드라이버는 차단 모드가 됩니다. 관리자가 데스크톱 로그인을 사용하여 IPsec 서비스를 중지함으로써 로그인하여 연결을 복원해야 합니다. IPsec 서비스가 중지 요청에 응답하지 않는 경우 IPsec 서비스는 비활성화됨으로 구성되고 컴퓨터는 다시 시작되어야 합니다.
  
IKE가 적합한 초기화를 하는 것처럼 보이더라도 컴퓨터가 IKE 및 IPsec 프로토콜을 송수신하는 기능은 LSP 또는 다른 설치된 타사 프로그램에 의해 차단될 수 있습니다.
  
계층 2 지원의 경우 Winsock LSP 문제 해결은 LSP가 있는지 여부를 확인하는 절차가 포함됩니다. 계층 3 지원이 관련되어 LSP를 설치한 응용 프로그램을 확인하고 순서를 다시 지정하거나 제거하여 IPsec 서비스 또는 IKE가 더 이상 문제가 없는지를 확인하기 위한 추가 조사를 수행합니다. Winsock LSP 검색 도구는 다음과 같습니다.
  
-   **Sporder.exe**. Windows SDK(소프트웨어 개발 키트)의 Winsock 2.0 부분에서 LSP를 검토하는 데 사용할 수 있는 애플릿입니다.
  
-   **Netdiag /debug**.
  
##### 타사 IPsec VPN 클라이언트
  
타사 IPsec 구현이 원격 액세스 VPN 클라이언트 과정에서 설치되면 많은 문제가 발생할 수 있습니다. 일반적으로, 이러한 클라이언트는 IPsec 서비스를 비활성화하고 기본 Windows IPsec과 충돌하지 않습니다. 단, 이 솔루션의 트러스트된 도메인의 구성원의 경우 기본 IPsec 서비스가 필요합니다. 따라서, 타사 IPsec 구현이 다음 이유로 충돌할 수 있습니다.
  
-   두 가지 IKE 구현은 UDP 포트 500이 필요할 수 있습니다.
  
-   두 가지 IKE 구현에 대한 IPsec 커널 패킷 처리는 ESP 프로토콜이 필요할 수 있습니다.
  
-   클라이언트 일부로 설치된 Winsock LSP 기능.
  
-   VPN 클라이언트가 제공한 방화벽 기능.
  
-   기본 IKE 및 IPsec 캡슐화 패킷이 타사 IPsec 터널을 통해 전달되지 못하게 하는 계층.
  
VPN 공급업체는 기본 Windows IPsec 서비스가 활성회되고 있는지와 IPsec 보호 통신 모드 트래픽이 원격 액세스 연결을 통해 종단 간에 지원되는지에 대한 최신 정보 소스일 수 있습니다. 일부 경우에, VPN 공급업체 게이트웨이는 Windows 2000와 Windows XP PPTP 및 L2TP/IPsec VPN 클라이언트를 지원합니다. 원시 Windows VPN 클라이언트는 VPN 터널을 통해 종단 간 IPsec 전송 모드와 호환되지 않습니다.
  
[](#mainsection)[페이지 위쪽](#mainsection)
  
### 계층 3 문제 해결
  
계층 2 문제 해결이 이 문제를 해결하지 못한 경우 문제를 분석하고 해결책을 찾는 데 보다 전문적인 지식이 필요하게 됩니다. 이 전문 지식은 계층 3 지원으로 여겨집니다. 대부분의 경우에 이 지원은 계약된 IPsec 전문가 또는 Microsoft의 기술 지원 서비스와 같은 지원 조직을 통해 제공됩니다.
  
계층 3 IPsec 지원은 IPsec 운영 및 Microsoft TCP/IP 스택에 대한 심도 깊은 이해가 필요합니다. Tier 3 지원 직원은 IPsec와 서버 및 도메인 격리 시나리오에서의 IPsec의 사용에 대한 중대한 교육이 필요합니다. 계층 3 직원 구성원이 획득하는 기술을 통해 낮은 계층의 구성원 교육과 기술 요약, 백서, 지원 가이드, FAQ 및 IPsec 아키텍처 및 개요에 대한 정보 개발을 담당하게 됩니다. 계층 3 지원은 긴급 복구 계획의 개발 및 문서화를 담당할 수도 있습니다.
  
#### Microsoft 기술 지원 서비스 관련
  
이 장에 설명된 문제 해결 절차가 귀하의 문제를 해결하는 데 도움이 안 되거나 귀사가 고급 문제 해결 방법을 사용할 만한 충분한 전문 지식을 가지고 있지 않은 경우 문제를 Microsoft 기술 지원 서비스로 제기해야 할 수도 있습니다. 가능한 기술 지원 서비스 개입을 요청하기 전에 로그와 네트워크 모니터링과 같은 가능한 진단 정보를 많이 수집하는 것이 중요합니다. 이 목록을 사용하여 계층 3 지원 또는 Microsoft 기술 지원 서비스가 해당 문제를 분석하는 데 필요한 정보를 수집하십시오.
  
-   각 컴퓨터에 대한 아웃바운드와 아웃바운드 인증 및 승인에 대한 보안 요구 사항. 컴퓨터의 그룹 정책 및 IPsec 구성이 이러한 요구 사항을 충족하는 방법을 설명하기 위해 간략한 설명을 제공해야 합니다.
  
-   원본과 대상 컴퓨터의 이름, 로그 파일 수집 당시의 IP 주소 및 운영 체제 버전(서비스 팩 정보 포함)을 보여주는 대표적인 시나리오 다이어그램 또한, DNS 서버, WINS 서버 및 도메인 컨트롤러의 IP 주소를 나타냅니다.
  
-   동시에 패킷이 쉽게 두 개의 추적 파일에서 연관되도록 하기 위해 IPsec 정책 활성화 상태에서 각 측에서 일어난 통신의 네트워크 모니터 추적. 네트워크 추적에는 승인 요청, DNS 조회 및 기타 관련 트래픽이 확인될 수 있도록 각 컴퓨터에서 모든 인바운드 및 아웃바운드 트래픽이 포함되어야 합니다. 또한, IPsec 정책이 활성화되고 IPsec 정책이 비활성화되거나 서비스가 중단된 상태에서 성공하는 동안 통신이 실패하면 IPsec이 활성화되지 않은 트래픽의 네트워크 추적도 사용할 수 있게 됩니다. 로그와 추적 파일이 상호 관련될 수 있도록 이러란 시스템 간에 시스템 시간이 동기화되는 것이 중요합니다.
  
-   Windows 2000, Windows XP 및 Windows Server 2003의 경우
  
    ```  
        netdiag /debug >netdiag-debug-computername.txt  
    ```  
    네트워크 추적 수집 전 또는 후에 로그 출력을 실행해야 합니다 (Netdiag는 네트워크 추적의 부분일 필요가 없는 많은 네트워크 트래픽을 생성). Windows XP 및 Windows Server 2003의 경우  
    
    ```  
        portqry -v -local >portqry-v-computername.txt.  
    ```
  
-   프로그램이 발생하는 시기 및 네트워크 모니터 추적이 기록되는 시간에 수집된 각 층의 IKE **Oakley.log** 파일을 실행합니다. 이러한 파일의 파일 이름은 컴퓨터 이름을 나타내야 합니다. Windows RAS 또한 VPN 클라이언트가 관련된 경우 RASDIAG 도구가 사용되어 정보를 수집해야 합니다.
  
-   **Oakley.log** 파일 및 네트워크 추적이 수집된 시기의 각 컴퓨터의 전체 시스템 로그, 보안 로그 및 응용 프로그램 로그.
  
-   **Oakley.log** 및 네트워크 추적이 수집된 동시에 생성된 그룹 정책 특정 로그 파일.
  
-   각 컴퓨터에 대한 IPsec 정책의 세부 정보. 각 컴퓨터에 적용되는 IPsec 정책은 쉽게 저장될 수 있으며, 포함되어야 합니다. 단, 컴퓨터의 할성 IPsec 정책은 도메인 또는 로컬 정책이 아닌 IPsec 정책 구성의 몇 가지 유형의 조합입니다. 컴퓨터의 활성 정책 분석에 대한 최상의 형식은 IKE 주 모드 특정 필터 및 IPsec 모니터 MMC 스냅인의 IKE 빠른 모드 특정 필터의 목록입니다.
  
**이러한필터의포맷된테스트파일을만들려면**
  
1.  트리의 왼쪽 창의 **IKE Quick Mode Specific Filters** 노드를 오른쪽 클릭합니다.
  
2.  **Export List**를 선택합니다.
  
3.  탭으로 분리된 텍스트 파일을 **IKE-qm- *<specific-computername>* .txt** 또는 컴퓨터 이름이 포함된 유사한 명명 규칙으로 저장합니다.
  
모든 필터의 세부 정보가 있는 탭으로 분리된 파일은 스프레드시트 또는 워드 프로세싱 문서로 가져올 수 있습니다.
  
[](#mainsection)[페이지 위쪽](#mainsection)
  
### 요약
  
이 장은 계층 1 지원(지원 센터 직원) 및 계층 2 지원(IT 전문 네트워크 지원 직원) 모두가 공통된 IPsec 통신 문제를 해결하는 방법을 이해하는 프로세스에 대한 상세한 정보를 제공했습니다. IPsec 및 네트워크 보안이 너무 복잡하여 모든 변형 형태를 목록화할 수 없기 때문에 모든 예상 오류에 대한 정보를 제공하는 것인 불가능합니다. 적용되는 경우 이 장의 개발자는 이 가이드에 상세하게 설명되어 있는 서버 및 도메인 격리 환경의 유형에 문제를 가장 많이 겪게 될 수 있는 영역에 대한 안내에 주력하기 위해 예상 옵션을 능률적으로 관리했습니다,.
  
이 가이드에 제공된 예제 스크립트는 효율성 입증을 위해 Woodgrove 은행 시나리오 테스트 랩 환경에서 테스트되었습니다. 단, 이러한 스크립트는 조직의 요구를 충족하도록 사용자 지정되어 제작되어 Microsoft에서는 지원하지 않습니다.
  
IPsec 문제 해결이 기술적으로 복잡하고 네트워킹, Active Directory 및 그룹 정책을 포함하여 IPsec 이외의 많은 기술 영역의 기술이 필요하다는 것은 독자들에게 분명합니다. 그러나, 이 장에 제공된 정보를 통해 독자는 모두는 아니지만 서버 및 도메인 격리 솔루션에 영향을 끼칠 수 있는 가장 모호한 문제를 해결할 수 있습니다.
  
계층 2 지원에 대해 보다 자세히 알고 있는 독자의 경우 향후 몇 년 동안 참조해도 될 만큼 충분한 읽기 자료가 있습니다.
  
#### 추가 정보
  
-   IPsec에 대한 자세한 내용은 Windows Server 2003 기술 참조 - [How IPsec Works](http://www.microsoft.com/resources/documentation/windowsserv/2003/all/techref/en-us/w2k3tr_ipsec_how.asp)(www.microsoft.com/resources/documentation/WindowsServ/2003/all/techref/en-us/w2k3tr\_IPsec\_how.asp)를 참조하십시오
  
-   TCP/IP 문제 해결에 대한 자세한 내용은 다음 기술 참조를 참조하십시오.
  
    -   [TCP/IP in Windows 2000 Professional](http://www.microsoft.com/resources/documentation/windows/2000/server/reskit/en-us/prork/prcc_tcp_slnb.asp)(www.microsoft.com/resources/documentation/Windows/2000/server/reskit/en-us/prork/prcc\_tcp\_slnb.asp)
  
    -   Windows XP Resource Kit의 [TCP/IP Troubleshooting](http://www.microsoft.com/resources/documentation/windows/xp/all/reskit/en-us/prcc_tcp_gfhp.asp) 장(www.microsoft.com/resources/documentation/Windows/XP/all/reskit/en-us/prcc\_tcp\_gfhp.asp)
  
    -   "[How to troubleshoot TCP/IP connectivity with Windows XP](http://support.microsoft.com/?kbid=314067)"( http://support.microsoft.com/?kbid=314067
  
    -   [Windows Server 2003 TCP/IP Troubleshooting](http://www.microsoft.com/technet/prodtechnol/windowsserver2003/operations/system/tcpiptrb.mspx)(www.microsoft.com/technet/prodtechnol/windowsserver2003/operations/system/tcpiptrb.mspx)
  
-   Windows 2000, Windows XP 및 Windows Server 2003의 IPsec 문제 해결을 명시적으로 논의하고 있는 온라인 도움말 및 리소스 키트 설명서에 대한 자세한 내용은 다음 참조 자료를 읽으십시오.
  
    -   "[Basic IPsec troubleshooting in Microsoft Windows 2000 Server](http://support.microsoft.com/?kbid=257225)"  
        (http://support.microsoft.com/?kbid=257225)
  
    -   [Microsoft Windows 2000 Advanced Documentation](http://www.microsoft.com/windows2000/en/advanced/help/sag_ipsectrouble.htm?id=3352)  
        (www.microsoft.com/windows2000/en/advanced/help/sag\_ipsectrouble.htm?id=3352)
  
    -   "[Basic L2TP/IPSec Troubleshooting in Windows XP](http://support.microsoft.com/?kbid=314831)"(http://support.microsoft.com/?kbid=314831
  
    -   Windows Server 2003 Help – IPsec [Troubleshooting tools](http://www.microsoft.com/technet/security/topics/architectureanddesign/ipsec/ipsecch7.mspx)  
        (www.microsoft.com/technet//prodtechnol/windowsserver2003/proddocs/standard/sag\_ipsec\_tools.asp?frame=true\#iketrace\_enable
  
    -   "[Windows 2000 TCP/IP Implementation Details](http://www.microsoft.com/windows2000/techinfo/howitworks/communications/networkbasics/tcpip_implement.asp)" 의 아키텍처 개요 다이어그램 백서  
        (www.microsoft.com/windows2000/techinfo/howitworks/communications/networkbasics/tcpip\_implement.asp
  
    -   [Windows 2000 Network Architecture](http://www.microsoft.com/resources/documentation/windows/2000/server/reskit/en-us/cnet/cnad_arc_jypf.asp), 그림 B.1  
        (www.microsoft.com/resources/documentation/windows/2000/server/reskit/en-us/cnet/cnad\_arc\_jypf.asp
  
    -   [How TCP/IP Works](http://www.microsoft.com/resources/documentation/windowsserv/2003/all/techref/en-us/w2k3tr_tcpip_how.asp))(www.microsoft.com/resources/documentation/WindowsServ/2003/all/techref/en-us/w2k3tr\_tcpip\_how.asp
  
    -   [How IPSec Works](http://www.microsoft.com/resources/documentation/windowsserv/2003/all/techref/en-us/w2k3tr_ipsec_how.asp))(www.microsoft.com/resources/documentation/WindowsServ/2003/all/techref/en-us/w2k3tr\_ipsec\_how.asp)
  
[](#mainsection)[페이지 위쪽](#mainsection)
  
**전체솔루션다운로드**
  
[IPsec 및 그룹 정책을 통해 서버 및 도메인 격리](http://go.microsoft.com/fwlink/?linkid=33947)
  
[](#mainsection)[페이지 위쪽](#mainsection)